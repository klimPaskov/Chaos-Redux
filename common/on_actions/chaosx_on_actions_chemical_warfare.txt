# Chemical warfare on_actions:
# - Leader-daily tooltip/state-dispersal updates for active cylinder abilities.
# - Livens support combat contamination (daily) + condemnation updates on combat resolution.
# - Chemical tank-shell support contamination + condemnation hooks.
# - Chaos battalion frontline contamination/casualty effects while actively in combat.
# - Ground-combat heat tracking for chemical air-bomb gating.
# - Weekly chemical air-bomb contamination/condemnation processing.
on_actions = {
    on_startup = {
        effect = {
            every_country = {
                if = {
                    limit = {
                        has_tech = basic_gas_masks
                        NOT = { has_tactic = tactic_gas_mask_defense }
                    }
                    unlock_tactic = tactic_gas_mask_defense
                }

                if = {
                    limit = {
                        NOT = { has_tactic = tactic_chemical_shelling }
                        OR = {
                            has_tech = chlorine_gas
                            has_tech = phosgene
                            has_tech = mustard_gas
                            has_tech = lewisite
                            has_tech = sarin
                            has_tech = soman
                        }
                    }
                    unlock_tactic = tactic_chemical_shelling
                }
            }
        }
    }

	on_army_leader_daily = {
		effect = {
			if = {
                limit = {
                    OR = {
                        has_trait = chemical_cylinder_active_chlorine
                        has_trait = chemical_cylinder_active_phosgene
                        has_trait = chemical_cylinder_active_mustard
                        has_trait = chemical_cylinder_active_lewisite
                    }
                }
                FROM = { save_event_target_as = chem_state_dispersal_owner_country }
                chem_apply_state_dispersal = yes
            }

            if = {
                limit = {
                    FROM = {
                        OR = {
                            has_tech = chlorine_gas
                            has_tech = phosgene
                            has_tech = mustard_gas
                            has_tech = lewisite
                        }
                    }
                }
                chem_update_cylinder_previews = yes
            }

            if = {
                limit = { check_variable = { num_units_in_combat > 0 } }
                if = {
                    limit = { chem_owner_has_chemical_weapon_tech = yes }
                    FROM = { save_event_target_as = chem_state_dispersal_owner_country }

                    if = {
                        limit = { chem_leader_has_chemical_tank_support_battalions = yes }
                        chem_tank_shell_apply_state_dispersal = yes
                    }

                    if = {
                        limit = { chem_leader_has_livens_support_battalions = yes }
                        chem_livens_support_apply_state_dispersal = yes
                    }

                    if = {
                        limit = {
                            check_variable = { num_battalions_with_type@chaos_battalion > 0 }
                            FROM = {
                                has_doctrine = chaos_warfare
                                has_country_flag = chaos_battalion_unlocked
                            }
                        }
                        chaos_battalion_apply_state_dispersal = yes
                    }
                }
            }
        }
    }

    on_army_leader_won_combat = {
        effect = {
            if = {
                limit = {
                    check_variable = { num_units_offensive_combats > 0 }
                    OR = {
                        has_trait = chemical_cylinder_active_chlorine
                        has_trait = chemical_cylinder_active_phosgene
                        has_trait = chemical_cylinder_active_mustard
                        has_trait = chemical_cylinder_active_lewisite
                    }
                }
                FROM = { chem_grant_first_use_surprise = yes }
            }

            # Chemical air bombing contamination/condemnation tracking disabled for now.
            # if = {
            # 	limit = { check_variable = { num_units_offensive_combats > 0 } }
            # 	FROM = { chem_air_bomb_register_ground_ops_heat_won = yes }
            # }
            if = {
                limit = { check_variable = { num_units_offensive_combats > 0 } }
                if = {
                    limit = { chem_owner_has_chemical_weapon_tech = yes }
                    if = {
                        limit = { chem_leader_has_livens_support_battalions = yes }
                        chem_livens_support_register_combat_condemnation_won = yes
                    }
                    if = {
                        limit = { chem_leader_has_chemical_tank_support_battalions = yes }
                        chem_tank_shell_register_combat_condemnation_won = yes
                    }
                    if = {
                        limit = {
                            check_variable = { num_battalions_with_type@chaos_battalion > 0 }
                            FROM = {
                                has_doctrine = chaos_warfare
                                has_country_flag = chaos_battalion_unlocked
                            }
                        }
                        chaos_battalion_register_combat_condemnation_won = yes
                    }
                }
            }
        }
    }

    on_army_leader_lost_combat = {
        effect = {
            if = {
                limit = {
                    check_variable = { num_units_offensive_combats > 0 }
                    OR = {
                        has_trait = chemical_cylinder_active_chlorine
                        has_trait = chemical_cylinder_active_phosgene
                        has_trait = chemical_cylinder_active_mustard
                        has_trait = chemical_cylinder_active_lewisite
                    }
                }
                FROM = { chem_grant_first_use_surprise = yes }
            }

            # Chemical air bombing contamination/condemnation tracking disabled for now.
            # if = {
            # 	limit = { check_variable = { num_units_offensive_combats > 0 } }
            # 	FROM = { chem_air_bomb_register_ground_ops_heat_lost = yes }
            # }
            if = {
                limit = { check_variable = { num_units_offensive_combats > 0 } }
                if = {
                    limit = { chem_owner_has_chemical_weapon_tech = yes }
                    if = {
                        limit = { chem_leader_has_livens_support_battalions = yes }
                        chem_livens_support_register_combat_condemnation_lost = yes
                    }
                    if = {
                        limit = { chem_leader_has_chemical_tank_support_battalions = yes }
                        chem_tank_shell_register_combat_condemnation_lost = yes
                    }
                    if = {
                        limit = {
                            check_variable = { num_battalions_with_type@chaos_battalion > 0 }
                            FROM = {
                                has_doctrine = chaos_warfare
                                has_country_flag = chaos_battalion_unlocked
                            }
                        }
                        chaos_battalion_register_combat_condemnation_lost = yes
                    }
                }
            }
        }
    }

    on_weekly = {
        effect = {
            # Chemical air bombing contamination/condemnation processing disabled for now.
            # if = {
            # 	limit = {
            # 		has_war = yes
            # 		OR = {
            # 			has_tech = chlorine_gas
            # 			has_tech = phosgene
            # 			has_tech = mustard_gas
            # 			has_tech = lewisite
            # 		}
            # 	}
            # 	chem_air_bomb_weekly_tick = yes
            # }
        }
    }
}
