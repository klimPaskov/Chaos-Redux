# Chemical tank-shell scripted effects:
# - Reads support-company composition from the active army leader battalions.
# - Only applies contamination/condemnation when chemical supports are guaranteed to be in active combats.
# - Uses the same state contamination modifier path as the ability system.

@CHEM_FIRST_USE_SURPRISE_SUPPORT_MULT = 1.50
@CHEM_TANK_STATE_SUPPORT_COUNT_MAX = 1200

chem_tank_shell_collect_support_counts = {
	set_temp_variable = { var = chem_tank_units_chlorine value = num_battalions_with_type@light_chemical_tank_support_chlorine }
	add_to_temp_variable = { var = chem_tank_units_chlorine value = num_battalions_with_type@medium_chemical_tank_support_chlorine }
	add_to_temp_variable = { var = chem_tank_units_chlorine value = num_battalions_with_type@heavy_chemical_tank_support_chlorine }

	set_temp_variable = { var = chem_tank_units_phosgene value = num_battalions_with_type@light_chemical_tank_support_phosgene }
	add_to_temp_variable = { var = chem_tank_units_phosgene value = num_battalions_with_type@medium_chemical_tank_support_phosgene }
	add_to_temp_variable = { var = chem_tank_units_phosgene value = num_battalions_with_type@heavy_chemical_tank_support_phosgene }

	set_temp_variable = { var = chem_tank_units_mustard value = num_battalions_with_type@light_chemical_tank_support_mustard }
	add_to_temp_variable = { var = chem_tank_units_mustard value = num_battalions_with_type@medium_chemical_tank_support_mustard }
	add_to_temp_variable = { var = chem_tank_units_mustard value = num_battalions_with_type@heavy_chemical_tank_support_mustard }

	set_temp_variable = { var = chem_tank_units_lewisite value = num_battalions_with_type@light_chemical_tank_support_lewisite }
	add_to_temp_variable = { var = chem_tank_units_lewisite value = num_battalions_with_type@medium_chemical_tank_support_lewisite }
	add_to_temp_variable = { var = chem_tank_units_lewisite value = num_battalions_with_type@heavy_chemical_tank_support_lewisite }

	set_temp_variable = { var = chem_tank_units_sarin value = num_battalions_with_type@light_chemical_tank_support_sarin }
	add_to_temp_variable = { var = chem_tank_units_sarin value = num_battalions_with_type@medium_chemical_tank_support_sarin }
	add_to_temp_variable = { var = chem_tank_units_sarin value = num_battalions_with_type@heavy_chemical_tank_support_sarin }

	set_temp_variable = { var = chem_tank_units_soman value = num_battalions_with_type@light_chemical_tank_support_soman }
	add_to_temp_variable = { var = chem_tank_units_soman value = num_battalions_with_type@medium_chemical_tank_support_soman }
	add_to_temp_variable = { var = chem_tank_units_soman value = num_battalions_with_type@heavy_chemical_tank_support_soman }

	set_temp_variable = { var = chem_tank_support_total value = chem_tank_units_chlorine }
	add_to_temp_variable = { var = chem_tank_support_total value = chem_tank_units_phosgene }
	add_to_temp_variable = { var = chem_tank_support_total value = chem_tank_units_mustard }
	add_to_temp_variable = { var = chem_tank_support_total value = chem_tank_units_lewisite }
	add_to_temp_variable = { var = chem_tank_support_total value = chem_tank_units_sarin }
	add_to_temp_variable = { var = chem_tank_support_total value = chem_tank_units_soman }
}

chem_tank_shell_set_profile_from_support_counts = {
	set_temp_variable = { var = chem_tank_profile_dose value = 0 }
	set_temp_variable = { var = chem_tank_profile_duration value = 0 }
	set_temp_variable = { var = chem_tank_profile_condemnation_base value = 0 }
	set_temp_variable = { var = chem_tank_profile_condemnation_per_unit value = 0 }

	if = {
		limit = { check_variable = { var = chem_tank_support_total value = 0 compare = greater_than } }
		set_temp_variable = { var = chem_tank_profile_add value = chem_tank_units_chlorine }
		multiply_temp_variable = { var = chem_tank_profile_add value = constant:chem_tank_shell.dose_per_div.chlorine }
		add_to_temp_variable = { var = chem_tank_profile_dose value = chem_tank_profile_add }
		set_temp_variable = { var = chem_tank_profile_add value = chem_tank_units_chlorine }
		multiply_temp_variable = { var = chem_tank_profile_add value = constant:chem_tank_shell.duration_days.chlorine }
		add_to_temp_variable = { var = chem_tank_profile_duration value = chem_tank_profile_add }
		set_temp_variable = { var = chem_tank_profile_add value = chem_tank_units_chlorine }
		multiply_temp_variable = { var = chem_tank_profile_add value = constant:chem_tank_shell.condemnation_base.chlorine }
		add_to_temp_variable = { var = chem_tank_profile_condemnation_base value = chem_tank_profile_add }
		set_temp_variable = { var = chem_tank_profile_add value = chem_tank_units_chlorine }
		multiply_temp_variable = { var = chem_tank_profile_add value = constant:chem_tank_shell.condemnation_per_unit.chlorine }
		add_to_temp_variable = { var = chem_tank_profile_condemnation_per_unit value = chem_tank_profile_add }

		set_temp_variable = { var = chem_tank_profile_add value = chem_tank_units_phosgene }
		multiply_temp_variable = { var = chem_tank_profile_add value = constant:chem_tank_shell.dose_per_div.phosgene }
		add_to_temp_variable = { var = chem_tank_profile_dose value = chem_tank_profile_add }
		set_temp_variable = { var = chem_tank_profile_add value = chem_tank_units_phosgene }
		multiply_temp_variable = { var = chem_tank_profile_add value = constant:chem_tank_shell.duration_days.phosgene }
		add_to_temp_variable = { var = chem_tank_profile_duration value = chem_tank_profile_add }
		set_temp_variable = { var = chem_tank_profile_add value = chem_tank_units_phosgene }
		multiply_temp_variable = { var = chem_tank_profile_add value = constant:chem_tank_shell.condemnation_base.phosgene }
		add_to_temp_variable = { var = chem_tank_profile_condemnation_base value = chem_tank_profile_add }
		set_temp_variable = { var = chem_tank_profile_add value = chem_tank_units_phosgene }
		multiply_temp_variable = { var = chem_tank_profile_add value = constant:chem_tank_shell.condemnation_per_unit.phosgene }
		add_to_temp_variable = { var = chem_tank_profile_condemnation_per_unit value = chem_tank_profile_add }

		set_temp_variable = { var = chem_tank_profile_add value = chem_tank_units_mustard }
		multiply_temp_variable = { var = chem_tank_profile_add value = constant:chem_tank_shell.dose_per_div.mustard }
		add_to_temp_variable = { var = chem_tank_profile_dose value = chem_tank_profile_add }
		set_temp_variable = { var = chem_tank_profile_add value = chem_tank_units_mustard }
		multiply_temp_variable = { var = chem_tank_profile_add value = constant:chem_tank_shell.duration_days.mustard }
		add_to_temp_variable = { var = chem_tank_profile_duration value = chem_tank_profile_add }
		set_temp_variable = { var = chem_tank_profile_add value = chem_tank_units_mustard }
		multiply_temp_variable = { var = chem_tank_profile_add value = constant:chem_tank_shell.condemnation_base.mustard }
		add_to_temp_variable = { var = chem_tank_profile_condemnation_base value = chem_tank_profile_add }
		set_temp_variable = { var = chem_tank_profile_add value = chem_tank_units_mustard }
		multiply_temp_variable = { var = chem_tank_profile_add value = constant:chem_tank_shell.condemnation_per_unit.mustard }
		add_to_temp_variable = { var = chem_tank_profile_condemnation_per_unit value = chem_tank_profile_add }

		set_temp_variable = { var = chem_tank_profile_add value = chem_tank_units_lewisite }
		multiply_temp_variable = { var = chem_tank_profile_add value = constant:chem_tank_shell.dose_per_div.lewisite }
		add_to_temp_variable = { var = chem_tank_profile_dose value = chem_tank_profile_add }
		set_temp_variable = { var = chem_tank_profile_add value = chem_tank_units_lewisite }
		multiply_temp_variable = { var = chem_tank_profile_add value = constant:chem_tank_shell.duration_days.lewisite }
		add_to_temp_variable = { var = chem_tank_profile_duration value = chem_tank_profile_add }
		set_temp_variable = { var = chem_tank_profile_add value = chem_tank_units_lewisite }
		multiply_temp_variable = { var = chem_tank_profile_add value = constant:chem_tank_shell.condemnation_base.lewisite }
		add_to_temp_variable = { var = chem_tank_profile_condemnation_base value = chem_tank_profile_add }
		set_temp_variable = { var = chem_tank_profile_add value = chem_tank_units_lewisite }
		multiply_temp_variable = { var = chem_tank_profile_add value = constant:chem_tank_shell.condemnation_per_unit.lewisite }
		add_to_temp_variable = { var = chem_tank_profile_condemnation_per_unit value = chem_tank_profile_add }

		set_temp_variable = { var = chem_tank_profile_add value = chem_tank_units_sarin }
		multiply_temp_variable = { var = chem_tank_profile_add value = constant:chem_tank_shell.dose_per_div.sarin }
		add_to_temp_variable = { var = chem_tank_profile_dose value = chem_tank_profile_add }
		set_temp_variable = { var = chem_tank_profile_add value = chem_tank_units_sarin }
		multiply_temp_variable = { var = chem_tank_profile_add value = constant:chem_tank_shell.duration_days.sarin }
		add_to_temp_variable = { var = chem_tank_profile_duration value = chem_tank_profile_add }
		set_temp_variable = { var = chem_tank_profile_add value = chem_tank_units_sarin }
		multiply_temp_variable = { var = chem_tank_profile_add value = constant:chem_tank_shell.condemnation_base.sarin }
		add_to_temp_variable = { var = chem_tank_profile_condemnation_base value = chem_tank_profile_add }
		set_temp_variable = { var = chem_tank_profile_add value = chem_tank_units_sarin }
		multiply_temp_variable = { var = chem_tank_profile_add value = constant:chem_tank_shell.condemnation_per_unit.sarin }
		add_to_temp_variable = { var = chem_tank_profile_condemnation_per_unit value = chem_tank_profile_add }

		set_temp_variable = { var = chem_tank_profile_add value = chem_tank_units_soman }
		multiply_temp_variable = { var = chem_tank_profile_add value = constant:chem_tank_shell.dose_per_div.soman }
		add_to_temp_variable = { var = chem_tank_profile_dose value = chem_tank_profile_add }
		set_temp_variable = { var = chem_tank_profile_add value = chem_tank_units_soman }
		multiply_temp_variable = { var = chem_tank_profile_add value = constant:chem_tank_shell.duration_days.soman }
		add_to_temp_variable = { var = chem_tank_profile_duration value = chem_tank_profile_add }
		set_temp_variable = { var = chem_tank_profile_add value = chem_tank_units_soman }
		multiply_temp_variable = { var = chem_tank_profile_add value = constant:chem_tank_shell.condemnation_base.soman }
		add_to_temp_variable = { var = chem_tank_profile_condemnation_base value = chem_tank_profile_add }
		set_temp_variable = { var = chem_tank_profile_add value = chem_tank_units_soman }
		multiply_temp_variable = { var = chem_tank_profile_add value = constant:chem_tank_shell.condemnation_per_unit.soman }
		add_to_temp_variable = { var = chem_tank_profile_condemnation_per_unit value = chem_tank_profile_add }

		divide_temp_variable = { var = chem_tank_profile_dose value = chem_tank_support_total }
		divide_temp_variable = { var = chem_tank_profile_duration value = chem_tank_support_total }
		divide_temp_variable = { var = chem_tank_profile_condemnation_base value = chem_tank_support_total }
		divide_temp_variable = { var = chem_tank_profile_condemnation_per_unit value = chem_tank_support_total }

		if = {
			limit = { OWNER = { has_idea = chemical_first_use_surprise_idea } }
			multiply_temp_variable = { var = chem_tank_profile_dose value = @CHEM_FIRST_USE_SURPRISE_SUPPORT_MULT }
			multiply_temp_variable = { var = chem_tank_profile_duration value = @CHEM_FIRST_USE_SURPRISE_SUPPORT_MULT }
			multiply_temp_variable = { var = chem_tank_profile_condemnation_base value = @CHEM_FIRST_USE_SURPRISE_SUPPORT_MULT }
			multiply_temp_variable = { var = chem_tank_profile_condemnation_per_unit value = @CHEM_FIRST_USE_SURPRISE_SUPPORT_MULT }
		}

		chem_set_chaos_division_spirit_chemical_modifiers = yes
		multiply_temp_variable = { var = chem_tank_profile_dose value = chem_division_support_profile_mult }
		multiply_temp_variable = { var = chem_tank_profile_duration value = chem_division_support_profile_mult }
		multiply_temp_variable = { var = chem_tank_profile_condemnation_base value = chem_division_support_profile_mult }
		multiply_temp_variable = { var = chem_tank_profile_condemnation_per_unit value = chem_division_support_profile_mult }
	}
}

chem_tank_shell_calculate_guaranteed_support_in_combat = {
	set_temp_variable = { var = chem_tank_total_units value = num_units }
	clamp_temp_variable = { var = chem_tank_total_units min = 0 }
	set_temp_variable = { var = chem_tank_units_in_combat value = num_units_in_combat }
	clamp_temp_variable = { var = chem_tank_units_in_combat min = 0 }

	set_temp_variable = { var = chem_tank_non_support_units value = chem_tank_support_total }
	multiply_temp_variable = { var = chem_tank_non_support_units value = -1 }
	add_to_temp_variable = { var = chem_tank_non_support_units value = chem_tank_total_units }
	clamp_temp_variable = { var = chem_tank_non_support_units min = 0 }

	set_temp_variable = { var = chem_tank_guaranteed_support_combat value = chem_tank_non_support_units }
	multiply_temp_variable = { var = chem_tank_guaranteed_support_combat value = -1 }
	add_to_temp_variable = { var = chem_tank_guaranteed_support_combat value = chem_tank_units_in_combat }
	clamp_temp_variable = { var = chem_tank_guaranteed_support_combat min = 0 }
	if = {
		limit = { check_variable = { var = chem_tank_guaranteed_support_combat value = chem_tank_support_total compare = greater_than } }
		set_temp_variable = { var = chem_tank_guaranteed_support_combat value = chem_tank_support_total }
	}
}

chem_tank_shell_calculate_guaranteed_support_offensive = {
	set_temp_variable = { var = chem_tank_total_units value = num_units }
	clamp_temp_variable = { var = chem_tank_total_units min = 0 }
	set_temp_variable = { var = chem_tank_offensive_units value = num_units_offensive_combats }
	clamp_temp_variable = { var = chem_tank_offensive_units min = 0 }

	set_temp_variable = { var = chem_tank_non_support_units value = chem_tank_support_total }
	multiply_temp_variable = { var = chem_tank_non_support_units value = -1 }
	add_to_temp_variable = { var = chem_tank_non_support_units value = chem_tank_total_units }
	clamp_temp_variable = { var = chem_tank_non_support_units min = 0 }

	set_temp_variable = { var = chem_tank_guaranteed_support_offensive value = chem_tank_non_support_units }
	multiply_temp_variable = { var = chem_tank_guaranteed_support_offensive value = -1 }
	add_to_temp_variable = { var = chem_tank_guaranteed_support_offensive value = chem_tank_offensive_units }
	clamp_temp_variable = { var = chem_tank_guaranteed_support_offensive min = 0 }
	if = {
		limit = { check_variable = { var = chem_tank_guaranteed_support_offensive value = chem_tank_support_total compare = greater_than } }
		set_temp_variable = { var = chem_tank_guaranteed_support_offensive value = chem_tank_support_total }
	}
}

chem_tank_shell_apply_weather_duration_mult = {
	set_temp_variable = { var = chem_tank_duration_mult value = constant:chem_tank_shell.weather_mult.temperate }
	set_temp_variable = { var = chem_tank_total_units value = num_units_in_combat }
	clamp_temp_variable = { var = chem_tank_total_units min = 1 }
	set_temp_variable = { var = chem_tank_cold_units value = num_units_on_climate@cold_climate }
	set_temp_variable = { var = chem_tank_hot_units value = num_units_on_climate@hot_climate }
	set_temp_variable = { var = chem_tank_cold_ratio value = chem_tank_cold_units }
	divide_temp_variable = { var = chem_tank_cold_ratio value = chem_tank_total_units }
	clamp_temp_variable = { var = chem_tank_cold_ratio min = 0 max = 1 }
	set_temp_variable = { var = chem_tank_hot_ratio value = chem_tank_hot_units }
	divide_temp_variable = { var = chem_tank_hot_ratio value = chem_tank_total_units }
	clamp_temp_variable = { var = chem_tank_hot_ratio min = 0 max = 1 }

	set_temp_variable = { var = chem_tank_duration_add value = constant:chem_tank_shell.weather_mult.cold }
	add_to_temp_variable = { var = chem_tank_duration_add value = -1 }
	multiply_temp_variable = { var = chem_tank_duration_add value = chem_tank_cold_ratio }
	add_to_temp_variable = { var = chem_tank_duration_mult value = chem_tank_duration_add }
	set_temp_variable = { var = chem_tank_duration_add value = constant:chem_tank_shell.weather_mult.hot }
	add_to_temp_variable = { var = chem_tank_duration_add value = -1 }
	multiply_temp_variable = { var = chem_tank_duration_add value = chem_tank_hot_ratio }
	add_to_temp_variable = { var = chem_tank_duration_mult value = chem_tank_duration_add }

	clamp_temp_variable = {
		var = chem_tank_duration_mult
		min = constant:chem_tank_shell.duration_mult_bounds.min
		max = constant:chem_tank_shell.duration_mult_bounds.max
	}
}

chem_tank_shell_apply_state_dispersal = {
	save_event_target_as = chem_state_dispersal_leader
	if = {
		limit = { NOT = { has_event_target = chem_state_dispersal_owner_country } }
		OWNER = { save_event_target_as = chem_state_dispersal_owner_country }
	}

	chem_tank_shell_collect_support_counts = yes
	chem_tank_shell_calculate_guaranteed_support_in_combat = yes
	if = {
		limit = { check_variable = { var = chem_tank_guaranteed_support_combat value = 0 compare = greater_than } }
		OWNER = { chem_grant_first_use_surprise = yes }
	}
	chem_tank_shell_set_profile_from_support_counts = yes
	chem_set_contaminant_firebases_contamination_mult_from_owner_target = yes
	chem_tank_shell_apply_weather_duration_mult = yes

	if = {
		limit = {
			check_variable = { var = chem_tank_guaranteed_support_combat value = constant:chem_tank_shell.combat_scale.min_units_in_combat compare = greater_than_or_equals }
			check_variable = { var = chem_tank_profile_duration value = 0 compare = greater_than }
		}
		set_temp_variable = { var = chem_tank_support_combat_ratio value = chem_tank_guaranteed_support_combat }
		divide_temp_variable = { var = chem_tank_support_combat_ratio value = chem_tank_support_total }
		clamp_temp_variable = { var = chem_tank_support_combat_ratio min = 0 max = 1 }

		set_temp_variable = { var = chem_state_dose_per_div value = chem_tank_profile_dose }
		multiply_temp_variable = { var = chem_state_dose_per_div value = constant:chem_tank_shell.combat_scale.dose_mult }
		multiply_temp_variable = { var = chem_state_dose_per_div value = chem_tank_support_combat_ratio }
		multiply_temp_variable = { var = chem_state_dose_per_div value = chem_contamination_strength_mult }

		set_temp_variable = { var = chem_state_duration_add value = chem_tank_profile_duration }
		multiply_temp_variable = { var = chem_state_duration_add value = chem_tank_duration_mult }
		multiply_temp_variable = { var = chem_state_duration_add value = constant:chem_tank_shell.combat_scale.duration_mult }
		multiply_temp_variable = { var = chem_state_duration_add value = chem_contamination_duration_mult }
		round_temp_variable = chem_state_duration_add
		clamp_temp_variable = {
			var = chem_state_duration_add
			min = 1
			max = constant:chem_tank_shell.combat_scale.max_duration_days
		}

		event_target:chem_state_dispersal_owner_country = {
			set_temp_variable = { var = chem_state_scan_states_with_units value = 0 }
			set_temp_variable = { var = chem_state_scan_states_applied value = 0 }
			chem_tank_shell_apply_state_dispersal_from_controlled_states = yes
			every_allied_country = {
				set_temp_variable = { var = chem_state_scan_states_with_units value = 0 }
				set_temp_variable = { var = chem_state_scan_states_applied value = 0 }
				chem_tank_shell_apply_state_dispersal_from_controlled_states = yes
			}
		}
	}
}

chem_tank_shell_set_owner_support_count_in_state = {
	set_temp_variable = { var = chem_tank_state_count_low value = 0 }
	set_temp_variable = { var = chem_tank_state_count_high value = @CHEM_TANK_STATE_SUPPORT_COUNT_MAX }
	add_to_temp_variable = { var = chem_tank_state_count_high value = 1 }

	set_temp_variable = { var = chem_tank_state_count_gap value = chem_tank_state_count_high }
	set_temp_variable = { var = chem_tank_state_count_gap_sub value = chem_tank_state_count_low }
	multiply_temp_variable = { var = chem_tank_state_count_gap_sub value = -1 }
	add_to_temp_variable = { var = chem_tank_state_count_gap value = chem_tank_state_count_gap_sub }

	while_loop_effect = {
		limit = { check_variable = { var = chem_tank_state_count_gap value = 1 compare = greater_than } }

		set_temp_variable = { var = chem_tank_state_count_mid value = chem_tank_state_count_low }
		add_to_temp_variable = { var = chem_tank_state_count_mid value = chem_tank_state_count_high }
		divide_temp_variable = { var = chem_tank_state_count_mid value = 2 }
		round_temp_variable = chem_tank_state_count_mid

		set_temp_variable = { var = chem_tank_state_count_probe_minus_one value = chem_tank_state_count_mid }
		add_to_temp_variable = { var = chem_tank_state_count_probe_minus_one value = -1 }

		if = {
			limit = {
				event_target:chem_state_dispersal_owner_country = {
					meta_trigger = {
						text = {
							num_battalions_in_states = {
								count > [CHEM_TANK_COUNT_PROBE]
								states = { [CHEM_STATE_ID] }
								types = {
									light_chemical_tank_support_chlorine
									medium_chemical_tank_support_chlorine
									heavy_chemical_tank_support_chlorine
									light_chemical_tank_support_phosgene
									medium_chemical_tank_support_phosgene
									heavy_chemical_tank_support_phosgene
									light_chemical_tank_support_mustard
									medium_chemical_tank_support_mustard
									heavy_chemical_tank_support_mustard
									light_chemical_tank_support_lewisite
									medium_chemical_tank_support_lewisite
									heavy_chemical_tank_support_lewisite
									light_chemical_tank_support_sarin
									medium_chemical_tank_support_sarin
									heavy_chemical_tank_support_sarin
									light_chemical_tank_support_soman
									medium_chemical_tank_support_soman
									heavy_chemical_tank_support_soman
								}
							}
						}
						CHEM_TANK_COUNT_PROBE = "[?chem_tank_state_count_probe_minus_one|0]"
						CHEM_STATE_ID = "[?chem_state_id|0]"
					}
				}
			}
			set_temp_variable = { var = chem_tank_state_count_low value = chem_tank_state_count_mid }
		}
		else = {
			set_temp_variable = { var = chem_tank_state_count_high value = chem_tank_state_count_mid }
		}

		set_temp_variable = { var = chem_tank_state_count_gap value = chem_tank_state_count_high }
		set_temp_variable = { var = chem_tank_state_count_gap_sub value = chem_tank_state_count_low }
		multiply_temp_variable = { var = chem_tank_state_count_gap_sub value = -1 }
		add_to_temp_variable = { var = chem_tank_state_count_gap value = chem_tank_state_count_gap_sub }
	}

	set_temp_variable = { var = chem_tank_support_in_enemy_state value = chem_tank_state_count_low }
}

chem_tank_shell_apply_state_dispersal_from_controlled_states = {
	every_controlled_state = {
		every_neighbor_state = {
			limit = {
				CONTROLLER = { has_war_with = event_target:chem_state_dispersal_owner_country }
				NOT = { is_controlled_by = event_target:chem_state_dispersal_owner_country }
			}

			meta_effect = {
				text = {
					set_temp_variable = { var = chem_state_id value = [CHEM_STATE_ID] }
				}
				CHEM_STATE_ID = "[THIS.GetID]"
			}
			chem_tank_shell_set_owner_support_count_in_state = yes

			if = {
				limit = { check_variable = { var = chem_tank_support_in_enemy_state value = 0 compare = greater_than } }
				add_to_temp_variable = { var = chem_state_scan_states_with_units value = 1 }
				set_temp_variable = { var = chem_dose_each value = chem_tank_support_in_enemy_state }
				multiply_temp_variable = { var = chem_dose_each value = chem_state_dose_per_div }
				add_to_temp_variable = { var = chem_state_scan_states_applied value = 1 }
				chem_apply_state_contamination = yes
			}
		}
	}
}

chem_tank_shell_register_combat_condemnation_won = {
	chem_tank_shell_collect_support_counts = yes
	chem_tank_shell_calculate_guaranteed_support_offensive = yes

	if = {
		limit = { check_variable = { var = chem_tank_guaranteed_support_offensive value = 0 compare = greater_than } }
		OWNER = { chem_grant_first_use_surprise = yes }
		chem_tank_shell_set_profile_from_support_counts = yes
		set_temp_variable = { var = chem_tank_support_offensive_ratio value = chem_tank_guaranteed_support_offensive }
		divide_temp_variable = { var = chem_tank_support_offensive_ratio value = chem_tank_offensive_units }
		clamp_temp_variable = { var = chem_tank_support_offensive_ratio min = 0 max = 1 }

		set_temp_variable = { var = chem_condemnation_base value = chem_tank_profile_condemnation_base }
		multiply_temp_variable = { var = chem_condemnation_base value = constant:chem_tank_shell.condemnation.won_base_mult }
		multiply_temp_variable = { var = chem_condemnation_base value = chem_tank_support_offensive_ratio }
		set_temp_variable = { var = chem_condemnation_per_unit value = chem_tank_profile_condemnation_per_unit }
		multiply_temp_variable = { var = chem_condemnation_per_unit value = constant:chem_tank_shell.condemnation.won_per_unit_mult }
		set_temp_variable = { var = chem_consumed_amount value = chem_tank_guaranteed_support_offensive }
		multiply_temp_variable = { var = chem_consumed_amount value = constant:chem_tank_shell.condemnation.consumed_per_combat_unit }
		clamp_temp_variable = {
			var = chem_consumed_amount
			min = constant:chem_tank_shell.condemnation.min_consumed
			max = constant:chem_tank_shell.condemnation.max_consumed
		}
		set_temp_variable = { var = chem_required_amount value = 0 }

		OWNER = { chem_warfare_register_attack_use_no_livens = yes }
	}
}

chem_tank_shell_register_combat_condemnation_lost = {
	chem_tank_shell_collect_support_counts = yes
	chem_tank_shell_calculate_guaranteed_support_offensive = yes

	if = {
		limit = { check_variable = { var = chem_tank_guaranteed_support_offensive value = 0 compare = greater_than } }
		OWNER = { chem_grant_first_use_surprise = yes }
		chem_tank_shell_set_profile_from_support_counts = yes
		set_temp_variable = { var = chem_tank_support_offensive_ratio value = chem_tank_guaranteed_support_offensive }
		divide_temp_variable = { var = chem_tank_support_offensive_ratio value = chem_tank_offensive_units }
		clamp_temp_variable = { var = chem_tank_support_offensive_ratio min = 0 max = 1 }

		set_temp_variable = { var = chem_condemnation_base value = chem_tank_profile_condemnation_base }
		multiply_temp_variable = { var = chem_condemnation_base value = constant:chem_tank_shell.condemnation.lost_base_mult }
		multiply_temp_variable = { var = chem_condemnation_base value = chem_tank_support_offensive_ratio }
		set_temp_variable = { var = chem_condemnation_per_unit value = chem_tank_profile_condemnation_per_unit }
		multiply_temp_variable = { var = chem_condemnation_per_unit value = constant:chem_tank_shell.condemnation.lost_per_unit_mult }
		set_temp_variable = { var = chem_consumed_amount value = chem_tank_guaranteed_support_offensive }
		multiply_temp_variable = { var = chem_consumed_amount value = constant:chem_tank_shell.condemnation.consumed_per_combat_unit }
		clamp_temp_variable = {
			var = chem_consumed_amount
			min = constant:chem_tank_shell.condemnation.min_consumed
			max = constant:chem_tank_shell.condemnation.max_consumed
		}
		set_temp_variable = { var = chem_required_amount value = 0 }

		OWNER = { chem_warfare_register_attack_use_no_livens = yes }
	}
}
