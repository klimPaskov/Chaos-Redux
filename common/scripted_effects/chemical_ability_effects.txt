# Chemical ability weather, terrain, and gas mask adjustments.
# Keep in sync with @CHEM_DURATION_DAYS in common/abilities/chemical_abilities.txt.
@CHEM_ABILITY_DURATION_DAYS = 7

@CHEM_WEATHER_BLIZZARD_OFFENSE = -0.005
@CHEM_WEATHER_BLIZZARD_BREAKTHROUGH = -0.005
@CHEM_WEATHER_BLIZZARD_ORG_DAMAGE = 0.008

@CHEM_WEATHER_SANDSTORM_OFFENSE = -0.005
@CHEM_WEATHER_SANDSTORM_STR_DAMAGE = 0.01
@CHEM_WEATHER_SANDSTORM_ORG_DAMAGE = 0.008

@CHEM_WEATHER_EXTREME_THRESHOLD = 0.6
@CHEM_WEATHER_EXTREME_COLD_OFFENSE = -0.005
@CHEM_WEATHER_EXTREME_COLD_BREAKTHROUGH = -0.005
@CHEM_WEATHER_EXTREME_COLD_ORG_DAMAGE = 0.01
@CHEM_WEATHER_EXTREME_HEAT_OFFENSE = -0.005
@CHEM_WEATHER_EXTREME_HEAT_STR_DAMAGE = 0.01
@CHEM_WEATHER_EXTREME_HEAT_ORG_DAMAGE = 0.008

# Wind forecast and miscalculation handling for chemical abilities.
@CHEM_WIND_STATE_FAVOR = 1
@CHEM_WIND_STATE_NEUTRAL = 0
@CHEM_WIND_STATE_AGAINST = -1
@CHEM_WIND_STATE_STRONG_FAVOR = 2

@CHEM_WIND_CHANCE_SCALE = 100
@CHEM_WIND_SEVERE_THRESHOLD = 0.35
@CHEM_WIND_FAVOR_BASE = 8
@CHEM_WIND_FAVOR_CLEAR_BONUS = 6
@CHEM_WIND_FAVOR_OPEN_BONUS = 6
@CHEM_WIND_FAVOR_ROUGH_PENALTY = -6
@CHEM_WIND_FAVOR_SEVERE_PENALTY = -7
@CHEM_WIND_FAVOR_EXTREME_PENALTY = -5
@CHEM_WIND_FAVOR_URBAN_PENALTY = -4
@CHEM_WIND_FAVOR_HIGHLAND_PENALTY = -3
@CHEM_WIND_AGAINST_BASE = 8
@CHEM_WIND_AGAINST_CLEAR_PENALTY = -5
@CHEM_WIND_AGAINST_SEVERE_BONUS = 24
@CHEM_WIND_AGAINST_EXTREME_BONUS = 12
@CHEM_WIND_AGAINST_EXTREME_BONUS_EXTRA = 8
@CHEM_WIND_AGAINST_ROUGH_BONUS = 8
@CHEM_WIND_AGAINST_URBAN_BONUS = 6
@CHEM_WIND_AGAINST_HIGHLAND_BONUS = 5

@CHEM_WIND_FAVOR_TECH_VANES = 12
@CHEM_WIND_FAVOR_TECH_STATIONS = 20
@CHEM_WIND_FAVOR_TECH_SOUNDINGS = 28
@CHEM_WIND_STRONG_FAVOR_TECH_STATIONS = 10
@CHEM_WIND_STRONG_FAVOR_TECH_SOUNDINGS = 18
@CHEM_WIND_AGAINST_TECH_VANES = -4
@CHEM_WIND_AGAINST_TECH_STATIONS = -8
@CHEM_WIND_AGAINST_TECH_SOUNDINGS = -12

@CHEM_WIND_POSITIVE_FAVOR_MULT = 1.30
@CHEM_WIND_NEGATIVE_FAVOR_MULT = 0.70
@CHEM_WIND_POSITIVE_STRONG_FAVOR_MULT = 1.60
@CHEM_WIND_NEGATIVE_STRONG_FAVOR_MULT = 0.50
@CHEM_WIND_POSITIVE_NEUTRAL_MULT = 1.0
@CHEM_WIND_NEGATIVE_NEUTRAL_MULT = 1.0
@CHEM_WIND_POSITIVE_AGAINST_MULT = 0.70
@CHEM_WIND_NEGATIVE_AGAINST_MULT = 1.25

@CHEM_WIND_MISCALC_BASE = 0.15
@CHEM_WIND_MISCALC_VANES = 0.10
@CHEM_WIND_MISCALC_STATIONS = 0.05
@CHEM_WIND_MISCALC_SOUNDINGS = 0.02

@CHEM_WIND_FORECAST_DAYS = 7

# State-level dispersal parameters.
@CHEM_STATE_STRENGTH_SCALE = 4
@CHEM_STATE_DURATION_SCALE = 4

@CHEM_STATE_MAX_STRENGTH_BASE = -0.20
@CHEM_STATE_MAX_DURATION_DAYS_BASE = 21

@CHEM_STATE_CHLORINE_DOSE_PER_DIV = -0.0004
@CHEM_STATE_CHLORINE_DURATION_ADD = 1
@CHEM_STATE_PHOSGENE_DOSE_PER_DIV = -0.0006
@CHEM_STATE_PHOSGENE_DURATION_ADD = 1
@CHEM_STATE_MUSTARD_DOSE_PER_DIV = -0.00025
@CHEM_STATE_MUSTARD_DURATION_ADD = 3
@CHEM_STATE_LEWISITE_DOSE_PER_DIV = -0.0003
@CHEM_STATE_LEWISITE_DURATION_ADD = 4

@CHEM_STATE_SUPPLY_MULT = 1.0
@CHEM_STATE_SUPPLY_IMPACT_MULT = -1.25
@CHEM_STATE_SPEED_MULT = 0.5
@CHEM_STATE_TRUCK_ATTRITION_MULT = -0.4
@CHEM_STATE_ATTACK_MULT = 0.4
@CHEM_STATE_BREAKTHROUGH_MULT = 0.5

# Stockpile "doomsday release" decision parameters.
@CHEM_DOOM_ACUTE_WEIGHT_CHLORINE = 1.0
@CHEM_DOOM_ACUTE_WEIGHT_PHOSGENE = 1.6
@CHEM_DOOM_ACUTE_WEIGHT_MUSTARD = 0.9
@CHEM_DOOM_ACUTE_WEIGHT_LEWISITE = 1.1

@CHEM_DOOM_PERSIST_WEIGHT_CHLORINE = 0.2
@CHEM_DOOM_PERSIST_WEIGHT_PHOSGENE = 0.3
@CHEM_DOOM_PERSIST_WEIGHT_MUSTARD = 1.5
@CHEM_DOOM_PERSIST_WEIGHT_LEWISITE = 1.7

@CHEM_DOOM_ACUTE_ORG_SCALE = 200000
@CHEM_DOOM_ACUTE_STR_SCALE = 420000
@CHEM_DOOM_ORG_DAMAGE_MAX = 0.45
@CHEM_DOOM_STR_DAMAGE_MAX = 0.22

@CHEM_DOOM_STATE_DOSE_SCALE = 500000
@CHEM_DOOM_STATE_DOSE_MAX = 0.80
@CHEM_DOOM_STATE_DURATION_SCALE = 2000
@CHEM_DOOM_STATE_DURATION_ADD_MAX = 140

@CHEM_DOOM_STATE_MAX_DURATION_DAYS_BASE = 60
@CHEM_DOOM_STATE_MAX_DURATION_SCALE = 4

@CHEM_TYPE_CHLORINE = 1
@CHEM_TYPE_PHOSGENE = 2
@CHEM_TYPE_MUSTARD = 3
@CHEM_TYPE_LEWISITE = 4

# Unit modifier extras (keep in sync with common/abilities/chemical_abilities.txt).
@CHEM_UNIT_SPEED_FACTOR = -0.05
@CHEM_UNIT_URBAN_ATTACK = 0.10

# Keep cylinder-per-battalion values in sync with common/abilities/chemical_abilities.txt.
@CHEM_PREVIEW_CHLORINE_CYLINDERS_PER_BATTALION = 30
@CHEM_PREVIEW_PHOSGENE_CYLINDERS_PER_BATTALION = 30
@CHEM_PREVIEW_MUSTARD_CYLINDERS_PER_BATTALION = 30
@CHEM_PREVIEW_LEWISITE_CYLINDERS_PER_BATTALION = 30
@CHEM_PREVIEW_DURATION_DAYS = 7
@CHEM_PREVIEW_RATIO_MIN = 0.10

@CHEM_PREVIEW_CHLORINE_OFFENSE = 0.24
@CHEM_PREVIEW_CHLORINE_BREAKTHROUGH = 0.24
@CHEM_PREVIEW_CHLORINE_DEFENSE = 0.06
@CHEM_PREVIEW_CHLORINE_ORG_DAMAGE = 0.18
@CHEM_PREVIEW_CHLORINE_STR_DAMAGE = 0.08
@CHEM_PREVIEW_CHLORINE_WAR_SUPPORT = 0.14

@CHEM_PREVIEW_PHOSGENE_OFFENSE = 0.36
@CHEM_PREVIEW_PHOSGENE_BREAKTHROUGH = 0.36
@CHEM_PREVIEW_PHOSGENE_DEFENSE = 0.10
@CHEM_PREVIEW_PHOSGENE_ORG_DAMAGE = 0.28
@CHEM_PREVIEW_PHOSGENE_STR_DAMAGE = 0.14
@CHEM_PREVIEW_PHOSGENE_WAR_SUPPORT = 0.20

@CHEM_PREVIEW_MUSTARD_OFFENSE = 0.28
@CHEM_PREVIEW_MUSTARD_BREAKTHROUGH = 0.20
@CHEM_PREVIEW_MUSTARD_DEFENSE = 0.06
@CHEM_PREVIEW_MUSTARD_ORG_DAMAGE = 0.24
@CHEM_PREVIEW_MUSTARD_STR_DAMAGE = 0.12
@CHEM_PREVIEW_MUSTARD_WAR_SUPPORT = 0.16

@CHEM_PREVIEW_LEWISITE_OFFENSE = 0.48
@CHEM_PREVIEW_LEWISITE_BREAKTHROUGH = 0.48
@CHEM_PREVIEW_LEWISITE_DEFENSE = 0.12
@CHEM_PREVIEW_LEWISITE_ORG_DAMAGE = 0.36
@CHEM_PREVIEW_LEWISITE_STR_DAMAGE = 0.18
@CHEM_PREVIEW_LEWISITE_WAR_SUPPORT = 0.24

chem_roll_wind_state = {
    set_temp_variable = { var = chem_wind_total_units value = num_units }
    set_temp_variable = { var = chem_wind_total_combat_units value = num_units_in_combat }
    if = {
        limit = { check_variable = { var = chem_wind_total_combat_units value = 0 compare = greater_than } }
        set_temp_variable = { var = chem_wind_total_units value = chem_wind_total_combat_units }
    }
    clamp_temp_variable = { var = chem_wind_total_units min = 1 }

    set_temp_variable = { var = chem_wind_cold_units value = num_units_on_climate@cold_climate }
    set_temp_variable = { var = chem_wind_hot_units value = num_units_on_climate@hot_climate }
    set_temp_variable = { var = chem_wind_severity value = chem_wind_cold_units }
    add_to_temp_variable = { var = chem_wind_severity value = chem_wind_hot_units }
    divide_temp_variable = { var = chem_wind_severity value = chem_wind_total_units }
    clamp_temp_variable = { var = chem_wind_severity min = 0 max = 1 }

    set_temp_variable = { var = chem_wind_clear value = chem_wind_severity }
    multiply_temp_variable = { var = chem_wind_clear value = -1 }
    add_to_temp_variable = { var = chem_wind_clear value = 1 }
    clamp_temp_variable = { var = chem_wind_clear min = 0 max = 1 }

    set_temp_variable = { var = chem_wind_open_units value = 0 }
    set_temp_variable = { var = chem_wind_terrain_units_off value = num_units_offensive_combats_against@plains }
    add_to_temp_variable = { var = chem_wind_open_units value = chem_wind_terrain_units_off }
    set_temp_variable = { var = chem_wind_terrain_units_def value = num_units_defensive_combats_on@plains }
    add_to_temp_variable = { var = chem_wind_open_units value = chem_wind_terrain_units_def }
    set_temp_variable = { var = chem_wind_terrain_units_off value = num_units_offensive_combats_against@desert }
    add_to_temp_variable = { var = chem_wind_open_units value = chem_wind_terrain_units_off }
    set_temp_variable = { var = chem_wind_terrain_units_def value = num_units_defensive_combats_on@desert }
    add_to_temp_variable = { var = chem_wind_open_units value = chem_wind_terrain_units_def }
    set_temp_variable = { var = chem_wind_open_ratio value = 0 }
    if = {
        limit = { check_variable = { var = chem_wind_open_units value = 0 compare = greater_than } }
        set_temp_variable = { var = chem_wind_open_ratio value = chem_wind_open_units }
        divide_temp_variable = { var = chem_wind_open_ratio value = chem_wind_total_units }
        clamp_temp_variable = { var = chem_wind_open_ratio min = 0 max = 1 }
    }

    set_temp_variable = { var = chem_wind_rough_units value = 0 }
    set_temp_variable = { var = chem_wind_terrain_units_off value = num_units_offensive_combats_against@forest }
    add_to_temp_variable = { var = chem_wind_rough_units value = chem_wind_terrain_units_off }
    set_temp_variable = { var = chem_wind_terrain_units_def value = num_units_defensive_combats_on@forest }
    add_to_temp_variable = { var = chem_wind_rough_units value = chem_wind_terrain_units_def }
    set_temp_variable = { var = chem_wind_terrain_units_off value = num_units_offensive_combats_against@jungle }
    add_to_temp_variable = { var = chem_wind_rough_units value = chem_wind_terrain_units_off }
    set_temp_variable = { var = chem_wind_terrain_units_def value = num_units_defensive_combats_on@jungle }
    add_to_temp_variable = { var = chem_wind_rough_units value = chem_wind_terrain_units_def }
    set_temp_variable = { var = chem_wind_terrain_units_off value = num_units_offensive_combats_against@hills }
    add_to_temp_variable = { var = chem_wind_rough_units value = chem_wind_terrain_units_off }
    set_temp_variable = { var = chem_wind_terrain_units_def value = num_units_defensive_combats_on@hills }
    add_to_temp_variable = { var = chem_wind_rough_units value = chem_wind_terrain_units_def }
    set_temp_variable = { var = chem_wind_terrain_units_off value = num_units_offensive_combats_against@mountain }
    add_to_temp_variable = { var = chem_wind_rough_units value = chem_wind_terrain_units_off }
    set_temp_variable = { var = chem_wind_terrain_units_def value = num_units_defensive_combats_on@mountain }
    add_to_temp_variable = { var = chem_wind_rough_units value = chem_wind_terrain_units_def }
    set_temp_variable = { var = chem_wind_terrain_units_off value = num_units_offensive_combats_against@urban }
    add_to_temp_variable = { var = chem_wind_rough_units value = chem_wind_terrain_units_off }
    set_temp_variable = { var = chem_wind_terrain_units_def value = num_units_defensive_combats_on@urban }
    add_to_temp_variable = { var = chem_wind_rough_units value = chem_wind_terrain_units_def }
    set_temp_variable = { var = chem_wind_terrain_units_off value = num_units_offensive_combats_against@marsh }
    add_to_temp_variable = { var = chem_wind_rough_units value = chem_wind_terrain_units_off }
    set_temp_variable = { var = chem_wind_terrain_units_def value = num_units_defensive_combats_on@marsh }
    add_to_temp_variable = { var = chem_wind_rough_units value = chem_wind_terrain_units_def }
    set_temp_variable = { var = chem_wind_rough_ratio value = 0 }
    if = {
        limit = { check_variable = { var = chem_wind_rough_units value = 0 compare = greater_than } }
        set_temp_variable = { var = chem_wind_rough_ratio value = chem_wind_rough_units }
        divide_temp_variable = { var = chem_wind_rough_ratio value = chem_wind_total_units }
        clamp_temp_variable = { var = chem_wind_rough_ratio min = 0 max = 1 }
    }

    set_temp_variable = { var = chem_wind_urban_units value = 0 }
    set_temp_variable = { var = chem_wind_terrain_units_off value = num_units_offensive_combats_against@urban }
    add_to_temp_variable = { var = chem_wind_urban_units value = chem_wind_terrain_units_off }
    set_temp_variable = { var = chem_wind_terrain_units_def value = num_units_defensive_combats_on@urban }
    add_to_temp_variable = { var = chem_wind_urban_units value = chem_wind_terrain_units_def }
    set_temp_variable = { var = chem_wind_urban_ratio value = 0 }
    if = {
        limit = { check_variable = { var = chem_wind_urban_units value = 0 compare = greater_than } }
        set_temp_variable = { var = chem_wind_urban_ratio value = chem_wind_urban_units }
        divide_temp_variable = { var = chem_wind_urban_ratio value = chem_wind_total_units }
        clamp_temp_variable = { var = chem_wind_urban_ratio min = 0 max = 1 }
    }

    set_temp_variable = { var = chem_wind_highland_units value = 0 }
    set_temp_variable = { var = chem_wind_terrain_units_off value = num_units_offensive_combats_against@hills }
    add_to_temp_variable = { var = chem_wind_highland_units value = chem_wind_terrain_units_off }
    set_temp_variable = { var = chem_wind_terrain_units_def value = num_units_defensive_combats_on@hills }
    add_to_temp_variable = { var = chem_wind_highland_units value = chem_wind_terrain_units_def }
    set_temp_variable = { var = chem_wind_terrain_units_off value = num_units_offensive_combats_against@mountain }
    add_to_temp_variable = { var = chem_wind_highland_units value = chem_wind_terrain_units_off }
    set_temp_variable = { var = chem_wind_terrain_units_def value = num_units_defensive_combats_on@mountain }
    add_to_temp_variable = { var = chem_wind_highland_units value = chem_wind_terrain_units_def }
    set_temp_variable = { var = chem_wind_highland_ratio value = 0 }
    if = {
        limit = { check_variable = { var = chem_wind_highland_units value = 0 compare = greater_than } }
        set_temp_variable = { var = chem_wind_highland_ratio value = chem_wind_highland_units }
        divide_temp_variable = { var = chem_wind_highland_ratio value = chem_wind_total_units }
        clamp_temp_variable = { var = chem_wind_highland_ratio min = 0 max = 1 }
    }

    set_temp_variable = { var = chem_wind_severity_squared value = chem_wind_severity }
    multiply_temp_variable = { var = chem_wind_severity_squared value = chem_wind_severity }
    set_temp_variable = { var = chem_wind_extreme_ratio value = chem_wind_severity }
    set_temp_variable = { var = chem_wind_severe_threshold value = @CHEM_WIND_SEVERE_THRESHOLD }
    multiply_temp_variable = { var = chem_wind_severe_threshold value = -1 }
    add_to_temp_variable = { var = chem_wind_extreme_ratio value = chem_wind_severe_threshold }
    clamp_temp_variable = { var = chem_wind_extreme_ratio min = 0 max = 1 }

    set_temp_variable = { var = chem_wind_favor_chance value = @CHEM_WIND_FAVOR_BASE }
    set_temp_variable = { var = chem_wind_favor_add value = @CHEM_WIND_FAVOR_CLEAR_BONUS }
    multiply_temp_variable = { var = chem_wind_favor_add value = chem_wind_clear }
    add_to_temp_variable = { var = chem_wind_favor_chance value = chem_wind_favor_add }
    set_temp_variable = { var = chem_wind_favor_add value = @CHEM_WIND_FAVOR_OPEN_BONUS }
    multiply_temp_variable = { var = chem_wind_favor_add value = chem_wind_open_ratio }
    add_to_temp_variable = { var = chem_wind_favor_chance value = chem_wind_favor_add }
    set_temp_variable = { var = chem_wind_favor_add value = @CHEM_WIND_FAVOR_ROUGH_PENALTY }
    multiply_temp_variable = { var = chem_wind_favor_add value = chem_wind_rough_ratio }
    add_to_temp_variable = { var = chem_wind_favor_chance value = chem_wind_favor_add }
    set_temp_variable = { var = chem_wind_favor_add value = @CHEM_WIND_FAVOR_SEVERE_PENALTY }
    multiply_temp_variable = { var = chem_wind_favor_add value = chem_wind_severity }
    add_to_temp_variable = { var = chem_wind_favor_chance value = chem_wind_favor_add }
    set_temp_variable = { var = chem_wind_favor_add value = @CHEM_WIND_FAVOR_EXTREME_PENALTY }
    multiply_temp_variable = { var = chem_wind_favor_add value = chem_wind_extreme_ratio }
    add_to_temp_variable = { var = chem_wind_favor_chance value = chem_wind_favor_add }
    set_temp_variable = { var = chem_wind_favor_add value = @CHEM_WIND_FAVOR_URBAN_PENALTY }
    multiply_temp_variable = { var = chem_wind_favor_add value = chem_wind_urban_ratio }
    add_to_temp_variable = { var = chem_wind_favor_chance value = chem_wind_favor_add }
    set_temp_variable = { var = chem_wind_favor_add value = @CHEM_WIND_FAVOR_HIGHLAND_PENALTY }
    multiply_temp_variable = { var = chem_wind_favor_add value = chem_wind_highland_ratio }
    add_to_temp_variable = { var = chem_wind_favor_chance value = chem_wind_favor_add }

    set_temp_variable = { var = chem_wind_against_chance value = @CHEM_WIND_AGAINST_BASE }
    set_temp_variable = { var = chem_wind_against_add value = @CHEM_WIND_AGAINST_CLEAR_PENALTY }
    multiply_temp_variable = { var = chem_wind_against_add value = chem_wind_clear }
    add_to_temp_variable = { var = chem_wind_against_chance value = chem_wind_against_add }
    set_temp_variable = { var = chem_wind_against_add value = @CHEM_WIND_AGAINST_SEVERE_BONUS }
    multiply_temp_variable = { var = chem_wind_against_add value = chem_wind_severity }
    add_to_temp_variable = { var = chem_wind_against_chance value = chem_wind_against_add }
    set_temp_variable = { var = chem_wind_against_add value = @CHEM_WIND_AGAINST_EXTREME_BONUS }
    multiply_temp_variable = { var = chem_wind_against_add value = chem_wind_severity_squared }
    add_to_temp_variable = { var = chem_wind_against_chance value = chem_wind_against_add }
    set_temp_variable = { var = chem_wind_against_add value = @CHEM_WIND_AGAINST_EXTREME_BONUS_EXTRA }
    multiply_temp_variable = { var = chem_wind_against_add value = chem_wind_extreme_ratio }
    add_to_temp_variable = { var = chem_wind_against_chance value = chem_wind_against_add }
    set_temp_variable = { var = chem_wind_against_add value = @CHEM_WIND_AGAINST_ROUGH_BONUS }
    multiply_temp_variable = { var = chem_wind_against_add value = chem_wind_rough_ratio }
    add_to_temp_variable = { var = chem_wind_against_chance value = chem_wind_against_add }
    set_temp_variable = { var = chem_wind_against_add value = @CHEM_WIND_AGAINST_URBAN_BONUS }
    multiply_temp_variable = { var = chem_wind_against_add value = chem_wind_urban_ratio }
    add_to_temp_variable = { var = chem_wind_against_chance value = chem_wind_against_add }
    set_temp_variable = { var = chem_wind_against_add value = @CHEM_WIND_AGAINST_HIGHLAND_BONUS }
    multiply_temp_variable = { var = chem_wind_against_add value = chem_wind_highland_ratio }
    add_to_temp_variable = { var = chem_wind_against_chance value = chem_wind_against_add }

    set_temp_variable = { var = chem_wind_strong_favor_chance value = 0 }
    if = {
        limit = { OWNER = { has_tech = upper_air_soundings } }
        add_to_temp_variable = { var = chem_wind_favor_chance value = @CHEM_WIND_FAVOR_TECH_SOUNDINGS }
        set_temp_variable = { var = chem_wind_strong_favor_chance value = @CHEM_WIND_STRONG_FAVOR_TECH_SOUNDINGS }
        add_to_temp_variable = { var = chem_wind_against_chance value = @CHEM_WIND_AGAINST_TECH_SOUNDINGS }
    }
    else_if = {
        limit = { OWNER = { has_tech = meteorological_stations } }
        add_to_temp_variable = { var = chem_wind_favor_chance value = @CHEM_WIND_FAVOR_TECH_STATIONS }
        set_temp_variable = { var = chem_wind_strong_favor_chance value = @CHEM_WIND_STRONG_FAVOR_TECH_STATIONS }
        add_to_temp_variable = { var = chem_wind_against_chance value = @CHEM_WIND_AGAINST_TECH_STATIONS }
    }
    else_if = {
        limit = { OWNER = { has_tech = portable_anemometer } }
        add_to_temp_variable = { var = chem_wind_favor_chance value = @CHEM_WIND_FAVOR_TECH_VANES }
        add_to_temp_variable = { var = chem_wind_against_chance value = @CHEM_WIND_AGAINST_TECH_VANES }
    }

    if = {
        limit = { check_variable = { var = chem_wind_strong_favor_chance value = 0 compare = greater_than } }
        set_temp_variable = { var = chem_wind_strong_favor_add value = chem_wind_clear }
        add_to_temp_variable = { var = chem_wind_strong_favor_add value = chem_wind_open_ratio }
        divide_temp_variable = { var = chem_wind_strong_favor_add value = 2 }
        multiply_temp_variable = { var = chem_wind_strong_favor_add value = chem_wind_strong_favor_chance }
        set_temp_variable = { var = chem_wind_strong_favor_chance value = chem_wind_strong_favor_add }
    }

    clamp_temp_variable = { var = chem_wind_favor_chance min = 0 max = @CHEM_WIND_CHANCE_SCALE }
    clamp_temp_variable = { var = chem_wind_against_chance min = 0 max = @CHEM_WIND_CHANCE_SCALE }
    clamp_temp_variable = { var = chem_wind_strong_favor_chance min = 0 max = @CHEM_WIND_CHANCE_SCALE }

    set_temp_variable = { var = chem_wind_state_roll value = @CHEM_WIND_STATE_NEUTRAL }
    set_temp_variable = { var = chem_wind_positive_mult value = @CHEM_WIND_POSITIVE_NEUTRAL_MULT }
    set_temp_variable = { var = chem_wind_negative_mult value = @CHEM_WIND_NEGATIVE_NEUTRAL_MULT }
    set_temp_variable_to_random = { var = chem_wind_roll }
    multiply_temp_variable = { var = chem_wind_roll value = @CHEM_WIND_CHANCE_SCALE }
    set_temp_variable = { var = chem_wind_threshold_strong value = chem_wind_strong_favor_chance }
    set_temp_variable = { var = chem_wind_threshold_favor value = chem_wind_threshold_strong }
    add_to_temp_variable = { var = chem_wind_threshold_favor value = chem_wind_favor_chance }
    set_temp_variable = { var = chem_wind_threshold_against value = chem_wind_threshold_favor }
    add_to_temp_variable = { var = chem_wind_threshold_against value = chem_wind_against_chance }
    if = {
        limit = { check_variable = { var = chem_wind_roll value = chem_wind_threshold_strong compare = less_than } }
        set_temp_variable = { var = chem_wind_state_roll value = @CHEM_WIND_STATE_STRONG_FAVOR }
        set_temp_variable = { var = chem_wind_positive_mult value = @CHEM_WIND_POSITIVE_STRONG_FAVOR_MULT }
        set_temp_variable = { var = chem_wind_negative_mult value = @CHEM_WIND_NEGATIVE_STRONG_FAVOR_MULT }
    }
    else_if = {
        limit = { check_variable = { var = chem_wind_roll value = chem_wind_threshold_favor compare = less_than } }
        set_temp_variable = { var = chem_wind_state_roll value = @CHEM_WIND_STATE_FAVOR }
        set_temp_variable = { var = chem_wind_positive_mult value = @CHEM_WIND_POSITIVE_FAVOR_MULT }
        set_temp_variable = { var = chem_wind_negative_mult value = @CHEM_WIND_NEGATIVE_FAVOR_MULT }
    }
    else_if = {
        limit = { check_variable = { var = chem_wind_roll value = chem_wind_threshold_against compare = less_than } }
        set_temp_variable = { var = chem_wind_state_roll value = @CHEM_WIND_STATE_AGAINST }
        set_temp_variable = { var = chem_wind_positive_mult value = @CHEM_WIND_POSITIVE_AGAINST_MULT }
        set_temp_variable = { var = chem_wind_negative_mult value = @CHEM_WIND_NEGATIVE_AGAINST_MULT }
    }
    set_variable = { var = chem_wind_state value = chem_wind_state_roll }
    set_variable = { var = chem_wind_positive_mult_value value = chem_wind_positive_mult }
    set_variable = { var = chem_wind_negative_mult_value value = chem_wind_negative_mult }
    OWNER = {
        set_variable = { var = chem_wind_state value = ROOT.chem_wind_state }
        set_variable = { var = chem_wind_positive_mult_value value = ROOT.chem_wind_positive_mult_value }
        set_variable = { var = chem_wind_negative_mult_value value = ROOT.chem_wind_negative_mult_value }
    }
}

chem_roll_wind_state_weekly = {
    if = {
        limit = { has_variable = chem_wind_days_since_roll }
        add_to_variable = { var = chem_wind_days_since_roll value = 1 }
    }
    else = {
        set_variable = { var = chem_wind_days_since_roll value = @CHEM_WIND_FORECAST_DAYS }
        OWNER = { set_variable = { var = chem_wind_days_since_roll value = ROOT.chem_wind_days_since_roll } }
    }
    if = {
        limit = { check_variable = { var = chem_wind_days_since_roll value = @CHEM_WIND_FORECAST_DAYS compare = greater_than_or_equals } }
        chem_roll_wind_state = yes
        set_variable = { var = chem_wind_days_since_roll value = 0 }
        OWNER = { set_variable = { var = chem_wind_days_since_roll value = ROOT.chem_wind_days_since_roll } }
    }
}

chem_use_wind_forecast = {
    if = {
        limit = {
            has_variable = chem_wind_state
            has_variable = chem_wind_positive_mult_value
            has_variable = chem_wind_negative_mult_value
        }
        set_temp_variable = { var = chem_wind_state_roll value = chem_wind_state }
        set_temp_variable = { var = chem_wind_positive_mult value = chem_wind_positive_mult_value }
        set_temp_variable = { var = chem_wind_negative_mult value = chem_wind_negative_mult_value }
    }
    else_if = {
        limit = {
            OWNER = {
                has_variable = chem_wind_state
                has_variable = chem_wind_positive_mult_value
                has_variable = chem_wind_negative_mult_value
            }
        }
        set_temp_variable = { var = chem_wind_state_roll value = OWNER.chem_wind_state }
        set_temp_variable = { var = chem_wind_positive_mult value = OWNER.chem_wind_positive_mult_value }
        set_temp_variable = { var = chem_wind_negative_mult value = OWNER.chem_wind_negative_mult_value }
    }
    else = { chem_roll_wind_state = yes }
}

chem_apply_wind_miscalculation = {
    set_temp_variable = { var = chem_wind_miscalc_happened value = 0 }
    if = {
        limit = { check_variable = { var = chem_wind_state_roll value = @CHEM_WIND_STATE_AGAINST compare = greater_than } }
        set_temp_variable = { var = chem_wind_miscalc_chance value = @CHEM_WIND_MISCALC_BASE }
        if = {
            limit = { OWNER = { has_tech = upper_air_soundings } }
            set_temp_variable = { var = chem_wind_miscalc_chance value = @CHEM_WIND_MISCALC_SOUNDINGS }
        }
        else_if = {
            limit = { OWNER = { has_tech = meteorological_stations } }
            set_temp_variable = { var = chem_wind_miscalc_chance value = @CHEM_WIND_MISCALC_STATIONS }
        }
        else_if = {
            limit = { OWNER = { has_tech = portable_anemometer } }
            set_temp_variable = { var = chem_wind_miscalc_chance value = @CHEM_WIND_MISCALC_VANES }
        }
        clamp_temp_variable = { var = chem_wind_miscalc_chance min = 0 max = 1 }
        set_temp_variable_to_random = { var = chem_wind_miscalc_roll }
        if = {
            limit = { check_variable = { var = chem_wind_miscalc_roll value = chem_wind_miscalc_chance compare = less_than } }
            set_temp_variable = { var = chem_wind_miscalc_happened value = 1 }
            set_temp_variable = { var = chem_wind_state_roll value = @CHEM_WIND_STATE_AGAINST }
            set_temp_variable = { var = chem_wind_positive_mult value = @CHEM_WIND_POSITIVE_AGAINST_MULT }
            set_temp_variable = { var = chem_wind_negative_mult value = @CHEM_WIND_NEGATIVE_AGAINST_MULT }
            set_variable = { var = chem_wind_state value = chem_wind_state_roll }
            set_variable = { var = chem_wind_positive_mult_value value = chem_wind_positive_mult }
            set_variable = { var = chem_wind_negative_mult_value value = chem_wind_negative_mult }
            OWNER = { set_variable = { var = chem_wind_state value = ROOT.chem_wind_state } }
            unit_leader_event = { id = chem_wind.1 }
        }
    }
}

chem_apply_wind_ability_modifiers = {
    multiply_temp_variable = { var = chem_offense value = chem_wind_positive_mult_value }
    multiply_temp_variable = { var = chem_breakthrough value = chem_wind_positive_mult_value }
    multiply_temp_variable = { var = chem_defense value = chem_wind_positive_mult_value }
    multiply_temp_variable = { var = chem_org_damage value = chem_wind_negative_mult_value }
    multiply_temp_variable = { var = chem_str_damage value = chem_wind_negative_mult_value }
    multiply_temp_variable = { var = chem_war_support value = chem_wind_negative_mult_value }
}

chem_apply_wind_preview_modifiers = {
    multiply_temp_variable = { var = chem_offense_preview value = chem_wind_positive_mult_value }
    multiply_temp_variable = { var = chem_breakthrough_preview value = chem_wind_positive_mult_value }
    multiply_temp_variable = { var = chem_defense_preview value = chem_wind_positive_mult_value }
    multiply_temp_variable = { var = chem_org_damage_preview value = chem_wind_negative_mult_value }
    multiply_temp_variable = { var = chem_str_damage_preview value = chem_wind_negative_mult_value }
    multiply_temp_variable = { var = chem_war_support_preview value = chem_wind_negative_mult_value }
}

chem_apply_state_contamination = {
    set_temp_variable = { var = chem_current_day value = global.num_days }
    set_temp_variable = { var = chem_max_strength value = @CHEM_STATE_MAX_STRENGTH_BASE }
    multiply_temp_variable = { var = chem_max_strength value = @CHEM_STATE_STRENGTH_SCALE }
    set_temp_variable = { var = chem_max_duration_days value = @CHEM_STATE_MAX_DURATION_DAYS_BASE }
    multiply_temp_variable = { var = chem_max_duration_days value = @CHEM_STATE_DURATION_SCALE }
    round_temp_variable = chem_max_duration_days
    clamp_temp_variable = { var = chem_max_duration_days min = 1 max = 9999 }

    set_temp_variable = { var = chem_existing_strength value = chem_state_contamination_strength }
    set_temp_variable = { var = chem_existing_expiry value = chem_state_contamination_expiry_day }
    if = {
        limit = { check_variable = { var = chem_existing_expiry value = chem_current_day compare = less_than_or_equals } }
        set_temp_variable = { var = chem_existing_strength value = 0 }
        set_temp_variable = { var = chem_existing_expiry value = chem_current_day }
    }
    set_temp_variable = { var = chem_new_strength value = chem_existing_strength }
    add_to_temp_variable = { var = chem_new_strength value = chem_dose_each }
    if = {
        limit = { check_variable = { var = chem_new_strength value = 0 compare = greater_than } }
        set_temp_variable = { var = chem_new_strength value = 0 }
    }
    if = {
        limit = { check_variable = { var = chem_new_strength value = chem_max_strength compare = less_than } }
        set_temp_variable = { var = chem_new_strength value = chem_max_strength }
    }
    set_variable = { var = chem_state_contamination_strength value = chem_new_strength }
    set_temp_variable = { var = chem_supply_effect value = chem_new_strength }
    multiply_temp_variable = { var = chem_supply_effect value = @CHEM_STATE_SUPPLY_MULT }
    set_variable = { var = chem_state_contamination_supplies value = chem_supply_effect }
    set_temp_variable = { var = chem_supply_impact value = chem_new_strength }
    multiply_temp_variable = { var = chem_supply_impact value = @CHEM_STATE_SUPPLY_IMPACT_MULT }
    set_variable = { var = chem_state_contamination_supply_impact value = chem_supply_impact }
    set_temp_variable = { var = chem_speed_effect value = chem_new_strength }
    multiply_temp_variable = { var = chem_speed_effect value = @CHEM_STATE_SPEED_MULT }
    set_variable = { var = chem_state_contamination_speed value = chem_speed_effect }
    set_temp_variable = { var = chem_truck_attrition value = chem_new_strength }
    multiply_temp_variable = { var = chem_truck_attrition value = @CHEM_STATE_TRUCK_ATTRITION_MULT }
    set_variable = { var = chem_state_contamination_truck_attrition value = chem_truck_attrition }
    set_temp_variable = { var = chem_attack_effect value = chem_new_strength }
    multiply_temp_variable = { var = chem_attack_effect value = @CHEM_STATE_ATTACK_MULT }
    set_variable = { var = chem_state_contamination_attack value = chem_attack_effect }
    set_temp_variable = { var = chem_breakthrough_effect value = chem_new_strength }
    multiply_temp_variable = { var = chem_breakthrough_effect value = @CHEM_STATE_BREAKTHROUGH_MULT }
    set_variable = { var = chem_state_contamination_breakthrough value = chem_breakthrough_effect }

    set_temp_variable = { var = chem_new_expiry value = chem_existing_expiry }
    add_to_temp_variable = { var = chem_new_expiry value = chem_state_duration_add }
    set_temp_variable = { var = chem_expiry_cap value = chem_current_day }
    add_to_temp_variable = { var = chem_expiry_cap value = chem_max_duration_days }
    if = {
        limit = { check_variable = { var = chem_new_expiry value = chem_expiry_cap compare = greater_than } }
        set_temp_variable = { var = chem_new_expiry value = chem_expiry_cap }
    }
    set_variable = { var = chem_state_contamination_expiry_day value = chem_new_expiry }
    set_temp_variable = { var = chem_days_left value = chem_new_expiry }
    set_temp_variable = { var = chem_current_day_neg value = chem_current_day }
    multiply_temp_variable = { var = chem_current_day_neg value = -1 }
    add_to_temp_variable = { var = chem_days_left value = chem_current_day_neg }
    clamp_temp_variable = { var = chem_days_left min = 1 max = chem_max_duration_days }
    add_dynamic_modifier = { modifier = chem_state_contamination days = chem_days_left }
    force_update_dynamic_modifier = yes
    # log = "CHEM_STATE: contaminated [THIS.GetName] ([THIS.GetID]) strength=[?chem_state_contamination_strength|.4] supplies=[?chem_state_contamination_supplies|.4] atk=[?chem_state_contamination_attack|.4] brk=[?chem_state_contamination_breakthrough|.4] days=[?chem_days_left|0]"
}

chem_apply_state_contamination_doomsday = {
	set_temp_variable = { var = chem_current_day value = global.num_days }
	set_temp_variable = { var = chem_max_strength value = @CHEM_STATE_MAX_STRENGTH_BASE }
	multiply_temp_variable = { var = chem_max_strength value = @CHEM_STATE_STRENGTH_SCALE }
	set_temp_variable = { var = chem_max_duration_days value = @CHEM_DOOM_STATE_MAX_DURATION_DAYS_BASE }
	multiply_temp_variable = { var = chem_max_duration_days value = @CHEM_DOOM_STATE_MAX_DURATION_SCALE }
	round_temp_variable = chem_max_duration_days
	clamp_temp_variable = { var = chem_max_duration_days min = 1 max = 9999 }

	set_temp_variable = { var = chem_existing_strength value = chem_state_contamination_strength }
	set_temp_variable = { var = chem_existing_expiry value = chem_state_contamination_expiry_day }
	if = {
		limit = { check_variable = { var = chem_existing_expiry value = chem_current_day compare = less_than_or_equals } }
		set_temp_variable = { var = chem_existing_strength value = 0 }
		set_temp_variable = { var = chem_existing_expiry value = chem_current_day }
	}
	set_temp_variable = { var = chem_new_strength value = chem_existing_strength }
	add_to_temp_variable = { var = chem_new_strength value = chem_dose_each }
	if = {
		limit = { check_variable = { var = chem_new_strength value = 0 compare = greater_than } }
		set_temp_variable = { var = chem_new_strength value = 0 }
	}
	if = {
		limit = { check_variable = { var = chem_new_strength value = chem_max_strength compare = less_than } }
		set_temp_variable = { var = chem_new_strength value = chem_max_strength }
	}
	set_variable = { var = chem_state_contamination_strength value = chem_new_strength }
	set_temp_variable = { var = chem_supply_effect value = chem_new_strength }
	multiply_temp_variable = { var = chem_supply_effect value = @CHEM_STATE_SUPPLY_MULT }
	set_variable = { var = chem_state_contamination_supplies value = chem_supply_effect }
	set_temp_variable = { var = chem_supply_impact value = chem_new_strength }
	multiply_temp_variable = { var = chem_supply_impact value = @CHEM_STATE_SUPPLY_IMPACT_MULT }
	set_variable = { var = chem_state_contamination_supply_impact value = chem_supply_impact }
	set_temp_variable = { var = chem_speed_effect value = chem_new_strength }
	multiply_temp_variable = { var = chem_speed_effect value = @CHEM_STATE_SPEED_MULT }
	set_variable = { var = chem_state_contamination_speed value = chem_speed_effect }
	set_temp_variable = { var = chem_truck_attrition value = chem_new_strength }
	multiply_temp_variable = { var = chem_truck_attrition value = @CHEM_STATE_TRUCK_ATTRITION_MULT }
	set_variable = { var = chem_state_contamination_truck_attrition value = chem_truck_attrition }
	set_temp_variable = { var = chem_attack_effect value = chem_new_strength }
	multiply_temp_variable = { var = chem_attack_effect value = @CHEM_STATE_ATTACK_MULT }
	set_variable = { var = chem_state_contamination_attack value = chem_attack_effect }
	set_temp_variable = { var = chem_breakthrough_effect value = chem_new_strength }
	multiply_temp_variable = { var = chem_breakthrough_effect value = @CHEM_STATE_BREAKTHROUGH_MULT }
	set_variable = { var = chem_state_contamination_breakthrough value = chem_breakthrough_effect }

	set_temp_variable = { var = chem_new_expiry value = chem_existing_expiry }
	add_to_temp_variable = { var = chem_new_expiry value = chem_state_duration_add }
	set_temp_variable = { var = chem_expiry_cap value = chem_current_day }
	add_to_temp_variable = { var = chem_expiry_cap value = chem_max_duration_days }
	if = {
		limit = { check_variable = { var = chem_new_expiry value = chem_expiry_cap compare = greater_than } }
		set_temp_variable = { var = chem_new_expiry value = chem_expiry_cap }
	}
	set_variable = { var = chem_state_contamination_expiry_day value = chem_new_expiry }
	set_temp_variable = { var = chem_days_left value = chem_new_expiry }
	set_temp_variable = { var = chem_current_day_neg value = chem_current_day }
	multiply_temp_variable = { var = chem_current_day_neg value = -1 }
	add_to_temp_variable = { var = chem_days_left value = chem_current_day_neg }
	clamp_temp_variable = { var = chem_days_left min = 1 max = chem_max_duration_days }
	add_dynamic_modifier = { modifier = chem_state_contamination days = chem_days_left }
	force_update_dynamic_modifier = yes
}

chem_unleash_stockpile_doomsday = {
	set_temp_variable = { var = chem_doom_stock_chlorine value = num_equipment@chemical_chlorine_payload_cylinder_1 }
	set_temp_variable = { var = chem_doom_stock_phosgene value = num_equipment@chemical_phosgene_payload_cylinder_1 }
	set_temp_variable = { var = chem_doom_stock_mustard value = num_equipment@chemical_mustard_payload_cylinder_1 }
    set_temp_variable = { var = chem_doom_stock_lewisite value = num_equipment@chemical_lewisite_payload_cylinder_1 }

    set_temp_variable = { var = chem_doom_points_acute value = 0 }
    set_temp_variable = { var = chem_doom_points_persist value = 0 }

    set_temp_variable = { var = chem_doom_tmp value = chem_doom_stock_chlorine }
    multiply_temp_variable = { var = chem_doom_tmp value = @CHEM_DOOM_ACUTE_WEIGHT_CHLORINE }
    add_to_temp_variable = { var = chem_doom_points_acute value = chem_doom_tmp }
    set_temp_variable = { var = chem_doom_tmp value = chem_doom_stock_phosgene }
    multiply_temp_variable = { var = chem_doom_tmp value = @CHEM_DOOM_ACUTE_WEIGHT_PHOSGENE }
    add_to_temp_variable = { var = chem_doom_points_acute value = chem_doom_tmp }
    set_temp_variable = { var = chem_doom_tmp value = chem_doom_stock_mustard }
    multiply_temp_variable = { var = chem_doom_tmp value = @CHEM_DOOM_ACUTE_WEIGHT_MUSTARD }
    add_to_temp_variable = { var = chem_doom_points_acute value = chem_doom_tmp }
    set_temp_variable = { var = chem_doom_tmp value = chem_doom_stock_lewisite }
    multiply_temp_variable = { var = chem_doom_tmp value = @CHEM_DOOM_ACUTE_WEIGHT_LEWISITE }
    add_to_temp_variable = { var = chem_doom_points_acute value = chem_doom_tmp }

    set_temp_variable = { var = chem_doom_tmp value = chem_doom_stock_chlorine }
    multiply_temp_variable = { var = chem_doom_tmp value = @CHEM_DOOM_PERSIST_WEIGHT_CHLORINE }
    add_to_temp_variable = { var = chem_doom_points_persist value = chem_doom_tmp }
    set_temp_variable = { var = chem_doom_tmp value = chem_doom_stock_phosgene }
    multiply_temp_variable = { var = chem_doom_tmp value = @CHEM_DOOM_PERSIST_WEIGHT_PHOSGENE }
    add_to_temp_variable = { var = chem_doom_points_persist value = chem_doom_tmp }
    set_temp_variable = { var = chem_doom_tmp value = chem_doom_stock_mustard }
    multiply_temp_variable = { var = chem_doom_tmp value = @CHEM_DOOM_PERSIST_WEIGHT_MUSTARD }
    add_to_temp_variable = { var = chem_doom_points_persist value = chem_doom_tmp }
    set_temp_variable = { var = chem_doom_tmp value = chem_doom_stock_lewisite }
    multiply_temp_variable = { var = chem_doom_tmp value = @CHEM_DOOM_PERSIST_WEIGHT_LEWISITE }
    add_to_temp_variable = { var = chem_doom_points_persist value = chem_doom_tmp }

    set_temp_variable = { var = chem_doom_org_damage_ratio value = chem_doom_points_acute }
    divide_temp_variable = { var = chem_doom_org_damage_ratio value = @CHEM_DOOM_ACUTE_ORG_SCALE }
    clamp_temp_variable = { var = chem_doom_org_damage_ratio min = 0 max = @CHEM_DOOM_ORG_DAMAGE_MAX }
    set_temp_variable = { var = chem_doom_str_damage_ratio value = chem_doom_points_acute }
    divide_temp_variable = { var = chem_doom_str_damage_ratio value = @CHEM_DOOM_ACUTE_STR_SCALE }
    clamp_temp_variable = { var = chem_doom_str_damage_ratio min = 0 max = @CHEM_DOOM_STR_DAMAGE_MAX }

    set_temp_variable = { var = chem_doom_state_dose_each value = chem_doom_points_acute }
    divide_temp_variable = { var = chem_doom_state_dose_each value = @CHEM_DOOM_STATE_DOSE_SCALE }
    clamp_temp_variable = { var = chem_doom_state_dose_each min = 0 max = @CHEM_DOOM_STATE_DOSE_MAX }
    multiply_temp_variable = { var = chem_doom_state_dose_each value = -1 }

    set_temp_variable = { var = chem_doom_state_duration_add value = chem_doom_points_persist }
    divide_temp_variable = { var = chem_doom_state_duration_add value = @CHEM_DOOM_STATE_DURATION_SCALE }
    round_temp_variable = chem_doom_state_duration_add
    clamp_temp_variable = { var = chem_doom_state_duration_add min = 1 max = @CHEM_DOOM_STATE_DURATION_ADD_MAX }

	every_controlled_state = {
		damage_units = {
			state = THIS
			org_damage = chem_doom_org_damage_ratio
            str_damage = chem_doom_str_damage_ratio
            ratio = yes
            army = yes
		}
		set_temp_variable = { var = chem_dose_each value = chem_doom_state_dose_each }
		set_temp_variable = { var = chem_state_duration_add value = chem_doom_state_duration_add }
		chem_apply_state_contamination_doomsday = yes
	}

    set_temp_variable = { var = chem_doom_remove value = chem_doom_stock_chlorine }
    multiply_temp_variable = { var = chem_doom_remove value = -1 }
    add_equipment_to_stockpile = { type = chemical_chlorine_payload_cylinder_1 amount = chem_doom_remove }
    set_temp_variable = { var = chem_doom_remove value = chem_doom_stock_phosgene }
    multiply_temp_variable = { var = chem_doom_remove value = -1 }
    add_equipment_to_stockpile = { type = chemical_phosgene_payload_cylinder_1 amount = chem_doom_remove }
    set_temp_variable = { var = chem_doom_remove value = chem_doom_stock_mustard }
    multiply_temp_variable = { var = chem_doom_remove value = -1 }
    add_equipment_to_stockpile = { type = chemical_mustard_payload_cylinder_1 amount = chem_doom_remove }
    set_temp_variable = { var = chem_doom_remove value = chem_doom_stock_lewisite }
    multiply_temp_variable = { var = chem_doom_remove value = -1 }
    add_equipment_to_stockpile = { type = chemical_lewisite_payload_cylinder_1 amount = chem_doom_remove }
}

chem_apply_state_dispersal = {
    save_event_target_as = chem_state_dispersal_leader
    # log = "CHEM_STATE: chem_apply_state_dispersal country=[chem_state_dispersal_owner_country.GetNameDef] leader=[THIS.GetName]"
    set_temp_variable = { var = chem_state_dose_per_div value = 0 }
    set_temp_variable = { var = chem_state_duration_add value = 0 }
    if = {
        limit = { has_trait = chemical_cylinder_active_chlorine }
        set_temp_variable = { var = chem_state_dose_per_div value = @CHEM_STATE_CHLORINE_DOSE_PER_DIV }
        set_temp_variable = { var = chem_state_duration_add value = @CHEM_STATE_CHLORINE_DURATION_ADD }
        # log = "CHEM_STATE: type=chlorine"
    }
    else_if = {
        limit = { has_trait = chemical_cylinder_active_phosgene }
        set_temp_variable = { var = chem_state_dose_per_div value = @CHEM_STATE_PHOSGENE_DOSE_PER_DIV }
        set_temp_variable = { var = chem_state_duration_add value = @CHEM_STATE_PHOSGENE_DURATION_ADD }
        # log = "CHEM_STATE: type=phosgene"
    }
    else_if = {
        limit = { has_trait = chemical_cylinder_active_mustard }
        set_temp_variable = { var = chem_state_dose_per_div value = @CHEM_STATE_MUSTARD_DOSE_PER_DIV }
        set_temp_variable = { var = chem_state_duration_add value = @CHEM_STATE_MUSTARD_DURATION_ADD }
        # log = "CHEM_STATE: type=mustard"
    }
    else_if = {
        limit = { has_trait = chemical_cylinder_active_lewisite }
        set_temp_variable = { var = chem_state_dose_per_div value = @CHEM_STATE_LEWISITE_DOSE_PER_DIV }
        set_temp_variable = { var = chem_state_duration_add value = @CHEM_STATE_LEWISITE_DURATION_ADD }
        # log = "CHEM_STATE: type=lewisite"
    }
    multiply_temp_variable = { var = chem_state_dose_per_div value = @CHEM_STATE_STRENGTH_SCALE }
    multiply_temp_variable = { var = chem_state_duration_add value = @CHEM_STATE_DURATION_SCALE }
    round_temp_variable = chem_state_duration_add
    if = {
        limit = { check_variable = { var = chem_state_duration_add value = 0 compare = greater_than } }
        event_target:chem_state_dispersal_owner_country = {
            set_temp_variable = { var = chem_state_scan_states_with_units value = 0 }
            set_temp_variable = { var = chem_state_scan_states_applied value = 0 }
            chem_apply_state_dispersal_from_controlled_states = yes
            every_allied_country = {
                set_temp_variable = { var = chem_state_scan_states_with_units value = 0 }
                set_temp_variable = { var = chem_state_scan_states_applied value = 0 }
                chem_apply_state_dispersal_from_controlled_states = yes
            }
        }
    }
}

chem_apply_state_dispersal_from_controlled_states = {
    every_controlled_state = {
        set_temp_variable = { var = chem_units_in_state value = 0 }
        event_target:chem_state_dispersal_leader = {
            meta_effect = {
                text = {
                    set_temp_variable = { var = chem_units_in_state value = num_units_in_state@[CHEM_STATE_ID] }
                }
                CHEM_STATE_ID = "[PREV.GetID]"
            }
        }
        if = {
            limit = { check_variable = { var = chem_units_in_state value = 0 compare = greater_than } }
            add_to_temp_variable = { var = chem_state_scan_states_with_units value = 1 }
            if = {
                limit = {
                    any_neighbor_state = {
                        CONTROLLER = { has_war_with = event_target:chem_state_dispersal_owner_country }
                        NOT = { is_controlled_by = event_target:chem_state_dispersal_owner_country }
                    }
                }
                set_temp_variable = { var = chem_dose_each value = chem_units_in_state }
                multiply_temp_variable = { var = chem_dose_each value = chem_state_dose_per_div }
                # log = "CHEM_STATE: applying to [THIS.GetName] ([THIS.GetID]) controller=[THIS.Controller.GetNameDef] units=[?chem_units_in_state|0] dose=[?chem_dose_each|.6]"
                add_to_temp_variable = { var = chem_state_scan_states_applied value = 1 }
                chem_apply_state_contamination = yes
            }
            else_if = {
                #
            }
        }

        # If the leader has divisions inside an enemy-controlled neighboring state (i.e. contested provinces),
        # apply contamination to that enemy state as well based on divisions present there.
        every_neighbor_state = {
            limit = {
                CONTROLLER = { has_war_with = event_target:chem_state_dispersal_owner_country }
                NOT = { is_controlled_by = event_target:chem_state_dispersal_owner_country }
            }
            set_temp_variable = { var = chem_units_in_enemy_state value = 0 }
            event_target:chem_state_dispersal_leader = {
                meta_effect = {
                    text = {
                        set_temp_variable = { var = chem_units_in_enemy_state value = num_units_in_state@[CHEM_STATE_ID] }
                    }
                    CHEM_STATE_ID = "[PREV.GetID]"
                }
            }
            if = {
                limit = { check_variable = { var = chem_units_in_enemy_state value = 0 compare = greater_than } }
                set_temp_variable = { var = chem_dose_each value = chem_units_in_enemy_state }
                multiply_temp_variable = { var = chem_dose_each value = chem_state_dose_per_div }
                # log = "CHEM_STATE: applying_enemy_state [THIS.GetName] ([THIS.GetID]) controller=[THIS.Controller.GetNameDef] units=[?chem_units_in_enemy_state|0] dose=[?chem_dose_each|.6]"
                add_to_temp_variable = { var = chem_state_scan_states_applied value = 1 }
                chem_apply_state_contamination = yes
            }
        }
    }
}

chem_prepare_weather_terrain_penalties = {
    set_temp_variable = { var = chem_duration_days value = @CHEM_ABILITY_DURATION_DAYS }
    set_temp_variable = { var = chem_combined_offense value = 0 }
    set_temp_variable = { var = chem_combined_breakthrough value = 0 }
    set_temp_variable = { var = chem_combined_org_damage value = 0 }
    set_temp_variable = { var = chem_combined_str_damage value = 0 }
}

chem_apply_weather_ability_modifiers = {
    set_temp_variable = { var = chem_total_units value = num_units }
    set_temp_variable = { var = chem_total_units_combat value = num_units_in_combat }
    if = {
        limit = { check_variable = { var = chem_total_units_combat value = 0 compare = greater_than } }
        set_temp_variable = { var = chem_total_units value = chem_total_units_combat }
    }
    clamp_temp_variable = { var = chem_total_units min = 1 }

    set_temp_variable = { var = chem_cold_units value = num_units_on_climate@cold_climate }
    if = {
        limit = { check_variable = { var = chem_cold_units value = 0 compare = greater_than } }
        set_temp_variable = { var = chem_cold_ratio value = chem_cold_units }
        divide_temp_variable = { var = chem_cold_ratio value = chem_total_units }
        set_temp_variable = { var = chem_weather_offense value = @CHEM_WEATHER_BLIZZARD_OFFENSE }
        multiply_temp_variable = { var = chem_weather_offense value = chem_ratio }
        multiply_temp_variable = { var = chem_weather_offense value = chem_cold_ratio }
        set_temp_variable = { var = chem_weather_breakthrough value = @CHEM_WEATHER_BLIZZARD_BREAKTHROUGH }
        multiply_temp_variable = { var = chem_weather_breakthrough value = chem_ratio }
        multiply_temp_variable = { var = chem_weather_breakthrough value = chem_cold_ratio }
        set_temp_variable = { var = chem_weather_org_damage value = @CHEM_WEATHER_BLIZZARD_ORG_DAMAGE }
        multiply_temp_variable = { var = chem_weather_org_damage value = chem_ratio }
        multiply_temp_variable = { var = chem_weather_org_damage value = chem_cold_ratio }
        add_to_temp_variable = { var = chem_combined_offense value = chem_weather_offense }
        add_to_temp_variable = { var = chem_combined_breakthrough value = chem_weather_breakthrough }
        add_to_temp_variable = { var = chem_combined_org_damage value = chem_weather_org_damage }
        set_temp_variable = { var = chem_extreme_cold_ratio value = chem_cold_ratio }
        set_temp_variable = { var = chem_extreme_threshold value = @CHEM_WEATHER_EXTREME_THRESHOLD }
        multiply_temp_variable = { var = chem_extreme_threshold value = -1 }
        add_to_temp_variable = { var = chem_extreme_cold_ratio value = chem_extreme_threshold }
        clamp_temp_variable = { var = chem_extreme_cold_ratio min = 0 max = 1 }
        if = {
            limit = { check_variable = { var = chem_extreme_cold_ratio value = 0 compare = greater_than } }
            set_temp_variable = { var = chem_weather_offense value = @CHEM_WEATHER_EXTREME_COLD_OFFENSE }
            multiply_temp_variable = { var = chem_weather_offense value = chem_ratio }
            multiply_temp_variable = { var = chem_weather_offense value = chem_extreme_cold_ratio }
            set_temp_variable = { var = chem_weather_breakthrough value = @CHEM_WEATHER_EXTREME_COLD_BREAKTHROUGH }
            multiply_temp_variable = { var = chem_weather_breakthrough value = chem_ratio }
            multiply_temp_variable = { var = chem_weather_breakthrough value = chem_extreme_cold_ratio }
            set_temp_variable = { var = chem_weather_org_damage value = @CHEM_WEATHER_EXTREME_COLD_ORG_DAMAGE }
            multiply_temp_variable = { var = chem_weather_org_damage value = chem_ratio }
            multiply_temp_variable = { var = chem_weather_org_damage value = chem_extreme_cold_ratio }
            add_to_temp_variable = { var = chem_combined_offense value = chem_weather_offense }
            add_to_temp_variable = { var = chem_combined_breakthrough value = chem_weather_breakthrough }
            add_to_temp_variable = { var = chem_combined_org_damage value = chem_weather_org_damage }
        }
    }

    set_temp_variable = { var = chem_hot_units value = num_units_on_climate@hot_climate }
    if = {
        limit = { check_variable = { var = chem_hot_units value = 0 compare = greater_than } }
        set_temp_variable = { var = chem_hot_ratio value = chem_hot_units }
        divide_temp_variable = { var = chem_hot_ratio value = chem_total_units }
        set_temp_variable = { var = chem_weather_offense value = @CHEM_WEATHER_SANDSTORM_OFFENSE }
        multiply_temp_variable = { var = chem_weather_offense value = chem_ratio }
        multiply_temp_variable = { var = chem_weather_offense value = chem_hot_ratio }
        set_temp_variable = { var = chem_weather_str_damage value = @CHEM_WEATHER_SANDSTORM_STR_DAMAGE }
        multiply_temp_variable = { var = chem_weather_str_damage value = chem_ratio }
        multiply_temp_variable = { var = chem_weather_str_damage value = chem_hot_ratio }
        set_temp_variable = { var = chem_weather_org_damage value = @CHEM_WEATHER_SANDSTORM_ORG_DAMAGE }
        multiply_temp_variable = { var = chem_weather_org_damage value = chem_ratio }
        multiply_temp_variable = { var = chem_weather_org_damage value = chem_hot_ratio }
        add_to_temp_variable = { var = chem_combined_offense value = chem_weather_offense }
        add_to_temp_variable = { var = chem_combined_org_damage value = chem_weather_org_damage }
        add_to_temp_variable = { var = chem_combined_str_damage value = chem_weather_str_damage }
        set_temp_variable = { var = chem_extreme_hot_ratio value = chem_hot_ratio }
        set_temp_variable = { var = chem_extreme_threshold value = @CHEM_WEATHER_EXTREME_THRESHOLD }
        multiply_temp_variable = { var = chem_extreme_threshold value = -1 }
        add_to_temp_variable = { var = chem_extreme_hot_ratio value = chem_extreme_threshold }
        clamp_temp_variable = { var = chem_extreme_hot_ratio min = 0 max = 1 }
        if = {
            limit = { check_variable = { var = chem_extreme_hot_ratio value = 0 compare = greater_than } }
            set_temp_variable = { var = chem_weather_offense value = @CHEM_WEATHER_EXTREME_HEAT_OFFENSE }
            multiply_temp_variable = { var = chem_weather_offense value = chem_ratio }
            multiply_temp_variable = { var = chem_weather_offense value = chem_extreme_hot_ratio }
            set_temp_variable = { var = chem_weather_str_damage value = @CHEM_WEATHER_EXTREME_HEAT_STR_DAMAGE }
            multiply_temp_variable = { var = chem_weather_str_damage value = chem_ratio }
            multiply_temp_variable = { var = chem_weather_str_damage value = chem_extreme_hot_ratio }
            set_temp_variable = { var = chem_weather_org_damage value = @CHEM_WEATHER_EXTREME_HEAT_ORG_DAMAGE }
            multiply_temp_variable = { var = chem_weather_org_damage value = chem_ratio }
            multiply_temp_variable = { var = chem_weather_org_damage value = chem_extreme_hot_ratio }
            add_to_temp_variable = { var = chem_combined_offense value = chem_weather_offense }
            add_to_temp_variable = { var = chem_combined_org_damage value = chem_weather_org_damage }
            add_to_temp_variable = { var = chem_combined_str_damage value = chem_weather_str_damage }
        }
    }
}

@CHEM_TERRAIN_WOODS_OFFENSE = -0.005
@CHEM_TERRAIN_WOODS_BREAKTHROUGH = -0.005
@CHEM_TERRAIN_WOODS_ORG_DAMAGE = 0.01

@CHEM_TERRAIN_HILLS_BREAKTHROUGH = -0.006
@CHEM_TERRAIN_HILLS_ORG_DAMAGE = 0.01

@CHEM_TERRAIN_URBAN_ORG_DAMAGE = 0.012
@CHEM_TERRAIN_URBAN_STR_DAMAGE = 0.015

@CHEM_TERRAIN_MARSH_BREAKTHROUGH = -0.005
@CHEM_TERRAIN_MARSH_ORG_DAMAGE = 0.01

@CHEM_TERRAIN_PLAINS_OFFENSE = -0.004
@CHEM_TERRAIN_PLAINS_BREAKTHROUGH = -0.004
@CHEM_TERRAIN_PLAINS_ORG_DAMAGE = 0.008
@CHEM_TERRAIN_PLAINS_STR_DAMAGE = 0.005

@CHEM_TERRAIN_DESERT_OFFENSE = -0.005
@CHEM_TERRAIN_DESERT_BREAKTHROUGH = -0.005
@CHEM_TERRAIN_DESERT_ORG_DAMAGE = 0.01
@CHEM_TERRAIN_DESERT_STR_DAMAGE = 0.008

chem_apply_terrain_ability_modifiers = {
    set_temp_variable = { var = chem_total_combat_units value = num_units_in_combat }
    set_temp_variable = { var = chem_total_units value = num_units }
    if = {
        limit = { check_variable = { var = chem_total_combat_units value = 0 compare = less_than_or_equals } }
        set_temp_variable = { var = chem_total_combat_units value = chem_total_units }
    }
    clamp_temp_variable = { var = chem_total_combat_units min = 1 }

    set_temp_variable = { var = chem_terrain_units value = 0 }
    set_temp_variable = { var = chem_terrain_units_off value = num_units_offensive_combats_against@plains }
    add_to_temp_variable = { var = chem_terrain_units value = chem_terrain_units_off }
    set_temp_variable = { var = chem_terrain_units_def value = num_units_defensive_combats_on@plains }
    add_to_temp_variable = { var = chem_terrain_units value = chem_terrain_units_def }
    if = {
        limit = { check_variable = { var = chem_terrain_units value = 0 compare = greater_than } }
        set_temp_variable = { var = chem_terrain_ratio value = chem_terrain_units }
        divide_temp_variable = { var = chem_terrain_ratio value = chem_total_combat_units }
        set_temp_variable = { var = chem_terrain_offense value = @CHEM_TERRAIN_PLAINS_OFFENSE }
        multiply_temp_variable = { var = chem_terrain_offense value = chem_ratio }
        multiply_temp_variable = { var = chem_terrain_offense value = chem_terrain_ratio }
        set_temp_variable = { var = chem_terrain_breakthrough value = @CHEM_TERRAIN_PLAINS_BREAKTHROUGH }
        multiply_temp_variable = { var = chem_terrain_breakthrough value = chem_ratio }
        multiply_temp_variable = { var = chem_terrain_breakthrough value = chem_terrain_ratio }
        set_temp_variable = { var = chem_terrain_org_damage value = @CHEM_TERRAIN_PLAINS_ORG_DAMAGE }
        multiply_temp_variable = { var = chem_terrain_org_damage value = chem_ratio }
        multiply_temp_variable = { var = chem_terrain_org_damage value = chem_terrain_ratio }
        set_temp_variable = { var = chem_terrain_str_damage value = @CHEM_TERRAIN_PLAINS_STR_DAMAGE }
        multiply_temp_variable = { var = chem_terrain_str_damage value = chem_ratio }
        multiply_temp_variable = { var = chem_terrain_str_damage value = chem_terrain_ratio }
        add_to_temp_variable = { var = chem_combined_offense value = chem_terrain_offense }
        add_to_temp_variable = { var = chem_combined_breakthrough value = chem_terrain_breakthrough }
        add_to_temp_variable = { var = chem_combined_org_damage value = chem_terrain_org_damage }
        add_to_temp_variable = { var = chem_combined_str_damage value = chem_terrain_str_damage }
    }

    set_temp_variable = { var = chem_terrain_units value = 0 }
    set_temp_variable = { var = chem_terrain_units_off value = num_units_offensive_combats_against@desert }
    add_to_temp_variable = { var = chem_terrain_units value = chem_terrain_units_off }
    set_temp_variable = { var = chem_terrain_units_def value = num_units_defensive_combats_on@desert }
    add_to_temp_variable = { var = chem_terrain_units value = chem_terrain_units_def }
    if = {
        limit = { check_variable = { var = chem_terrain_units value = 0 compare = greater_than } }
        set_temp_variable = { var = chem_terrain_ratio value = chem_terrain_units }
        divide_temp_variable = { var = chem_terrain_ratio value = chem_total_combat_units }
        set_temp_variable = { var = chem_terrain_offense value = @CHEM_TERRAIN_DESERT_OFFENSE }
        multiply_temp_variable = { var = chem_terrain_offense value = chem_ratio }
        multiply_temp_variable = { var = chem_terrain_offense value = chem_terrain_ratio }
        set_temp_variable = { var = chem_terrain_breakthrough value = @CHEM_TERRAIN_DESERT_BREAKTHROUGH }
        multiply_temp_variable = { var = chem_terrain_breakthrough value = chem_ratio }
        multiply_temp_variable = { var = chem_terrain_breakthrough value = chem_terrain_ratio }
        set_temp_variable = { var = chem_terrain_org_damage value = @CHEM_TERRAIN_DESERT_ORG_DAMAGE }
        multiply_temp_variable = { var = chem_terrain_org_damage value = chem_ratio }
        multiply_temp_variable = { var = chem_terrain_org_damage value = chem_terrain_ratio }
        set_temp_variable = { var = chem_terrain_str_damage value = @CHEM_TERRAIN_DESERT_STR_DAMAGE }
        multiply_temp_variable = { var = chem_terrain_str_damage value = chem_ratio }
        multiply_temp_variable = { var = chem_terrain_str_damage value = chem_terrain_ratio }
        add_to_temp_variable = { var = chem_combined_offense value = chem_terrain_offense }
        add_to_temp_variable = { var = chem_combined_breakthrough value = chem_terrain_breakthrough }
        add_to_temp_variable = { var = chem_combined_org_damage value = chem_terrain_org_damage }
        add_to_temp_variable = { var = chem_combined_str_damage value = chem_terrain_str_damage }
    }

    set_temp_variable = { var = chem_terrain_units value = 0 }
    set_temp_variable = { var = chem_terrain_units_off value = num_units_offensive_combats_against@forest }
    add_to_temp_variable = { var = chem_terrain_units value = chem_terrain_units_off }
    set_temp_variable = { var = chem_terrain_units_def value = num_units_defensive_combats_on@forest }
    add_to_temp_variable = { var = chem_terrain_units value = chem_terrain_units_def }
    set_temp_variable = { var = chem_terrain_units_off value = num_units_offensive_combats_against@jungle }
    add_to_temp_variable = { var = chem_terrain_units value = chem_terrain_units_off }
    set_temp_variable = { var = chem_terrain_units_def value = num_units_defensive_combats_on@jungle }
    add_to_temp_variable = { var = chem_terrain_units value = chem_terrain_units_def }
    if = {
        limit = { check_variable = { var = chem_terrain_units value = 0 compare = greater_than } }
        set_temp_variable = { var = chem_terrain_ratio value = chem_terrain_units }
        divide_temp_variable = { var = chem_terrain_ratio value = chem_total_combat_units }
        set_temp_variable = { var = chem_terrain_offense value = @CHEM_TERRAIN_WOODS_OFFENSE }
        multiply_temp_variable = { var = chem_terrain_offense value = chem_ratio }
        multiply_temp_variable = { var = chem_terrain_offense value = chem_terrain_ratio }
        set_temp_variable = { var = chem_terrain_breakthrough value = @CHEM_TERRAIN_WOODS_BREAKTHROUGH }
        multiply_temp_variable = { var = chem_terrain_breakthrough value = chem_ratio }
        multiply_temp_variable = { var = chem_terrain_breakthrough value = chem_terrain_ratio }
        set_temp_variable = { var = chem_terrain_org_damage value = @CHEM_TERRAIN_WOODS_ORG_DAMAGE }
        multiply_temp_variable = { var = chem_terrain_org_damage value = chem_ratio }
        multiply_temp_variable = { var = chem_terrain_org_damage value = chem_terrain_ratio }
        add_to_temp_variable = { var = chem_combined_offense value = chem_terrain_offense }
        add_to_temp_variable = { var = chem_combined_breakthrough value = chem_terrain_breakthrough }
        add_to_temp_variable = { var = chem_combined_org_damage value = chem_terrain_org_damage }
    }

    set_temp_variable = { var = chem_terrain_units value = 0 }
    set_temp_variable = { var = chem_terrain_units_off value = num_units_offensive_combats_against@hills }
    add_to_temp_variable = { var = chem_terrain_units value = chem_terrain_units_off }
    set_temp_variable = { var = chem_terrain_units_def value = num_units_defensive_combats_on@hills }
    add_to_temp_variable = { var = chem_terrain_units value = chem_terrain_units_def }
    set_temp_variable = { var = chem_terrain_units_off value = num_units_offensive_combats_against@mountain }
    add_to_temp_variable = { var = chem_terrain_units value = chem_terrain_units_off }
    set_temp_variable = { var = chem_terrain_units_def value = num_units_defensive_combats_on@mountain }
    add_to_temp_variable = { var = chem_terrain_units value = chem_terrain_units_def }
    if = {
        limit = { check_variable = { var = chem_terrain_units value = 0 compare = greater_than } }
        set_temp_variable = { var = chem_terrain_ratio value = chem_terrain_units }
        divide_temp_variable = { var = chem_terrain_ratio value = chem_total_combat_units }
        set_temp_variable = { var = chem_terrain_breakthrough value = @CHEM_TERRAIN_HILLS_BREAKTHROUGH }
        multiply_temp_variable = { var = chem_terrain_breakthrough value = chem_ratio }
        multiply_temp_variable = { var = chem_terrain_breakthrough value = chem_terrain_ratio }
        set_temp_variable = { var = chem_terrain_org_damage value = @CHEM_TERRAIN_HILLS_ORG_DAMAGE }
        multiply_temp_variable = { var = chem_terrain_org_damage value = chem_ratio }
        multiply_temp_variable = { var = chem_terrain_org_damage value = chem_terrain_ratio }
        add_to_temp_variable = { var = chem_combined_breakthrough value = chem_terrain_breakthrough }
        add_to_temp_variable = { var = chem_combined_org_damage value = chem_terrain_org_damage }
    }

    set_temp_variable = { var = chem_terrain_units value = 0 }
    set_temp_variable = { var = chem_terrain_units_off value = num_units_offensive_combats_against@urban }
    add_to_temp_variable = { var = chem_terrain_units value = chem_terrain_units_off }
    set_temp_variable = { var = chem_terrain_units_def value = num_units_defensive_combats_on@urban }
    add_to_temp_variable = { var = chem_terrain_units value = chem_terrain_units_def }
    if = {
        limit = { check_variable = { var = chem_terrain_units value = 0 compare = greater_than } }
        set_temp_variable = { var = chem_terrain_ratio value = chem_terrain_units }
        divide_temp_variable = { var = chem_terrain_ratio value = chem_total_combat_units }
        set_temp_variable = { var = chem_terrain_org_damage value = @CHEM_TERRAIN_URBAN_ORG_DAMAGE }
        multiply_temp_variable = { var = chem_terrain_org_damage value = chem_ratio }
        multiply_temp_variable = { var = chem_terrain_org_damage value = chem_terrain_ratio }
        set_temp_variable = { var = chem_terrain_str_damage value = @CHEM_TERRAIN_URBAN_STR_DAMAGE }
        multiply_temp_variable = { var = chem_terrain_str_damage value = chem_ratio }
        multiply_temp_variable = { var = chem_terrain_str_damage value = chem_terrain_ratio }
        add_to_temp_variable = { var = chem_combined_org_damage value = chem_terrain_org_damage }
        add_to_temp_variable = { var = chem_combined_str_damage value = chem_terrain_str_damage }
    }

    set_temp_variable = { var = chem_terrain_units value = 0 }
    set_temp_variable = { var = chem_terrain_units_off value = num_units_offensive_combats_against@marsh }
    add_to_temp_variable = { var = chem_terrain_units value = chem_terrain_units_off }
    set_temp_variable = { var = chem_terrain_units_def value = num_units_defensive_combats_on@marsh }
    add_to_temp_variable = { var = chem_terrain_units value = chem_terrain_units_def }
    if = {
        limit = { check_variable = { var = chem_terrain_units value = 0 compare = greater_than } }
        set_temp_variable = { var = chem_terrain_ratio value = chem_terrain_units }
        divide_temp_variable = { var = chem_terrain_ratio value = chem_total_combat_units }
        set_temp_variable = { var = chem_terrain_breakthrough value = @CHEM_TERRAIN_MARSH_BREAKTHROUGH }
        multiply_temp_variable = { var = chem_terrain_breakthrough value = chem_ratio }
        multiply_temp_variable = { var = chem_terrain_breakthrough value = chem_terrain_ratio }
        set_temp_variable = { var = chem_terrain_org_damage value = @CHEM_TERRAIN_MARSH_ORG_DAMAGE }
        multiply_temp_variable = { var = chem_terrain_org_damage value = chem_ratio }
        multiply_temp_variable = { var = chem_terrain_org_damage value = chem_terrain_ratio }
        add_to_temp_variable = { var = chem_combined_breakthrough value = chem_terrain_breakthrough }
        add_to_temp_variable = { var = chem_combined_org_damage value = chem_terrain_org_damage }
    }
}

chem_apply_combined_weather_terrain_penalties = {
    if = {
        limit = { has_unit_leader_flag = chem_ability_calculating }
        add_to_temp_variable = { var = chem_offense value = chem_combined_offense }
        add_to_temp_variable = { var = chem_breakthrough value = chem_combined_breakthrough }
        add_to_temp_variable = { var = chem_org_damage value = chem_combined_org_damage }
        add_to_temp_variable = { var = chem_str_damage value = chem_combined_str_damage }
    }
}


@CHEM_MASK_REDUCTION_BASIC = 0.25
@CHEM_MASK_REDUCTION_IMPROVED = 0.5
@CHEM_MASK_REDUCTION_ADVANCED = 0.75

chem_apply_mask_mitigation = {
    if = {
        limit = { has_unit_leader_flag = chem_ability_calculating }
        set_temp_variable = { var = chem_mask_org value = 0 }
        set_temp_variable = { var = chem_mask_str value = 0 }
        if = {
            limit = { OWNER = { has_tech = advanced_gas_masks } }
            set_temp_variable = { var = chem_mask_org value = chem_org_damage }
            multiply_temp_variable = { var = chem_mask_org value = @CHEM_MASK_REDUCTION_ADVANCED }
            multiply_temp_variable = { var = chem_mask_org value = -1 }
            set_temp_variable = { var = chem_mask_str value = chem_str_damage }
            multiply_temp_variable = { var = chem_mask_str value = @CHEM_MASK_REDUCTION_ADVANCED }
            multiply_temp_variable = { var = chem_mask_str value = -1 }
        }
        else_if = {
            limit = { OWNER = { has_tech = improved_gas_masks } }
            set_temp_variable = { var = chem_mask_org value = chem_org_damage }
            multiply_temp_variable = { var = chem_mask_org value = @CHEM_MASK_REDUCTION_IMPROVED }
            multiply_temp_variable = { var = chem_mask_org value = -1 }
            set_temp_variable = { var = chem_mask_str value = chem_str_damage }
            multiply_temp_variable = { var = chem_mask_str value = @CHEM_MASK_REDUCTION_IMPROVED }
            multiply_temp_variable = { var = chem_mask_str value = -1 }
        }
        else_if = {
            limit = { OWNER = { has_tech = basic_gas_masks } }
            set_temp_variable = { var = chem_mask_org value = chem_org_damage }
            multiply_temp_variable = { var = chem_mask_org value = @CHEM_MASK_REDUCTION_BASIC }
            multiply_temp_variable = { var = chem_mask_org value = -1 }
            set_temp_variable = { var = chem_mask_str value = chem_str_damage }
            multiply_temp_variable = { var = chem_mask_str value = @CHEM_MASK_REDUCTION_BASIC }
            multiply_temp_variable = { var = chem_mask_str value = -1 }
        }
        add_to_temp_variable = { var = chem_org_damage value = chem_mask_org }
        add_to_temp_variable = { var = chem_str_damage value = chem_mask_str }
    }
}

chem_consume_chlorine_cylinders = {
    set_temp_variable = { var = chem_required_amount value = num_battalions }
    multiply_temp_variable = { var = chem_required_amount value = @CHEM_PREVIEW_CHLORINE_CYLINDERS_PER_BATTALION }
    set_temp_variable = { var = chem_total_available value = 0 }
    OWNER = {
        set_temp_variable = { var = chem_total_available value = num_equipment@chemical_chlorine_payload_cylinder_1 }
        add_to_temp_variable = { var = chem_total_available value = num_equipment@chemical_chlorine_payload_cylinder }
    }
    set_temp_variable = { var = chem_consume_scale value = 0 }
    if = {
        limit = { check_variable = { var = chem_required_amount value = 0 compare = greater_than } }
        set_temp_variable = { var = chem_consume_scale value = chem_total_available }
        divide_temp_variable = { var = chem_consume_scale value = chem_required_amount }
        clamp_temp_variable = { var = chem_consume_scale min = 0 max = 1 }
    }
    set_temp_variable = { var = chem_to_consume value = chem_required_amount }
    multiply_temp_variable = { var = chem_to_consume value = chem_consume_scale }
    round_temp_variable = chem_to_consume
    set_temp_variable = { var = chem_consumed_amount value = chem_to_consume }

    if = {
        limit = { check_variable = { var = chem_to_consume value = chem_total_available compare = greater_than } }
        set_temp_variable = { var = chem_to_consume value = chem_total_available }
        set_temp_variable = { var = chem_consumed_amount value = chem_total_available }
    }
    if = {
        limit = { check_variable = { var = chem_to_consume value = 0 compare = greater_than } }
        set_temp_variable = { var = chem_remaining value = chem_to_consume }
        set_temp_variable = { var = chem_consume_upgrade value = chem_remaining }
        set_temp_variable = { var = chem_available_upgrade value = 0 }
        OWNER = { set_temp_variable = { var = chem_available_upgrade value = num_equipment@chemical_chlorine_payload_cylinder_1 } }
        if = {
            limit = { check_variable = { var = chem_consume_upgrade value = chem_available_upgrade compare = greater_than } }
            set_temp_variable = { var = chem_consume_upgrade value = chem_available_upgrade }
        }
        set_temp_variable = { var = chem_consume_upgrade_amount value = chem_consume_upgrade }
        multiply_temp_variable = { var = chem_consume_upgrade_amount value = -1 }
        if = {
            limit = { check_variable = { var = chem_consume_upgrade value = 0 compare = greater_than } }
            OWNER = {
                add_equipment_to_stockpile = {
                    type = chemical_chlorine_payload_cylinder_1
                    amount = chem_consume_upgrade_amount
                }
            }
        }
        set_temp_variable = { var = chem_consume_upgrade_neg value = chem_consume_upgrade }
        multiply_temp_variable = { var = chem_consume_upgrade_neg value = -1 }
        add_to_temp_variable = { var = chem_remaining value = chem_consume_upgrade_neg }
        set_temp_variable = { var = chem_consume_base value = chem_remaining }
        set_temp_variable = { var = chem_available_base value = 0 }
        OWNER = { set_temp_variable = { var = chem_available_base value = num_equipment@chemical_chlorine_payload_cylinder } }
        if = {
            limit = { check_variable = { var = chem_consume_base value = chem_available_base compare = greater_than } }
            set_temp_variable = { var = chem_consume_base value = chem_available_base }
        }
        set_temp_variable = { var = chem_consume_base_amount value = chem_consume_base }
        multiply_temp_variable = { var = chem_consume_base_amount value = -1 }
        if = {
            limit = { check_variable = { var = chem_consume_base value = 0 compare = greater_than } }
            OWNER = {
                add_equipment_to_stockpile = {
                    type = chemical_chlorine_payload_cylinder
                    amount = chem_consume_base_amount
                }
            }
        }
    }
    set_temp_variable = { var = chem_available_after value = chem_total_available }
    set_temp_variable = { var = chem_consumed_amount_neg value = chem_consumed_amount }
    multiply_temp_variable = { var = chem_consumed_amount_neg value = -1 }
    add_to_temp_variable = { var = chem_available_after value = chem_consumed_amount_neg }
    if = {
        limit = { check_variable = { var = chem_available_after value = 0 compare = less_than } }
        set_temp_variable = { var = chem_available_after value = 0 }
    }
    set_temp_variable = { var = chem_ratio_after value = 0 }
    if = {
        limit = { check_variable = { var = chem_required_amount value = 0 compare = greater_than } }
        set_temp_variable = { var = chem_ratio_after value = chem_available_after }
        divide_temp_variable = { var = chem_ratio_after value = chem_required_amount }
        clamp_temp_variable = { var = chem_ratio_after min = 0 max = 1 }
    }
    set_variable = { var = chem_available_chlorine value = chem_available_after }
    set_variable = { var = chem_ratio_loc_chlorine value = chem_ratio_after }
    OWNER = {
        set_variable = { var = chem_available_chlorine value = chem_available_after }
        set_variable = { var = chem_ratio_loc_chlorine value = chem_ratio_after }
    }
}

chem_consume_phosgene_cylinders = {
    set_temp_variable = { var = chem_required_amount value = num_battalions }
    multiply_temp_variable = { var = chem_required_amount value = @CHEM_PREVIEW_PHOSGENE_CYLINDERS_PER_BATTALION }
    set_temp_variable = { var = chem_total_available value = 0 }
    OWNER = {
        set_temp_variable = { var = chem_total_available value = num_equipment@chemical_phosgene_payload_cylinder_1 }
        add_to_temp_variable = { var = chem_total_available value = num_equipment@chemical_phosgene_payload_cylinder }
    }
    set_temp_variable = { var = chem_consume_scale value = 0 }
    if = {
        limit = { check_variable = { var = chem_required_amount value = 0 compare = greater_than } }
        set_temp_variable = { var = chem_consume_scale value = chem_total_available }
        divide_temp_variable = { var = chem_consume_scale value = chem_required_amount }
        clamp_temp_variable = { var = chem_consume_scale min = 0 max = 1 }
    }
    set_temp_variable = { var = chem_to_consume value = chem_required_amount }
    multiply_temp_variable = { var = chem_to_consume value = chem_consume_scale }
    round_temp_variable = chem_to_consume
    set_temp_variable = { var = chem_consumed_amount value = chem_to_consume }

    if = {
        limit = { check_variable = { var = chem_to_consume value = chem_total_available compare = greater_than } }
        set_temp_variable = { var = chem_to_consume value = chem_total_available }
        set_temp_variable = { var = chem_consumed_amount value = chem_total_available }
    }
    if = {
        limit = { check_variable = { var = chem_to_consume value = 0 compare = greater_than } }
        set_temp_variable = { var = chem_remaining value = chem_to_consume }
        set_temp_variable = { var = chem_consume_upgrade value = chem_remaining }
        set_temp_variable = { var = chem_available_upgrade value = 0 }
        OWNER = { set_temp_variable = { var = chem_available_upgrade value = num_equipment@chemical_phosgene_payload_cylinder_1 } }
        if = {
            limit = { check_variable = { var = chem_consume_upgrade value = chem_available_upgrade compare = greater_than } }
            set_temp_variable = { var = chem_consume_upgrade value = chem_available_upgrade }
        }
        set_temp_variable = { var = chem_consume_upgrade_amount value = chem_consume_upgrade }
        multiply_temp_variable = { var = chem_consume_upgrade_amount value = -1 }
        if = {
            limit = { check_variable = { var = chem_consume_upgrade value = 0 compare = greater_than } }
            OWNER = {
                add_equipment_to_stockpile = {
                    type = chemical_phosgene_payload_cylinder_1
                    amount = chem_consume_upgrade_amount
                }
            }
        }
        set_temp_variable = { var = chem_consume_upgrade_neg value = chem_consume_upgrade }
        multiply_temp_variable = { var = chem_consume_upgrade_neg value = -1 }
        add_to_temp_variable = { var = chem_remaining value = chem_consume_upgrade_neg }
        set_temp_variable = { var = chem_consume_base value = chem_remaining }
        set_temp_variable = { var = chem_available_base value = 0 }
        OWNER = { set_temp_variable = { var = chem_available_base value = num_equipment@chemical_phosgene_payload_cylinder } }
        if = {
            limit = { check_variable = { var = chem_consume_base value = chem_available_base compare = greater_than } }
            set_temp_variable = { var = chem_consume_base value = chem_available_base }
        }
        set_temp_variable = { var = chem_consume_base_amount value = chem_consume_base }
        multiply_temp_variable = { var = chem_consume_base_amount value = -1 }
        if = {
            limit = { check_variable = { var = chem_consume_base value = 0 compare = greater_than } }
            OWNER = {
                add_equipment_to_stockpile = {
                    type = chemical_phosgene_payload_cylinder
                    amount = chem_consume_base_amount
                }
            }
        }
    }
    set_temp_variable = { var = chem_available_after value = chem_total_available }
    set_temp_variable = { var = chem_consumed_amount_neg value = chem_consumed_amount }
    multiply_temp_variable = { var = chem_consumed_amount_neg value = -1 }
    add_to_temp_variable = { var = chem_available_after value = chem_consumed_amount_neg }
    if = {
        limit = { check_variable = { var = chem_available_after value = 0 compare = less_than } }
        set_temp_variable = { var = chem_available_after value = 0 }
    }
    set_temp_variable = { var = chem_ratio_after value = 0 }
    if = {
        limit = { check_variable = { var = chem_required_amount value = 0 compare = greater_than } }
        set_temp_variable = { var = chem_ratio_after value = chem_available_after }
        divide_temp_variable = { var = chem_ratio_after value = chem_required_amount }
        clamp_temp_variable = { var = chem_ratio_after min = 0 max = 1 }
    }
    set_variable = { var = chem_available_phosgene value = chem_available_after }
    set_variable = { var = chem_ratio_loc_phosgene value = chem_ratio_after }
    OWNER = {
        set_variable = { var = chem_available_phosgene value = chem_available_after }
        set_variable = { var = chem_ratio_loc_phosgene value = chem_ratio_after }
    }
}

chem_consume_mustard_cylinders = {
    set_temp_variable = { var = chem_required_amount value = num_battalions }
    multiply_temp_variable = { var = chem_required_amount value = @CHEM_PREVIEW_MUSTARD_CYLINDERS_PER_BATTALION }
    set_temp_variable = { var = chem_total_available value = 0 }
    OWNER = {
        set_temp_variable = { var = chem_total_available value = num_equipment@chemical_mustard_payload_cylinder_1 }
        add_to_temp_variable = { var = chem_total_available value = num_equipment@chemical_mustard_payload_cylinder }
    }
    set_temp_variable = { var = chem_consume_scale value = 0 }
    if = {
        limit = { check_variable = { var = chem_required_amount value = 0 compare = greater_than } }
        set_temp_variable = { var = chem_consume_scale value = chem_total_available }
        divide_temp_variable = { var = chem_consume_scale value = chem_required_amount }
        clamp_temp_variable = { var = chem_consume_scale min = 0 max = 1 }
    }
    set_temp_variable = { var = chem_to_consume value = chem_required_amount }
    multiply_temp_variable = { var = chem_to_consume value = chem_consume_scale }
    round_temp_variable = chem_to_consume
    set_temp_variable = { var = chem_consumed_amount value = chem_to_consume }

    if = {
        limit = { check_variable = { var = chem_to_consume value = chem_total_available compare = greater_than } }
        set_temp_variable = { var = chem_to_consume value = chem_total_available }
        set_temp_variable = { var = chem_consumed_amount value = chem_total_available }
    }
    if = {
        limit = { check_variable = { var = chem_to_consume value = 0 compare = greater_than } }
        set_temp_variable = { var = chem_remaining value = chem_to_consume }
        set_temp_variable = { var = chem_consume_upgrade value = chem_remaining }
        set_temp_variable = { var = chem_available_upgrade value = 0 }
        OWNER = { set_temp_variable = { var = chem_available_upgrade value = num_equipment@chemical_mustard_payload_cylinder_1 } }
        if = {
            limit = { check_variable = { var = chem_consume_upgrade value = chem_available_upgrade compare = greater_than } }
            set_temp_variable = { var = chem_consume_upgrade value = chem_available_upgrade }
        }
        set_temp_variable = { var = chem_consume_upgrade_amount value = chem_consume_upgrade }
        multiply_temp_variable = { var = chem_consume_upgrade_amount value = -1 }
        if = {
            limit = { check_variable = { var = chem_consume_upgrade value = 0 compare = greater_than } }
            OWNER = {
                add_equipment_to_stockpile = {
                    type = chemical_mustard_payload_cylinder_1
                    amount = chem_consume_upgrade_amount
                }
            }
        }
        set_temp_variable = { var = chem_consume_upgrade_neg value = chem_consume_upgrade }
        multiply_temp_variable = { var = chem_consume_upgrade_neg value = -1 }
        add_to_temp_variable = { var = chem_remaining value = chem_consume_upgrade_neg }
        set_temp_variable = { var = chem_consume_base value = chem_remaining }
        set_temp_variable = { var = chem_available_base value = 0 }
        OWNER = { set_temp_variable = { var = chem_available_base value = num_equipment@chemical_mustard_payload_cylinder } }
        if = {
            limit = { check_variable = { var = chem_consume_base value = chem_available_base compare = greater_than } }
            set_temp_variable = { var = chem_consume_base value = chem_available_base }
        }
        set_temp_variable = { var = chem_consume_base_amount value = chem_consume_base }
        multiply_temp_variable = { var = chem_consume_base_amount value = -1 }
        if = {
            limit = { check_variable = { var = chem_consume_base value = 0 compare = greater_than } }
            OWNER = {
                add_equipment_to_stockpile = {
                    type = chemical_mustard_payload_cylinder
                    amount = chem_consume_base_amount
                }
            }
        }
    }
    set_temp_variable = { var = chem_available_after value = chem_total_available }
    set_temp_variable = { var = chem_consumed_amount_neg value = chem_consumed_amount }
    multiply_temp_variable = { var = chem_consumed_amount_neg value = -1 }
    add_to_temp_variable = { var = chem_available_after value = chem_consumed_amount_neg }
    if = {
        limit = { check_variable = { var = chem_available_after value = 0 compare = less_than } }
        set_temp_variable = { var = chem_available_after value = 0 }
    }
    set_temp_variable = { var = chem_ratio_after value = 0 }
    if = {
        limit = { check_variable = { var = chem_required_amount value = 0 compare = greater_than } }
        set_temp_variable = { var = chem_ratio_after value = chem_available_after }
        divide_temp_variable = { var = chem_ratio_after value = chem_required_amount }
        clamp_temp_variable = { var = chem_ratio_after min = 0 max = 1 }
    }
    set_variable = { var = chem_available_mustard value = chem_available_after }
    set_variable = { var = chem_ratio_loc_mustard value = chem_ratio_after }
    OWNER = {
        set_variable = { var = chem_available_mustard value = chem_available_after }
        set_variable = { var = chem_ratio_loc_mustard value = chem_ratio_after }
    }
}

chem_consume_lewisite_cylinders = {
    set_temp_variable = { var = chem_required_amount value = num_battalions }
    multiply_temp_variable = { var = chem_required_amount value = @CHEM_PREVIEW_LEWISITE_CYLINDERS_PER_BATTALION }
    set_temp_variable = { var = chem_total_available value = 0 }
    OWNER = {
        set_temp_variable = { var = chem_total_available value = num_equipment@chemical_lewisite_payload_cylinder_1 }
        add_to_temp_variable = { var = chem_total_available value = num_equipment@chemical_lewisite_payload_cylinder }
    }
    set_temp_variable = { var = chem_consume_scale value = 0 }
    if = {
        limit = { check_variable = { var = chem_required_amount value = 0 compare = greater_than } }
        set_temp_variable = { var = chem_consume_scale value = chem_total_available }
        divide_temp_variable = { var = chem_consume_scale value = chem_required_amount }
        clamp_temp_variable = { var = chem_consume_scale min = 0 max = 1 }
    }
    set_temp_variable = { var = chem_to_consume value = chem_required_amount }
    multiply_temp_variable = { var = chem_to_consume value = chem_consume_scale }
    round_temp_variable = chem_to_consume
    set_temp_variable = { var = chem_consumed_amount value = chem_to_consume }

    if = {
        limit = { check_variable = { var = chem_to_consume value = chem_total_available compare = greater_than } }
        set_temp_variable = { var = chem_to_consume value = chem_total_available }
        set_temp_variable = { var = chem_consumed_amount value = chem_total_available }
    }
    if = {
        limit = { check_variable = { var = chem_to_consume value = 0 compare = greater_than } }
        set_temp_variable = { var = chem_remaining value = chem_to_consume }
        set_temp_variable = { var = chem_consume_upgrade value = chem_remaining }
        set_temp_variable = { var = chem_available_upgrade value = 0 }
        OWNER = { set_temp_variable = { var = chem_available_upgrade value = num_equipment@chemical_lewisite_payload_cylinder_1 } }
        if = {
            limit = { check_variable = { var = chem_consume_upgrade value = chem_available_upgrade compare = greater_than } }
            set_temp_variable = { var = chem_consume_upgrade value = chem_available_upgrade }
        }
        set_temp_variable = { var = chem_consume_upgrade_amount value = chem_consume_upgrade }
        multiply_temp_variable = { var = chem_consume_upgrade_amount value = -1 }
        if = {
            limit = { check_variable = { var = chem_consume_upgrade value = 0 compare = greater_than } }
            OWNER = {
                add_equipment_to_stockpile = {
                    type = chemical_lewisite_payload_cylinder_1
                    amount = chem_consume_upgrade_amount
                }
            }
        }
        set_temp_variable = { var = chem_consume_upgrade_neg value = chem_consume_upgrade }
        multiply_temp_variable = { var = chem_consume_upgrade_neg value = -1 }
        add_to_temp_variable = { var = chem_remaining value = chem_consume_upgrade_neg }
        set_temp_variable = { var = chem_consume_base value = chem_remaining }
        set_temp_variable = { var = chem_available_base value = 0 }
        OWNER = { set_temp_variable = { var = chem_available_base value = num_equipment@chemical_lewisite_payload_cylinder } }
        if = {
            limit = { check_variable = { var = chem_consume_base value = chem_available_base compare = greater_than } }
            set_temp_variable = { var = chem_consume_base value = chem_available_base }
        }
        set_temp_variable = { var = chem_consume_base_amount value = chem_consume_base }
        multiply_temp_variable = { var = chem_consume_base_amount value = -1 }
        if = {
            limit = { check_variable = { var = chem_consume_base value = 0 compare = greater_than } }
            OWNER = {
                add_equipment_to_stockpile = {
                    type = chemical_lewisite_payload_cylinder
                    amount = chem_consume_base_amount
                }
            }
        }
    }
    set_temp_variable = { var = chem_available_after value = chem_total_available }
    set_temp_variable = { var = chem_consumed_amount_neg value = chem_consumed_amount }
    multiply_temp_variable = { var = chem_consumed_amount_neg value = -1 }
    add_to_temp_variable = { var = chem_available_after value = chem_consumed_amount_neg }
    if = {
        limit = { check_variable = { var = chem_available_after value = 0 compare = less_than } }
        set_temp_variable = { var = chem_available_after value = 0 }
    }
    set_temp_variable = { var = chem_ratio_after value = 0 }
    if = {
        limit = { check_variable = { var = chem_required_amount value = 0 compare = greater_than } }
        set_temp_variable = { var = chem_ratio_after value = chem_available_after }
        divide_temp_variable = { var = chem_ratio_after value = chem_required_amount }
        clamp_temp_variable = { var = chem_ratio_after min = 0 max = 1 }
    }
    set_variable = { var = chem_available_lewisite value = chem_available_after }
    set_variable = { var = chem_ratio_loc_lewisite value = chem_ratio_after }
    OWNER = {
        set_variable = { var = chem_available_lewisite value = chem_available_after }
        set_variable = { var = chem_ratio_loc_lewisite value = chem_ratio_after }
    }
}


chem_update_cylinder_previews = {
    set_variable = { var = chem_duration_days_preview value = @CHEM_PREVIEW_DURATION_DAYS }
    FROM = { set_variable = { var = chem_duration_days_preview value = @CHEM_PREVIEW_DURATION_DAYS } }
    chem_roll_wind_state_weekly = yes
    FROM = { set_variable = { var = chem_wind_state value = ROOT.chem_wind_state } }
    if = {
        limit = { FROM = { has_tech = chlorine_gas } }
        chem_update_chlorine_preview = yes
    }
    else = {
        set_variable = { var = chem_required_chlorine value = 0 }
        set_variable = { var = chem_available_chlorine value = 0 }
        set_variable = { var = chem_ratio_loc_chlorine value = 0 }
        set_variable = { var = chem_offense_chlorine value = 0 }
        set_variable = { var = chem_breakthrough_chlorine value = 0 }
        set_variable = { var = chem_defense_chlorine value = 0 }
        set_variable = { var = chem_org_damage_chlorine value = 0 }
        set_variable = { var = chem_str_damage_chlorine value = 0 }
        set_variable = { var = chem_war_support_chlorine value = 0 }
        set_variable = { var = chem_offense_wind_chlorine value = 0 }
        set_variable = { var = chem_breakthrough_wind_chlorine value = 0 }
        set_variable = { var = chem_defense_wind_chlorine value = 0 }
        set_variable = { var = chem_org_damage_wind_chlorine value = 0 }
        set_variable = { var = chem_str_damage_wind_chlorine value = 0 }
        set_variable = { var = chem_war_support_wind_chlorine value = 0 }
        set_variable = { var = chem_mask_org_chlorine value = 0 }
        set_variable = { var = chem_mask_str_chlorine value = 0 }
        set_variable = { var = chem_offense_total_chlorine value = 0 }
        set_variable = { var = chem_breakthrough_total_chlorine value = 0 }
        set_variable = { var = chem_defense_total_chlorine value = 0 }
        set_variable = { var = chem_org_damage_total_chlorine value = 0 }
        set_variable = { var = chem_str_damage_total_chlorine value = 0 }
        set_variable = { var = chem_war_support_total_chlorine value = 0 }
        set_variable = { var = chem_unit_speed_chlorine value = 0 }
        set_variable = { var = chem_urban_attack_chlorine value = 0 }
        set_variable = { var = chem_unit_speed_total_chlorine value = 0 }
        set_variable = { var = chem_urban_attack_total_chlorine value = 0 }
        set_variable = { var = chem_combined_offense_chlorine value = 0 }
        set_variable = { var = chem_combined_breakthrough_chlorine value = 0 }
        set_variable = { var = chem_combined_org_damage_chlorine value = 0 }
        set_variable = { var = chem_combined_str_damage_chlorine value = 0 }
        FROM = {
            set_variable = { var = chem_required_chlorine value = 0 }
            set_variable = { var = chem_available_chlorine value = 0 }
            set_variable = { var = chem_ratio_loc_chlorine value = 0 }
            set_variable = { var = chem_offense_chlorine value = 0 }
            set_variable = { var = chem_breakthrough_chlorine value = 0 }
            set_variable = { var = chem_defense_chlorine value = 0 }
            set_variable = { var = chem_org_damage_chlorine value = 0 }
            set_variable = { var = chem_str_damage_chlorine value = 0 }
            set_variable = { var = chem_war_support_chlorine value = 0 }
            set_variable = { var = chem_offense_wind_chlorine value = 0 }
            set_variable = { var = chem_breakthrough_wind_chlorine value = 0 }
            set_variable = { var = chem_defense_wind_chlorine value = 0 }
            set_variable = { var = chem_org_damage_wind_chlorine value = 0 }
            set_variable = { var = chem_str_damage_wind_chlorine value = 0 }
            set_variable = { var = chem_war_support_wind_chlorine value = 0 }
            set_variable = { var = chem_mask_org_chlorine value = 0 }
            set_variable = { var = chem_mask_str_chlorine value = 0 }
            set_variable = { var = chem_offense_total_chlorine value = 0 }
            set_variable = { var = chem_breakthrough_total_chlorine value = 0 }
            set_variable = { var = chem_defense_total_chlorine value = 0 }
            set_variable = { var = chem_org_damage_total_chlorine value = 0 }
            set_variable = { var = chem_str_damage_total_chlorine value = 0 }
            set_variable = { var = chem_war_support_total_chlorine value = 0 }
            set_variable = { var = chem_unit_speed_chlorine value = 0 }
            set_variable = { var = chem_urban_attack_chlorine value = 0 }
            set_variable = { var = chem_unit_speed_total_chlorine value = 0 }
            set_variable = { var = chem_urban_attack_total_chlorine value = 0 }
            set_variable = { var = chem_combined_offense_chlorine value = 0 }
            set_variable = { var = chem_combined_breakthrough_chlorine value = 0 }
            set_variable = { var = chem_combined_org_damage_chlorine value = 0 }
            set_variable = { var = chem_combined_str_damage_chlorine value = 0 }
        }
    }
    if = {
        limit = { FROM = { has_tech = phosgene } }
        chem_update_phosgene_preview = yes
    }
    else = {
        set_variable = { var = chem_required_phosgene value = 0 }
        set_variable = { var = chem_available_phosgene value = 0 }
        set_variable = { var = chem_ratio_loc_phosgene value = 0 }
        set_variable = { var = chem_offense_phosgene value = 0 }
        set_variable = { var = chem_breakthrough_phosgene value = 0 }
        set_variable = { var = chem_defense_phosgene value = 0 }
        set_variable = { var = chem_org_damage_phosgene value = 0 }
        set_variable = { var = chem_str_damage_phosgene value = 0 }
        set_variable = { var = chem_war_support_phosgene value = 0 }
        set_variable = { var = chem_offense_wind_phosgene value = 0 }
        set_variable = { var = chem_breakthrough_wind_phosgene value = 0 }
        set_variable = { var = chem_defense_wind_phosgene value = 0 }
        set_variable = { var = chem_org_damage_wind_phosgene value = 0 }
        set_variable = { var = chem_str_damage_wind_phosgene value = 0 }
        set_variable = { var = chem_war_support_wind_phosgene value = 0 }
        set_variable = { var = chem_mask_org_phosgene value = 0 }
        set_variable = { var = chem_mask_str_phosgene value = 0 }
        set_variable = { var = chem_offense_total_phosgene value = 0 }
        set_variable = { var = chem_breakthrough_total_phosgene value = 0 }
        set_variable = { var = chem_defense_total_phosgene value = 0 }
        set_variable = { var = chem_org_damage_total_phosgene value = 0 }
        set_variable = { var = chem_str_damage_total_phosgene value = 0 }
        set_variable = { var = chem_war_support_total_phosgene value = 0 }
        set_variable = { var = chem_unit_speed_phosgene value = 0 }
        set_variable = { var = chem_urban_attack_phosgene value = 0 }
        set_variable = { var = chem_unit_speed_total_phosgene value = 0 }
        set_variable = { var = chem_urban_attack_total_phosgene value = 0 }
        set_variable = { var = chem_combined_offense_phosgene value = 0 }
        set_variable = { var = chem_combined_breakthrough_phosgene value = 0 }
        set_variable = { var = chem_combined_org_damage_phosgene value = 0 }
        set_variable = { var = chem_combined_str_damage_phosgene value = 0 }
        FROM = {
            set_variable = { var = chem_required_phosgene value = 0 }
            set_variable = { var = chem_available_phosgene value = 0 }
            set_variable = { var = chem_ratio_loc_phosgene value = 0 }
            set_variable = { var = chem_offense_phosgene value = 0 }
            set_variable = { var = chem_breakthrough_phosgene value = 0 }
            set_variable = { var = chem_defense_phosgene value = 0 }
            set_variable = { var = chem_org_damage_phosgene value = 0 }
            set_variable = { var = chem_str_damage_phosgene value = 0 }
            set_variable = { var = chem_war_support_phosgene value = 0 }
            set_variable = { var = chem_offense_wind_phosgene value = 0 }
            set_variable = { var = chem_breakthrough_wind_phosgene value = 0 }
            set_variable = { var = chem_defense_wind_phosgene value = 0 }
            set_variable = { var = chem_org_damage_wind_phosgene value = 0 }
            set_variable = { var = chem_str_damage_wind_phosgene value = 0 }
            set_variable = { var = chem_war_support_wind_phosgene value = 0 }
            set_variable = { var = chem_mask_org_phosgene value = 0 }
            set_variable = { var = chem_mask_str_phosgene value = 0 }
            set_variable = { var = chem_offense_total_phosgene value = 0 }
            set_variable = { var = chem_breakthrough_total_phosgene value = 0 }
            set_variable = { var = chem_defense_total_phosgene value = 0 }
            set_variable = { var = chem_org_damage_total_phosgene value = 0 }
            set_variable = { var = chem_str_damage_total_phosgene value = 0 }
            set_variable = { var = chem_war_support_total_phosgene value = 0 }
            set_variable = { var = chem_unit_speed_phosgene value = 0 }
            set_variable = { var = chem_urban_attack_phosgene value = 0 }
            set_variable = { var = chem_unit_speed_total_phosgene value = 0 }
            set_variable = { var = chem_urban_attack_total_phosgene value = 0 }
            set_variable = { var = chem_combined_offense_phosgene value = 0 }
            set_variable = { var = chem_combined_breakthrough_phosgene value = 0 }
            set_variable = { var = chem_combined_org_damage_phosgene value = 0 }
            set_variable = { var = chem_combined_str_damage_phosgene value = 0 }
        }
    }
    if = {
        limit = { FROM = { has_tech = mustard_gas } }
        chem_update_mustard_preview = yes
    }
    else = {
        set_variable = { var = chem_required_mustard value = 0 }
        set_variable = { var = chem_available_mustard value = 0 }
        set_variable = { var = chem_ratio_loc_mustard value = 0 }
        set_variable = { var = chem_offense_mustard value = 0 }
        set_variable = { var = chem_breakthrough_mustard value = 0 }
        set_variable = { var = chem_defense_mustard value = 0 }
        set_variable = { var = chem_org_damage_mustard value = 0 }
        set_variable = { var = chem_str_damage_mustard value = 0 }
        set_variable = { var = chem_war_support_mustard value = 0 }
        set_variable = { var = chem_offense_wind_mustard value = 0 }
        set_variable = { var = chem_breakthrough_wind_mustard value = 0 }
        set_variable = { var = chem_defense_wind_mustard value = 0 }
        set_variable = { var = chem_org_damage_wind_mustard value = 0 }
        set_variable = { var = chem_str_damage_wind_mustard value = 0 }
        set_variable = { var = chem_war_support_wind_mustard value = 0 }
        set_variable = { var = chem_mask_org_mustard value = 0 }
        set_variable = { var = chem_mask_str_mustard value = 0 }
        set_variable = { var = chem_offense_total_mustard value = 0 }
        set_variable = { var = chem_breakthrough_total_mustard value = 0 }
        set_variable = { var = chem_defense_total_mustard value = 0 }
        set_variable = { var = chem_org_damage_total_mustard value = 0 }
        set_variable = { var = chem_str_damage_total_mustard value = 0 }
        set_variable = { var = chem_war_support_total_mustard value = 0 }
        set_variable = { var = chem_unit_speed_mustard value = 0 }
        set_variable = { var = chem_urban_attack_mustard value = 0 }
        set_variable = { var = chem_unit_speed_total_mustard value = 0 }
        set_variable = { var = chem_urban_attack_total_mustard value = 0 }
        set_variable = { var = chem_combined_offense_mustard value = 0 }
        set_variable = { var = chem_combined_breakthrough_mustard value = 0 }
        set_variable = { var = chem_combined_org_damage_mustard value = 0 }
        set_variable = { var = chem_combined_str_damage_mustard value = 0 }
        FROM = {
            set_variable = { var = chem_required_mustard value = 0 }
            set_variable = { var = chem_available_mustard value = 0 }
            set_variable = { var = chem_ratio_loc_mustard value = 0 }
            set_variable = { var = chem_offense_mustard value = 0 }
            set_variable = { var = chem_breakthrough_mustard value = 0 }
            set_variable = { var = chem_defense_mustard value = 0 }
            set_variable = { var = chem_org_damage_mustard value = 0 }
            set_variable = { var = chem_str_damage_mustard value = 0 }
            set_variable = { var = chem_war_support_mustard value = 0 }
            set_variable = { var = chem_offense_wind_mustard value = 0 }
            set_variable = { var = chem_breakthrough_wind_mustard value = 0 }
            set_variable = { var = chem_defense_wind_mustard value = 0 }
            set_variable = { var = chem_org_damage_wind_mustard value = 0 }
            set_variable = { var = chem_str_damage_wind_mustard value = 0 }
            set_variable = { var = chem_war_support_wind_mustard value = 0 }
            set_variable = { var = chem_mask_org_mustard value = 0 }
            set_variable = { var = chem_mask_str_mustard value = 0 }
            set_variable = { var = chem_offense_total_mustard value = 0 }
            set_variable = { var = chem_breakthrough_total_mustard value = 0 }
            set_variable = { var = chem_defense_total_mustard value = 0 }
            set_variable = { var = chem_org_damage_total_mustard value = 0 }
            set_variable = { var = chem_str_damage_total_mustard value = 0 }
            set_variable = { var = chem_war_support_total_mustard value = 0 }
            set_variable = { var = chem_unit_speed_mustard value = 0 }
            set_variable = { var = chem_urban_attack_mustard value = 0 }
            set_variable = { var = chem_unit_speed_total_mustard value = 0 }
            set_variable = { var = chem_urban_attack_total_mustard value = 0 }
            set_variable = { var = chem_combined_offense_mustard value = 0 }
            set_variable = { var = chem_combined_breakthrough_mustard value = 0 }
            set_variable = { var = chem_combined_org_damage_mustard value = 0 }
            set_variable = { var = chem_combined_str_damage_mustard value = 0 }
        }
    }
    if = {
        limit = { FROM = { has_tech = lewisite } }
        chem_update_lewisite_preview = yes
    }
    else = {
        set_variable = { var = chem_required_lewisite value = 0 }
        set_variable = { var = chem_available_lewisite value = 0 }
        set_variable = { var = chem_ratio_loc_lewisite value = 0 }
        set_variable = { var = chem_offense_lewisite value = 0 }
        set_variable = { var = chem_breakthrough_lewisite value = 0 }
        set_variable = { var = chem_defense_lewisite value = 0 }
        set_variable = { var = chem_org_damage_lewisite value = 0 }
        set_variable = { var = chem_str_damage_lewisite value = 0 }
        set_variable = { var = chem_war_support_lewisite value = 0 }
        set_variable = { var = chem_offense_wind_lewisite value = 0 }
        set_variable = { var = chem_breakthrough_wind_lewisite value = 0 }
        set_variable = { var = chem_defense_wind_lewisite value = 0 }
        set_variable = { var = chem_org_damage_wind_lewisite value = 0 }
        set_variable = { var = chem_str_damage_wind_lewisite value = 0 }
        set_variable = { var = chem_war_support_wind_lewisite value = 0 }
        set_variable = { var = chem_mask_org_lewisite value = 0 }
        set_variable = { var = chem_mask_str_lewisite value = 0 }
        set_variable = { var = chem_offense_total_lewisite value = 0 }
        set_variable = { var = chem_breakthrough_total_lewisite value = 0 }
        set_variable = { var = chem_defense_total_lewisite value = 0 }
        set_variable = { var = chem_org_damage_total_lewisite value = 0 }
        set_variable = { var = chem_str_damage_total_lewisite value = 0 }
        set_variable = { var = chem_war_support_total_lewisite value = 0 }
        set_variable = { var = chem_unit_speed_lewisite value = 0 }
        set_variable = { var = chem_urban_attack_lewisite value = 0 }
        set_variable = { var = chem_unit_speed_total_lewisite value = 0 }
        set_variable = { var = chem_urban_attack_total_lewisite value = 0 }
        set_variable = { var = chem_combined_offense_lewisite value = 0 }
        set_variable = { var = chem_combined_breakthrough_lewisite value = 0 }
        set_variable = { var = chem_combined_org_damage_lewisite value = 0 }
        set_variable = { var = chem_combined_str_damage_lewisite value = 0 }
        FROM = {
            set_variable = { var = chem_required_lewisite value = 0 }
            set_variable = { var = chem_available_lewisite value = 0 }
            set_variable = { var = chem_ratio_loc_lewisite value = 0 }
            set_variable = { var = chem_offense_lewisite value = 0 }
            set_variable = { var = chem_breakthrough_lewisite value = 0 }
            set_variable = { var = chem_defense_lewisite value = 0 }
            set_variable = { var = chem_org_damage_lewisite value = 0 }
            set_variable = { var = chem_str_damage_lewisite value = 0 }
            set_variable = { var = chem_war_support_lewisite value = 0 }
            set_variable = { var = chem_offense_wind_lewisite value = 0 }
            set_variable = { var = chem_breakthrough_wind_lewisite value = 0 }
            set_variable = { var = chem_defense_wind_lewisite value = 0 }
            set_variable = { var = chem_org_damage_wind_lewisite value = 0 }
            set_variable = { var = chem_str_damage_wind_lewisite value = 0 }
            set_variable = { var = chem_war_support_wind_lewisite value = 0 }
            set_variable = { var = chem_mask_org_lewisite value = 0 }
            set_variable = { var = chem_mask_str_lewisite value = 0 }
            set_variable = { var = chem_offense_total_lewisite value = 0 }
            set_variable = { var = chem_breakthrough_total_lewisite value = 0 }
            set_variable = { var = chem_defense_total_lewisite value = 0 }
            set_variable = { var = chem_org_damage_total_lewisite value = 0 }
            set_variable = { var = chem_str_damage_total_lewisite value = 0 }
            set_variable = { var = chem_war_support_total_lewisite value = 0 }
            set_variable = { var = chem_unit_speed_lewisite value = 0 }
            set_variable = { var = chem_urban_attack_lewisite value = 0 }
            set_variable = { var = chem_unit_speed_total_lewisite value = 0 }
            set_variable = { var = chem_urban_attack_total_lewisite value = 0 }
            set_variable = { var = chem_combined_offense_lewisite value = 0 }
            set_variable = { var = chem_combined_breakthrough_lewisite value = 0 }
            set_variable = { var = chem_combined_org_damage_lewisite value = 0 }
            set_variable = { var = chem_combined_str_damage_lewisite value = 0 }
        }
    }
}

chem_update_chlorine_preview = {
    set_temp_variable = { var = chem_required value = num_battalions }
    set_temp_variable = { var = chem_available value = 0 }
    OWNER = {
        set_temp_variable = { var = chem_available value = num_equipment@chemical_chlorine_payload_cylinder_1 }
        add_to_temp_variable = { var = chem_available value = num_equipment@chemical_chlorine_payload_cylinder }
        set_variable = { var = chem_available_chlorine value = chem_available }
    }
    set_temp_variable = { var = chem_ratio value = 0 }
    set_temp_variable = { var = chem_ratio_preview value = 0 }
    if = {
        limit = { check_variable = { var = chem_required value = 0 compare = greater_than } }
        multiply_temp_variable = { var = chem_required value = @CHEM_PREVIEW_CHLORINE_CYLINDERS_PER_BATTALION }
        set_variable = { var = chem_required_chlorine value = chem_required }
        set_temp_variable = { var = chem_ratio value = chem_available }
        divide_temp_variable = { var = chem_ratio value = chem_required }
        clamp_temp_variable = { var = chem_ratio min = 0 max = 1 }
        set_variable = { var = chem_ratio_loc_chlorine value = chem_ratio }
        set_temp_variable = { var = chem_ratio_preview value = chem_ratio }
        clamp_temp_variable = { var = chem_ratio_preview min = @CHEM_PREVIEW_RATIO_MIN max = 1 }
        set_temp_variable = { var = chem_offense_preview value = @CHEM_PREVIEW_CHLORINE_OFFENSE }
        multiply_temp_variable = { var = chem_offense_preview value = chem_ratio_preview }
        set_temp_variable = { var = chem_breakthrough_preview value = @CHEM_PREVIEW_CHLORINE_BREAKTHROUGH }
        multiply_temp_variable = { var = chem_breakthrough_preview value = chem_ratio_preview }
        set_temp_variable = { var = chem_defense_preview value = @CHEM_PREVIEW_CHLORINE_DEFENSE }
        multiply_temp_variable = { var = chem_defense_preview value = chem_ratio_preview }
        set_temp_variable = { var = chem_org_damage_preview value = @CHEM_PREVIEW_CHLORINE_ORG_DAMAGE }
        multiply_temp_variable = { var = chem_org_damage_preview value = chem_ratio_preview }
        set_temp_variable = { var = chem_str_damage_preview value = @CHEM_PREVIEW_CHLORINE_STR_DAMAGE }
        multiply_temp_variable = { var = chem_str_damage_preview value = chem_ratio_preview }
        set_temp_variable = { var = chem_war_support_preview value = @CHEM_PREVIEW_CHLORINE_WAR_SUPPORT }
        multiply_temp_variable = { var = chem_war_support_preview value = chem_ratio_preview }
    }
    else = {
        set_variable = { var = chem_required_chlorine value = 0 }
        set_variable = { var = chem_ratio_loc_chlorine value = 0 }
        set_temp_variable = { var = chem_ratio_preview value = 0 }
        set_temp_variable = { var = chem_offense_preview value = 0 }
        set_temp_variable = { var = chem_breakthrough_preview value = 0 }
        set_temp_variable = { var = chem_defense_preview value = 0 }
        set_temp_variable = { var = chem_org_damage_preview value = 0 }
        set_temp_variable = { var = chem_str_damage_preview value = 0 }
        set_temp_variable = { var = chem_war_support_preview value = 0 }
    }
    set_variable = { var = chem_offense_chlorine value = chem_offense_preview }
    set_variable = { var = chem_breakthrough_chlorine value = chem_breakthrough_preview }
    set_variable = { var = chem_defense_chlorine value = chem_defense_preview }
    set_variable = { var = chem_org_damage_chlorine value = chem_org_damage_preview }
    set_variable = { var = chem_str_damage_chlorine value = chem_str_damage_preview }
    set_variable = { var = chem_war_support_chlorine value = chem_war_support_preview }
    FROM = {
        set_variable = { var = chem_offense_chlorine value = chem_offense_preview }
        set_variable = { var = chem_breakthrough_chlorine value = chem_breakthrough_preview }
        set_variable = { var = chem_defense_chlorine value = chem_defense_preview }
        set_variable = { var = chem_org_damage_chlorine value = chem_org_damage_preview }
        set_variable = { var = chem_str_damage_chlorine value = chem_str_damage_preview }
        set_variable = { var = chem_war_support_chlorine value = chem_war_support_preview }
    }
    set_temp_variable = { var = chem_base_offense_preview value = chem_offense_preview }
    set_temp_variable = { var = chem_base_breakthrough_preview value = chem_breakthrough_preview }
    set_temp_variable = { var = chem_base_defense_preview value = chem_defense_preview }
    set_temp_variable = { var = chem_base_org_damage_preview value = chem_org_damage_preview }
    set_temp_variable = { var = chem_base_str_damage_preview value = chem_str_damage_preview }
    set_temp_variable = { var = chem_base_war_support_preview value = chem_war_support_preview }
    chem_apply_wind_preview_modifiers = yes
    set_temp_variable = { var = chem_offense_wind_delta value = chem_base_offense_preview }
    multiply_temp_variable = { var = chem_offense_wind_delta value = -1 }
    add_to_temp_variable = { var = chem_offense_wind_delta value = chem_offense_preview }
    set_temp_variable = { var = chem_breakthrough_wind_delta value = chem_base_breakthrough_preview }
    multiply_temp_variable = { var = chem_breakthrough_wind_delta value = -1 }
    add_to_temp_variable = { var = chem_breakthrough_wind_delta value = chem_breakthrough_preview }
    set_temp_variable = { var = chem_defense_wind_delta value = chem_base_defense_preview }
    multiply_temp_variable = { var = chem_defense_wind_delta value = -1 }
    add_to_temp_variable = { var = chem_defense_wind_delta value = chem_defense_preview }
    set_temp_variable = { var = chem_org_damage_wind_delta value = chem_base_org_damage_preview }
    multiply_temp_variable = { var = chem_org_damage_wind_delta value = -1 }
    add_to_temp_variable = { var = chem_org_damage_wind_delta value = chem_org_damage_preview }
    set_temp_variable = { var = chem_str_damage_wind_delta value = chem_base_str_damage_preview }
    multiply_temp_variable = { var = chem_str_damage_wind_delta value = -1 }
    add_to_temp_variable = { var = chem_str_damage_wind_delta value = chem_str_damage_preview }
    set_temp_variable = { var = chem_war_support_wind_delta value = chem_base_war_support_preview }
    multiply_temp_variable = { var = chem_war_support_wind_delta value = -1 }
    add_to_temp_variable = { var = chem_war_support_wind_delta value = chem_war_support_preview }
    set_variable = { var = chem_offense_wind_chlorine value = chem_offense_wind_delta }
    set_variable = { var = chem_breakthrough_wind_chlorine value = chem_breakthrough_wind_delta }
    set_variable = { var = chem_defense_wind_chlorine value = chem_defense_wind_delta }
    set_variable = { var = chem_org_damage_wind_chlorine value = chem_org_damage_wind_delta }
    set_variable = { var = chem_str_damage_wind_chlorine value = chem_str_damage_wind_delta }
    set_variable = { var = chem_war_support_wind_chlorine value = chem_war_support_wind_delta }
    FROM = {
        set_variable = { var = chem_offense_wind_chlorine value = chem_offense_wind_delta }
        set_variable = { var = chem_breakthrough_wind_chlorine value = chem_breakthrough_wind_delta }
        set_variable = { var = chem_defense_wind_chlorine value = chem_defense_wind_delta }
        set_variable = { var = chem_org_damage_wind_chlorine value = chem_org_damage_wind_delta }
        set_variable = { var = chem_str_damage_wind_chlorine value = chem_str_damage_wind_delta }
        set_variable = { var = chem_war_support_wind_chlorine value = chem_war_support_wind_delta }
    }
    set_temp_variable = { var = chem_ratio value = chem_ratio_preview }
    chem_prepare_weather_terrain_penalties = yes
    chem_apply_weather_ability_modifiers = yes
    chem_apply_terrain_ability_modifiers = yes
    chem_apply_mask_preview_modifiers = yes
    set_temp_variable = { var = chem_mask_org_display value = chem_mask_org_preview }
    set_temp_variable = { var = chem_mask_str_display value = chem_mask_str_preview }
    set_variable = { var = chem_mask_org_chlorine value = chem_mask_org_display }
    set_variable = { var = chem_mask_str_chlorine value = chem_mask_str_display }
    FROM = {
        set_variable = { var = chem_mask_org_chlorine value = chem_mask_org_display }
        set_variable = { var = chem_mask_str_chlorine value = chem_mask_str_display }
    }
    set_temp_variable = { var = chem_offense_total value = chem_offense_preview }
    add_to_temp_variable = { var = chem_offense_total value = chem_combined_offense }
    set_temp_variable = { var = chem_breakthrough_total value = chem_breakthrough_preview }
    add_to_temp_variable = { var = chem_breakthrough_total value = chem_combined_breakthrough }
    set_temp_variable = { var = chem_defense_total value = chem_defense_preview }
    set_temp_variable = { var = chem_org_damage_total value = chem_org_damage_preview }
    add_to_temp_variable = { var = chem_org_damage_total value = chem_combined_org_damage }
    add_to_temp_variable = { var = chem_org_damage_total value = chem_mask_org_preview }
    set_temp_variable = { var = chem_str_damage_total value = chem_str_damage_preview }
    add_to_temp_variable = { var = chem_str_damage_total value = chem_combined_str_damage }
    add_to_temp_variable = { var = chem_str_damage_total value = chem_mask_str_preview }
    set_temp_variable = { var = chem_war_support_total value = chem_war_support_preview }
    set_variable = { var = chem_available_chlorine value = chem_available }
    set_variable = { var = chem_combined_offense_chlorine value = chem_combined_offense }
    set_variable = { var = chem_combined_breakthrough_chlorine value = chem_combined_breakthrough }
    set_variable = { var = chem_combined_org_damage_chlorine value = chem_combined_org_damage }
    set_variable = { var = chem_combined_str_damage_chlorine value = chem_combined_str_damage }
    set_variable = { var = chem_offense_total_chlorine value = chem_offense_total }
    set_variable = { var = chem_breakthrough_total_chlorine value = chem_breakthrough_total }
    set_variable = { var = chem_defense_total_chlorine value = chem_defense_total }
    set_variable = { var = chem_org_damage_total_chlorine value = chem_org_damage_total }
    set_variable = { var = chem_str_damage_total_chlorine value = chem_str_damage_total }
    set_variable = { var = chem_war_support_total_chlorine value = chem_war_support_total }
    set_variable = { var = chem_unit_speed_chlorine value = @CHEM_UNIT_SPEED_FACTOR }
    set_variable = { var = chem_urban_attack_chlorine value = @CHEM_UNIT_URBAN_ATTACK }
    set_variable = { var = chem_unit_speed_total_chlorine value = @CHEM_UNIT_SPEED_FACTOR }
    set_variable = { var = chem_urban_attack_total_chlorine value = @CHEM_UNIT_URBAN_ATTACK }
    OWNER = {
        set_variable = { var = chem_required_chlorine value = chem_required }
        set_variable = { var = chem_available_chlorine value = chem_available }
        set_variable = { var = chem_ratio_loc_chlorine value = chem_ratio }
        set_variable = { var = chem_combined_offense_chlorine value = chem_combined_offense }
        set_variable = { var = chem_combined_breakthrough_chlorine value = chem_combined_breakthrough }
        set_variable = { var = chem_combined_org_damage_chlorine value = chem_combined_org_damage }
        set_variable = { var = chem_combined_str_damage_chlorine value = chem_combined_str_damage }
        set_variable = { var = chem_offense_total_chlorine value = chem_offense_total }
        set_variable = { var = chem_breakthrough_total_chlorine value = chem_breakthrough_total }
        set_variable = { var = chem_defense_total_chlorine value = chem_defense_total }
        set_variable = { var = chem_org_damage_total_chlorine value = chem_org_damage_total }
        set_variable = { var = chem_str_damage_total_chlorine value = chem_str_damage_total }
        set_variable = { var = chem_war_support_total_chlorine value = chem_war_support_total }
        set_variable = { var = chem_unit_speed_chlorine value = @CHEM_UNIT_SPEED_FACTOR }
        set_variable = { var = chem_urban_attack_chlorine value = @CHEM_UNIT_URBAN_ATTACK }
        set_variable = { var = chem_unit_speed_total_chlorine value = @CHEM_UNIT_SPEED_FACTOR }
        set_variable = { var = chem_urban_attack_total_chlorine value = @CHEM_UNIT_URBAN_ATTACK }
    }
    # log = "CHEM_PREVIEW_CHLORINE battalions=[?chem_required|.0] available=[?chem_available|.0] ratio=[?chem_ratio|.3]"
}

chem_update_phosgene_preview = {
    set_temp_variable = { var = chem_required value = num_battalions }
    set_temp_variable = { var = chem_available value = 0 }
    OWNER = {
        set_temp_variable = { var = chem_available value = num_equipment@chemical_phosgene_payload_cylinder_1 }
        add_to_temp_variable = { var = chem_available value = num_equipment@chemical_phosgene_payload_cylinder }
        set_variable = { var = chem_available_phosgene value = chem_available }
    }
    set_temp_variable = { var = chem_ratio value = 0 }
    set_temp_variable = { var = chem_ratio_preview value = 0 }
    if = {
        limit = { check_variable = { var = chem_required value = 0 compare = greater_than } }
        multiply_temp_variable = { var = chem_required value = @CHEM_PREVIEW_PHOSGENE_CYLINDERS_PER_BATTALION }
        set_variable = { var = chem_required_phosgene value = chem_required }
        set_temp_variable = { var = chem_ratio value = chem_available }
        divide_temp_variable = { var = chem_ratio value = chem_required }
        clamp_temp_variable = { var = chem_ratio min = 0 max = 1 }
        set_variable = { var = chem_ratio_loc_phosgene value = chem_ratio }
        set_temp_variable = { var = chem_ratio_preview value = chem_ratio }
        clamp_temp_variable = { var = chem_ratio_preview min = @CHEM_PREVIEW_RATIO_MIN max = 1 }
        set_temp_variable = { var = chem_offense_preview value = @CHEM_PREVIEW_PHOSGENE_OFFENSE }
        multiply_temp_variable = { var = chem_offense_preview value = chem_ratio_preview }
        set_temp_variable = { var = chem_breakthrough_preview value = @CHEM_PREVIEW_PHOSGENE_BREAKTHROUGH }
        multiply_temp_variable = { var = chem_breakthrough_preview value = chem_ratio_preview }
        set_temp_variable = { var = chem_defense_preview value = @CHEM_PREVIEW_PHOSGENE_DEFENSE }
        multiply_temp_variable = { var = chem_defense_preview value = chem_ratio_preview }
        set_temp_variable = { var = chem_org_damage_preview value = @CHEM_PREVIEW_PHOSGENE_ORG_DAMAGE }
        multiply_temp_variable = { var = chem_org_damage_preview value = chem_ratio_preview }
        set_temp_variable = { var = chem_str_damage_preview value = @CHEM_PREVIEW_PHOSGENE_STR_DAMAGE }
        multiply_temp_variable = { var = chem_str_damage_preview value = chem_ratio_preview }
        set_temp_variable = { var = chem_war_support_preview value = @CHEM_PREVIEW_PHOSGENE_WAR_SUPPORT }
        multiply_temp_variable = { var = chem_war_support_preview value = chem_ratio_preview }
    }
    else = {
        set_variable = { var = chem_required_phosgene value = 0 }
        set_variable = { var = chem_ratio_loc_phosgene value = 0 }
        set_temp_variable = { var = chem_ratio_preview value = 0 }
        set_temp_variable = { var = chem_offense_preview value = 0 }
        set_temp_variable = { var = chem_breakthrough_preview value = 0 }
        set_temp_variable = { var = chem_defense_preview value = 0 }
        set_temp_variable = { var = chem_org_damage_preview value = 0 }
        set_temp_variable = { var = chem_str_damage_preview value = 0 }
        set_temp_variable = { var = chem_war_support_preview value = 0 }
    }
    set_variable = { var = chem_offense_phosgene value = chem_offense_preview }
    set_variable = { var = chem_breakthrough_phosgene value = chem_breakthrough_preview }
    set_variable = { var = chem_defense_phosgene value = chem_defense_preview }
    set_variable = { var = chem_org_damage_phosgene value = chem_org_damage_preview }
    set_variable = { var = chem_str_damage_phosgene value = chem_str_damage_preview }
    set_variable = { var = chem_war_support_phosgene value = chem_war_support_preview }
    FROM = {
        set_variable = { var = chem_offense_phosgene value = chem_offense_preview }
        set_variable = { var = chem_breakthrough_phosgene value = chem_breakthrough_preview }
        set_variable = { var = chem_defense_phosgene value = chem_defense_preview }
        set_variable = { var = chem_org_damage_phosgene value = chem_org_damage_preview }
        set_variable = { var = chem_str_damage_phosgene value = chem_str_damage_preview }
        set_variable = { var = chem_war_support_phosgene value = chem_war_support_preview }
    }
    set_temp_variable = { var = chem_base_offense_preview value = chem_offense_preview }
    set_temp_variable = { var = chem_base_breakthrough_preview value = chem_breakthrough_preview }
    set_temp_variable = { var = chem_base_defense_preview value = chem_defense_preview }
    set_temp_variable = { var = chem_base_org_damage_preview value = chem_org_damage_preview }
    set_temp_variable = { var = chem_base_str_damage_preview value = chem_str_damage_preview }
    set_temp_variable = { var = chem_base_war_support_preview value = chem_war_support_preview }
    chem_apply_wind_preview_modifiers = yes
    set_temp_variable = { var = chem_offense_wind_delta value = chem_base_offense_preview }
    multiply_temp_variable = { var = chem_offense_wind_delta value = -1 }
    add_to_temp_variable = { var = chem_offense_wind_delta value = chem_offense_preview }
    set_temp_variable = { var = chem_breakthrough_wind_delta value = chem_base_breakthrough_preview }
    multiply_temp_variable = { var = chem_breakthrough_wind_delta value = -1 }
    add_to_temp_variable = { var = chem_breakthrough_wind_delta value = chem_breakthrough_preview }
    set_temp_variable = { var = chem_defense_wind_delta value = chem_base_defense_preview }
    multiply_temp_variable = { var = chem_defense_wind_delta value = -1 }
    add_to_temp_variable = { var = chem_defense_wind_delta value = chem_defense_preview }
    set_temp_variable = { var = chem_org_damage_wind_delta value = chem_base_org_damage_preview }
    multiply_temp_variable = { var = chem_org_damage_wind_delta value = -1 }
    add_to_temp_variable = { var = chem_org_damage_wind_delta value = chem_org_damage_preview }
    set_temp_variable = { var = chem_str_damage_wind_delta value = chem_base_str_damage_preview }
    multiply_temp_variable = { var = chem_str_damage_wind_delta value = -1 }
    add_to_temp_variable = { var = chem_str_damage_wind_delta value = chem_str_damage_preview }
    set_temp_variable = { var = chem_war_support_wind_delta value = chem_base_war_support_preview }
    multiply_temp_variable = { var = chem_war_support_wind_delta value = -1 }
    add_to_temp_variable = { var = chem_war_support_wind_delta value = chem_war_support_preview }
    set_variable = { var = chem_offense_wind_phosgene value = chem_offense_wind_delta }
    set_variable = { var = chem_breakthrough_wind_phosgene value = chem_breakthrough_wind_delta }
    set_variable = { var = chem_defense_wind_phosgene value = chem_defense_wind_delta }
    set_variable = { var = chem_org_damage_wind_phosgene value = chem_org_damage_wind_delta }
    set_variable = { var = chem_str_damage_wind_phosgene value = chem_str_damage_wind_delta }
    set_variable = { var = chem_war_support_wind_phosgene value = chem_war_support_wind_delta }
    FROM = {
        set_variable = { var = chem_offense_wind_phosgene value = chem_offense_wind_delta }
        set_variable = { var = chem_breakthrough_wind_phosgene value = chem_breakthrough_wind_delta }
        set_variable = { var = chem_defense_wind_phosgene value = chem_defense_wind_delta }
        set_variable = { var = chem_org_damage_wind_phosgene value = chem_org_damage_wind_delta }
        set_variable = { var = chem_str_damage_wind_phosgene value = chem_str_damage_wind_delta }
        set_variable = { var = chem_war_support_wind_phosgene value = chem_war_support_wind_delta }
    }
    set_temp_variable = { var = chem_ratio value = chem_ratio_preview }
    chem_prepare_weather_terrain_penalties = yes
    chem_apply_weather_ability_modifiers = yes
    chem_apply_terrain_ability_modifiers = yes
    chem_apply_mask_preview_modifiers = yes
    set_temp_variable = { var = chem_mask_org_display value = chem_mask_org_preview }
    set_temp_variable = { var = chem_mask_str_display value = chem_mask_str_preview }
    set_variable = { var = chem_mask_org_phosgene value = chem_mask_org_display }
    set_variable = { var = chem_mask_str_phosgene value = chem_mask_str_display }
    FROM = {
        set_variable = { var = chem_mask_org_phosgene value = chem_mask_org_display }
        set_variable = { var = chem_mask_str_phosgene value = chem_mask_str_display }
    }
    set_temp_variable = { var = chem_offense_total value = chem_offense_preview }
    add_to_temp_variable = { var = chem_offense_total value = chem_combined_offense }
    set_temp_variable = { var = chem_breakthrough_total value = chem_breakthrough_preview }
    add_to_temp_variable = { var = chem_breakthrough_total value = chem_combined_breakthrough }
    set_temp_variable = { var = chem_defense_total value = chem_defense_preview }
    set_temp_variable = { var = chem_org_damage_total value = chem_org_damage_preview }
    add_to_temp_variable = { var = chem_org_damage_total value = chem_combined_org_damage }
    add_to_temp_variable = { var = chem_org_damage_total value = chem_mask_org_preview }
    set_temp_variable = { var = chem_str_damage_total value = chem_str_damage_preview }
    add_to_temp_variable = { var = chem_str_damage_total value = chem_combined_str_damage }
    add_to_temp_variable = { var = chem_str_damage_total value = chem_mask_str_preview }
    set_temp_variable = { var = chem_war_support_total value = chem_war_support_preview }
    set_variable = { var = chem_available_phosgene value = chem_available }
    set_variable = { var = chem_combined_offense_phosgene value = chem_combined_offense }
    set_variable = { var = chem_combined_breakthrough_phosgene value = chem_combined_breakthrough }
    set_variable = { var = chem_combined_org_damage_phosgene value = chem_combined_org_damage }
    set_variable = { var = chem_combined_str_damage_phosgene value = chem_combined_str_damage }
    set_variable = { var = chem_offense_total_phosgene value = chem_offense_total }
    set_variable = { var = chem_breakthrough_total_phosgene value = chem_breakthrough_total }
    set_variable = { var = chem_defense_total_phosgene value = chem_defense_total }
    set_variable = { var = chem_org_damage_total_phosgene value = chem_org_damage_total }
    set_variable = { var = chem_str_damage_total_phosgene value = chem_str_damage_total }
    set_variable = { var = chem_war_support_total_phosgene value = chem_war_support_total }
    set_variable = { var = chem_unit_speed_phosgene value = @CHEM_UNIT_SPEED_FACTOR }
    set_variable = { var = chem_urban_attack_phosgene value = @CHEM_UNIT_URBAN_ATTACK }
    set_variable = { var = chem_unit_speed_total_phosgene value = @CHEM_UNIT_SPEED_FACTOR }
    set_variable = { var = chem_urban_attack_total_phosgene value = @CHEM_UNIT_URBAN_ATTACK }
    OWNER = {
        set_variable = { var = chem_required_phosgene value = chem_required }
        set_variable = { var = chem_available_phosgene value = chem_available }
        set_variable = { var = chem_ratio_loc_phosgene value = chem_ratio }
        set_variable = { var = chem_combined_offense_phosgene value = chem_combined_offense }
        set_variable = { var = chem_combined_breakthrough_phosgene value = chem_combined_breakthrough }
        set_variable = { var = chem_combined_org_damage_phosgene value = chem_combined_org_damage }
        set_variable = { var = chem_combined_str_damage_phosgene value = chem_combined_str_damage }
        set_variable = { var = chem_offense_total_phosgene value = chem_offense_total }
        set_variable = { var = chem_breakthrough_total_phosgene value = chem_breakthrough_total }
        set_variable = { var = chem_defense_total_phosgene value = chem_defense_total }
        set_variable = { var = chem_org_damage_total_phosgene value = chem_org_damage_total }
        set_variable = { var = chem_str_damage_total_phosgene value = chem_str_damage_total }
        set_variable = { var = chem_war_support_total_phosgene value = chem_war_support_total }
        set_variable = { var = chem_unit_speed_phosgene value = @CHEM_UNIT_SPEED_FACTOR }
        set_variable = { var = chem_urban_attack_phosgene value = @CHEM_UNIT_URBAN_ATTACK }
        set_variable = { var = chem_unit_speed_total_phosgene value = @CHEM_UNIT_SPEED_FACTOR }
        set_variable = { var = chem_urban_attack_total_phosgene value = @CHEM_UNIT_URBAN_ATTACK }
    }
}

chem_apply_mask_preview_modifiers = {
    set_temp_variable = { var = chem_mask_org_preview value = 0 }
    set_temp_variable = { var = chem_mask_str_preview value = 0 }
    if = {
        limit = { OWNER = { has_tech = advanced_gas_masks } }
        set_temp_variable = { var = chem_mask_org_preview value = chem_org_damage_preview }
        multiply_temp_variable = { var = chem_mask_org_preview value = @CHEM_MASK_REDUCTION_ADVANCED }
        multiply_temp_variable = { var = chem_mask_org_preview value = -1 }
        set_temp_variable = { var = chem_mask_str_preview value = chem_str_damage_preview }
        multiply_temp_variable = { var = chem_mask_str_preview value = @CHEM_MASK_REDUCTION_ADVANCED }
        multiply_temp_variable = { var = chem_mask_str_preview value = -1 }
    }
    else_if = {
        limit = { OWNER = { has_tech = improved_gas_masks } }
        set_temp_variable = { var = chem_mask_org_preview value = chem_org_damage_preview }
        multiply_temp_variable = { var = chem_mask_org_preview value = @CHEM_MASK_REDUCTION_IMPROVED }
        multiply_temp_variable = { var = chem_mask_org_preview value = -1 }
        set_temp_variable = { var = chem_mask_str_preview value = chem_str_damage_preview }
        multiply_temp_variable = { var = chem_mask_str_preview value = @CHEM_MASK_REDUCTION_IMPROVED }
        multiply_temp_variable = { var = chem_mask_str_preview value = -1 }
    }
    else_if = {
        limit = { OWNER = { has_tech = basic_gas_masks } }
        set_temp_variable = { var = chem_mask_org_preview value = chem_org_damage_preview }
        multiply_temp_variable = { var = chem_mask_org_preview value = @CHEM_MASK_REDUCTION_BASIC }
        multiply_temp_variable = { var = chem_mask_org_preview value = -1 }
        set_temp_variable = { var = chem_mask_str_preview value = chem_str_damage_preview }
        multiply_temp_variable = { var = chem_mask_str_preview value = @CHEM_MASK_REDUCTION_BASIC }
        multiply_temp_variable = { var = chem_mask_str_preview value = -1 }
    }
}

chem_set_final_chlorine_effects = {
    if = {
        limit = { check_variable = { var = chem_wind_miscalc_happened value = 0 compare = greater_than } }
        set_temp_variable = { var = chem_base_offense value = chem_offense_chlorine }
        set_temp_variable = { var = chem_wind_delta_neg value = chem_offense_wind_chlorine }
        multiply_temp_variable = { var = chem_wind_delta_neg value = -1 }
        add_to_temp_variable = { var = chem_base_offense value = chem_wind_delta_neg }
        set_temp_variable = { var = chem_offense value = chem_base_offense }
        multiply_temp_variable = { var = chem_offense value = chem_wind_positive_mult_value }
        add_to_temp_variable = { var = chem_offense value = chem_combined_offense_chlorine }
        set_temp_variable = { var = chem_base_breakthrough value = chem_breakthrough_chlorine }
        set_temp_variable = { var = chem_wind_delta_neg value = chem_breakthrough_wind_chlorine }
        multiply_temp_variable = { var = chem_wind_delta_neg value = -1 }
        add_to_temp_variable = { var = chem_base_breakthrough value = chem_wind_delta_neg }
        set_temp_variable = { var = chem_breakthrough value = chem_base_breakthrough }
        multiply_temp_variable = { var = chem_breakthrough value = chem_wind_positive_mult_value }
        add_to_temp_variable = { var = chem_breakthrough value = chem_combined_breakthrough_chlorine }
        set_temp_variable = { var = chem_base_defense value = chem_defense_chlorine }
        set_temp_variable = { var = chem_wind_delta_neg value = chem_defense_wind_chlorine }
        multiply_temp_variable = { var = chem_wind_delta_neg value = -1 }
        add_to_temp_variable = { var = chem_base_defense value = chem_wind_delta_neg }
        set_temp_variable = { var = chem_defense value = chem_base_defense }
        multiply_temp_variable = { var = chem_defense value = chem_wind_positive_mult_value }
        set_temp_variable = { var = chem_base_org_damage value = chem_org_damage_chlorine }
        set_temp_variable = { var = chem_wind_delta_neg value = chem_org_damage_wind_chlorine }
        multiply_temp_variable = { var = chem_wind_delta_neg value = -1 }
        add_to_temp_variable = { var = chem_base_org_damage value = chem_wind_delta_neg }
        set_temp_variable = { var = chem_org_damage value = chem_base_org_damage }
        multiply_temp_variable = { var = chem_org_damage value = chem_wind_negative_mult_value }
        add_to_temp_variable = { var = chem_org_damage value = chem_combined_org_damage_chlorine }
        add_to_temp_variable = { var = chem_org_damage value = chem_mask_org_chlorine }
        set_temp_variable = { var = chem_base_str_damage value = chem_str_damage_chlorine }
        set_temp_variable = { var = chem_wind_delta_neg value = chem_str_damage_wind_chlorine }
        multiply_temp_variable = { var = chem_wind_delta_neg value = -1 }
        add_to_temp_variable = { var = chem_base_str_damage value = chem_wind_delta_neg }
        set_temp_variable = { var = chem_str_damage value = chem_base_str_damage }
        multiply_temp_variable = { var = chem_str_damage value = chem_wind_negative_mult_value }
        add_to_temp_variable = { var = chem_str_damage value = chem_combined_str_damage_chlorine }
        add_to_temp_variable = { var = chem_str_damage value = chem_mask_str_chlorine }
        set_temp_variable = { var = chem_base_war_support value = chem_war_support_chlorine }
        set_temp_variable = { var = chem_wind_delta_neg value = chem_war_support_wind_chlorine }
        multiply_temp_variable = { var = chem_wind_delta_neg value = -1 }
        add_to_temp_variable = { var = chem_base_war_support value = chem_wind_delta_neg }
        set_temp_variable = { var = chem_war_support value = chem_base_war_support }
        multiply_temp_variable = { var = chem_war_support value = chem_wind_negative_mult_value }
    }
    else = {
        set_temp_variable = { var = chem_offense value = chem_offense_total_chlorine }
        set_temp_variable = { var = chem_breakthrough value = chem_breakthrough_total_chlorine }
        set_temp_variable = { var = chem_defense value = chem_defense_total_chlorine }
        set_temp_variable = { var = chem_org_damage value = chem_org_damage_total_chlorine }
        set_temp_variable = { var = chem_str_damage value = chem_str_damage_total_chlorine }
        set_temp_variable = { var = chem_war_support value = chem_war_support_total_chlorine }
    }
}

chem_set_final_phosgene_effects = {
    if = {
        limit = { check_variable = { var = chem_wind_miscalc_happened value = 0 compare = greater_than } }
        set_temp_variable = { var = chem_base_offense value = chem_offense_phosgene }
        set_temp_variable = { var = chem_wind_delta_neg value = chem_offense_wind_phosgene }
        multiply_temp_variable = { var = chem_wind_delta_neg value = -1 }
        add_to_temp_variable = { var = chem_base_offense value = chem_wind_delta_neg }
        set_temp_variable = { var = chem_offense value = chem_base_offense }
        multiply_temp_variable = { var = chem_offense value = chem_wind_positive_mult_value }
        add_to_temp_variable = { var = chem_offense value = chem_combined_offense_phosgene }
        set_temp_variable = { var = chem_base_breakthrough value = chem_breakthrough_phosgene }
        set_temp_variable = { var = chem_wind_delta_neg value = chem_breakthrough_wind_phosgene }
        multiply_temp_variable = { var = chem_wind_delta_neg value = -1 }
        add_to_temp_variable = { var = chem_base_breakthrough value = chem_wind_delta_neg }
        set_temp_variable = { var = chem_breakthrough value = chem_base_breakthrough }
        multiply_temp_variable = { var = chem_breakthrough value = chem_wind_positive_mult_value }
        add_to_temp_variable = { var = chem_breakthrough value = chem_combined_breakthrough_phosgene }
        set_temp_variable = { var = chem_base_defense value = chem_defense_phosgene }
        set_temp_variable = { var = chem_wind_delta_neg value = chem_defense_wind_phosgene }
        multiply_temp_variable = { var = chem_wind_delta_neg value = -1 }
        add_to_temp_variable = { var = chem_base_defense value = chem_wind_delta_neg }
        set_temp_variable = { var = chem_defense value = chem_base_defense }
        multiply_temp_variable = { var = chem_defense value = chem_wind_positive_mult_value }
        set_temp_variable = { var = chem_base_org_damage value = chem_org_damage_phosgene }
        set_temp_variable = { var = chem_wind_delta_neg value = chem_org_damage_wind_phosgene }
        multiply_temp_variable = { var = chem_wind_delta_neg value = -1 }
        add_to_temp_variable = { var = chem_base_org_damage value = chem_wind_delta_neg }
        set_temp_variable = { var = chem_org_damage value = chem_base_org_damage }
        multiply_temp_variable = { var = chem_org_damage value = chem_wind_negative_mult_value }
        add_to_temp_variable = { var = chem_org_damage value = chem_combined_org_damage_phosgene }
        add_to_temp_variable = { var = chem_org_damage value = chem_mask_org_phosgene }
        set_temp_variable = { var = chem_base_str_damage value = chem_str_damage_phosgene }
        set_temp_variable = { var = chem_wind_delta_neg value = chem_str_damage_wind_phosgene }
        multiply_temp_variable = { var = chem_wind_delta_neg value = -1 }
        add_to_temp_variable = { var = chem_base_str_damage value = chem_wind_delta_neg }
        set_temp_variable = { var = chem_str_damage value = chem_base_str_damage }
        multiply_temp_variable = { var = chem_str_damage value = chem_wind_negative_mult_value }
        add_to_temp_variable = { var = chem_str_damage value = chem_combined_str_damage_phosgene }
        add_to_temp_variable = { var = chem_str_damage value = chem_mask_str_phosgene }
        set_temp_variable = { var = chem_base_war_support value = chem_war_support_phosgene }
        set_temp_variable = { var = chem_wind_delta_neg value = chem_war_support_wind_phosgene }
        multiply_temp_variable = { var = chem_wind_delta_neg value = -1 }
        add_to_temp_variable = { var = chem_base_war_support value = chem_wind_delta_neg }
        set_temp_variable = { var = chem_war_support value = chem_base_war_support }
        multiply_temp_variable = { var = chem_war_support value = chem_wind_negative_mult_value }
    }
    else = {
        set_temp_variable = { var = chem_offense value = chem_offense_total_phosgene }
        set_temp_variable = { var = chem_breakthrough value = chem_breakthrough_total_phosgene }
        set_temp_variable = { var = chem_defense value = chem_defense_total_phosgene }
        set_temp_variable = { var = chem_org_damage value = chem_org_damage_total_phosgene }
        set_temp_variable = { var = chem_str_damage value = chem_str_damage_total_phosgene }
        set_temp_variable = { var = chem_war_support value = chem_war_support_total_phosgene }
    }
}

chem_set_final_mustard_effects = {
    if = {
        limit = { check_variable = { var = chem_wind_miscalc_happened value = 0 compare = greater_than } }
        set_temp_variable = { var = chem_base_offense value = chem_offense_mustard }
        set_temp_variable = { var = chem_wind_delta_neg value = chem_offense_wind_mustard }
        multiply_temp_variable = { var = chem_wind_delta_neg value = -1 }
        add_to_temp_variable = { var = chem_base_offense value = chem_wind_delta_neg }
        set_temp_variable = { var = chem_offense value = chem_base_offense }
        multiply_temp_variable = { var = chem_offense value = chem_wind_positive_mult_value }
        add_to_temp_variable = { var = chem_offense value = chem_combined_offense_mustard }
        set_temp_variable = { var = chem_base_breakthrough value = chem_breakthrough_mustard }
        set_temp_variable = { var = chem_wind_delta_neg value = chem_breakthrough_wind_mustard }
        multiply_temp_variable = { var = chem_wind_delta_neg value = -1 }
        add_to_temp_variable = { var = chem_base_breakthrough value = chem_wind_delta_neg }
        set_temp_variable = { var = chem_breakthrough value = chem_base_breakthrough }
        multiply_temp_variable = { var = chem_breakthrough value = chem_wind_positive_mult_value }
        add_to_temp_variable = { var = chem_breakthrough value = chem_combined_breakthrough_mustard }
        set_temp_variable = { var = chem_base_defense value = chem_defense_mustard }
        set_temp_variable = { var = chem_wind_delta_neg value = chem_defense_wind_mustard }
        multiply_temp_variable = { var = chem_wind_delta_neg value = -1 }
        add_to_temp_variable = { var = chem_base_defense value = chem_wind_delta_neg }
        set_temp_variable = { var = chem_defense value = chem_base_defense }
        multiply_temp_variable = { var = chem_defense value = chem_wind_positive_mult_value }
        set_temp_variable = { var = chem_base_org_damage value = chem_org_damage_mustard }
        set_temp_variable = { var = chem_wind_delta_neg value = chem_org_damage_wind_mustard }
        multiply_temp_variable = { var = chem_wind_delta_neg value = -1 }
        add_to_temp_variable = { var = chem_base_org_damage value = chem_wind_delta_neg }
        set_temp_variable = { var = chem_org_damage value = chem_base_org_damage }
        multiply_temp_variable = { var = chem_org_damage value = chem_wind_negative_mult_value }
        add_to_temp_variable = { var = chem_org_damage value = chem_combined_org_damage_mustard }
        add_to_temp_variable = { var = chem_org_damage value = chem_mask_org_mustard }
        set_temp_variable = { var = chem_base_str_damage value = chem_str_damage_mustard }
        set_temp_variable = { var = chem_wind_delta_neg value = chem_str_damage_wind_mustard }
        multiply_temp_variable = { var = chem_wind_delta_neg value = -1 }
        add_to_temp_variable = { var = chem_base_str_damage value = chem_wind_delta_neg }
        set_temp_variable = { var = chem_str_damage value = chem_base_str_damage }
        multiply_temp_variable = { var = chem_str_damage value = chem_wind_negative_mult_value }
        add_to_temp_variable = { var = chem_str_damage value = chem_combined_str_damage_mustard }
        add_to_temp_variable = { var = chem_str_damage value = chem_mask_str_mustard }
        set_temp_variable = { var = chem_base_war_support value = chem_war_support_mustard }
        set_temp_variable = { var = chem_wind_delta_neg value = chem_war_support_wind_mustard }
        multiply_temp_variable = { var = chem_wind_delta_neg value = -1 }
        add_to_temp_variable = { var = chem_base_war_support value = chem_wind_delta_neg }
        set_temp_variable = { var = chem_war_support value = chem_base_war_support }
        multiply_temp_variable = { var = chem_war_support value = chem_wind_negative_mult_value }
    }
    else = {
        set_temp_variable = { var = chem_offense value = chem_offense_total_mustard }
        set_temp_variable = { var = chem_breakthrough value = chem_breakthrough_total_mustard }
        set_temp_variable = { var = chem_defense value = chem_defense_total_mustard }
        set_temp_variable = { var = chem_org_damage value = chem_org_damage_total_mustard }
        set_temp_variable = { var = chem_str_damage value = chem_str_damage_total_mustard }
        set_temp_variable = { var = chem_war_support value = chem_war_support_total_mustard }
    }
}

chem_set_final_lewisite_effects = {
    if = {
        limit = { check_variable = { var = chem_wind_miscalc_happened value = 0 compare = greater_than } }
        set_temp_variable = { var = chem_base_offense value = chem_offense_lewisite }
        set_temp_variable = { var = chem_wind_delta_neg value = chem_offense_wind_lewisite }
        multiply_temp_variable = { var = chem_wind_delta_neg value = -1 }
        add_to_temp_variable = { var = chem_base_offense value = chem_wind_delta_neg }
        set_temp_variable = { var = chem_offense value = chem_base_offense }
        multiply_temp_variable = { var = chem_offense value = chem_wind_positive_mult_value }
        add_to_temp_variable = { var = chem_offense value = chem_combined_offense_lewisite }
        set_temp_variable = { var = chem_base_breakthrough value = chem_breakthrough_lewisite }
        set_temp_variable = { var = chem_wind_delta_neg value = chem_breakthrough_wind_lewisite }
        multiply_temp_variable = { var = chem_wind_delta_neg value = -1 }
        add_to_temp_variable = { var = chem_base_breakthrough value = chem_wind_delta_neg }
        set_temp_variable = { var = chem_breakthrough value = chem_base_breakthrough }
        multiply_temp_variable = { var = chem_breakthrough value = chem_wind_positive_mult_value }
        add_to_temp_variable = { var = chem_breakthrough value = chem_combined_breakthrough_lewisite }
        set_temp_variable = { var = chem_base_defense value = chem_defense_lewisite }
        set_temp_variable = { var = chem_wind_delta_neg value = chem_defense_wind_lewisite }
        multiply_temp_variable = { var = chem_wind_delta_neg value = -1 }
        add_to_temp_variable = { var = chem_base_defense value = chem_wind_delta_neg }
        set_temp_variable = { var = chem_defense value = chem_base_defense }
        multiply_temp_variable = { var = chem_defense value = chem_wind_positive_mult_value }
        set_temp_variable = { var = chem_base_org_damage value = chem_org_damage_lewisite }
        set_temp_variable = { var = chem_wind_delta_neg value = chem_org_damage_wind_lewisite }
        multiply_temp_variable = { var = chem_wind_delta_neg value = -1 }
        add_to_temp_variable = { var = chem_base_org_damage value = chem_wind_delta_neg }
        set_temp_variable = { var = chem_org_damage value = chem_base_org_damage }
        multiply_temp_variable = { var = chem_org_damage value = chem_wind_negative_mult_value }
        add_to_temp_variable = { var = chem_org_damage value = chem_combined_org_damage_lewisite }
        add_to_temp_variable = { var = chem_org_damage value = chem_mask_org_lewisite }
        set_temp_variable = { var = chem_base_str_damage value = chem_str_damage_lewisite }
        set_temp_variable = { var = chem_wind_delta_neg value = chem_str_damage_wind_lewisite }
        multiply_temp_variable = { var = chem_wind_delta_neg value = -1 }
        add_to_temp_variable = { var = chem_base_str_damage value = chem_wind_delta_neg }
        set_temp_variable = { var = chem_str_damage value = chem_base_str_damage }
        multiply_temp_variable = { var = chem_str_damage value = chem_wind_negative_mult_value }
        add_to_temp_variable = { var = chem_str_damage value = chem_combined_str_damage_lewisite }
        add_to_temp_variable = { var = chem_str_damage value = chem_mask_str_lewisite }
        set_temp_variable = { var = chem_base_war_support value = chem_war_support_lewisite }
        set_temp_variable = { var = chem_wind_delta_neg value = chem_war_support_wind_lewisite }
        multiply_temp_variable = { var = chem_wind_delta_neg value = -1 }
        add_to_temp_variable = { var = chem_base_war_support value = chem_wind_delta_neg }
        set_temp_variable = { var = chem_war_support value = chem_base_war_support }
        multiply_temp_variable = { var = chem_war_support value = chem_wind_negative_mult_value }
    }
    else = {
        set_temp_variable = { var = chem_offense value = chem_offense_total_lewisite }
        set_temp_variable = { var = chem_breakthrough value = chem_breakthrough_total_lewisite }
        set_temp_variable = { var = chem_defense value = chem_defense_total_lewisite }
        set_temp_variable = { var = chem_org_damage value = chem_org_damage_total_lewisite }
        set_temp_variable = { var = chem_str_damage value = chem_str_damage_total_lewisite }
        set_temp_variable = { var = chem_war_support value = chem_war_support_total_lewisite }
    }
}

chem_update_mustard_preview = {
    set_temp_variable = { var = chem_required value = num_battalions }
    set_temp_variable = { var = chem_available value = 0 }
    OWNER = {
        set_temp_variable = { var = chem_available value = num_equipment@chemical_mustard_payload_cylinder_1 }
        add_to_temp_variable = { var = chem_available value = num_equipment@chemical_mustard_payload_cylinder }
        set_variable = { var = chem_available_mustard value = chem_available }
    }
    set_temp_variable = { var = chem_ratio value = 0 }
    set_temp_variable = { var = chem_ratio_preview value = 0 }
    if = {
        limit = { check_variable = { var = chem_required value = 0 compare = greater_than } }
        multiply_temp_variable = { var = chem_required value = @CHEM_PREVIEW_MUSTARD_CYLINDERS_PER_BATTALION }
        set_variable = { var = chem_required_mustard value = chem_required }
        set_temp_variable = { var = chem_ratio value = chem_available }
        divide_temp_variable = { var = chem_ratio value = chem_required }
        clamp_temp_variable = { var = chem_ratio min = 0 max = 1 }
        set_variable = { var = chem_ratio_loc_mustard value = chem_ratio }
        set_temp_variable = { var = chem_ratio_preview value = chem_ratio }
        clamp_temp_variable = { var = chem_ratio_preview min = @CHEM_PREVIEW_RATIO_MIN max = 1 }
        set_temp_variable = { var = chem_offense_preview value = @CHEM_PREVIEW_MUSTARD_OFFENSE }
        multiply_temp_variable = { var = chem_offense_preview value = chem_ratio_preview }
        set_temp_variable = { var = chem_breakthrough_preview value = @CHEM_PREVIEW_MUSTARD_BREAKTHROUGH }
        multiply_temp_variable = { var = chem_breakthrough_preview value = chem_ratio_preview }
        set_temp_variable = { var = chem_defense_preview value = @CHEM_PREVIEW_MUSTARD_DEFENSE }
        multiply_temp_variable = { var = chem_defense_preview value = chem_ratio_preview }
        set_temp_variable = { var = chem_org_damage_preview value = @CHEM_PREVIEW_MUSTARD_ORG_DAMAGE }
        multiply_temp_variable = { var = chem_org_damage_preview value = chem_ratio_preview }
        set_temp_variable = { var = chem_str_damage_preview value = @CHEM_PREVIEW_MUSTARD_STR_DAMAGE }
        multiply_temp_variable = { var = chem_str_damage_preview value = chem_ratio_preview }
        set_temp_variable = { var = chem_war_support_preview value = @CHEM_PREVIEW_MUSTARD_WAR_SUPPORT }
        multiply_temp_variable = { var = chem_war_support_preview value = chem_ratio_preview }
    }
    else = {
        set_variable = { var = chem_required_mustard value = 0 }
        set_variable = { var = chem_ratio_loc_mustard value = 0 }
        set_temp_variable = { var = chem_ratio_preview value = 0 }
        set_temp_variable = { var = chem_offense_preview value = 0 }
        set_temp_variable = { var = chem_breakthrough_preview value = 0 }
        set_temp_variable = { var = chem_defense_preview value = 0 }
        set_temp_variable = { var = chem_org_damage_preview value = 0 }
        set_temp_variable = { var = chem_str_damage_preview value = 0 }
        set_temp_variable = { var = chem_war_support_preview value = 0 }
    }
    set_variable = { var = chem_offense_mustard value = chem_offense_preview }
    set_variable = { var = chem_breakthrough_mustard value = chem_breakthrough_preview }
    set_variable = { var = chem_defense_mustard value = chem_defense_preview }
    set_variable = { var = chem_org_damage_mustard value = chem_org_damage_preview }
    set_variable = { var = chem_str_damage_mustard value = chem_str_damage_preview }
    set_variable = { var = chem_war_support_mustard value = chem_war_support_preview }
    FROM = {
        set_variable = { var = chem_offense_mustard value = chem_offense_preview }
        set_variable = { var = chem_breakthrough_mustard value = chem_breakthrough_preview }
        set_variable = { var = chem_defense_mustard value = chem_defense_preview }
        set_variable = { var = chem_org_damage_mustard value = chem_org_damage_preview }
        set_variable = { var = chem_str_damage_mustard value = chem_str_damage_preview }
        set_variable = { var = chem_war_support_mustard value = chem_war_support_preview }
    }
    set_temp_variable = { var = chem_base_offense_preview value = chem_offense_preview }
    set_temp_variable = { var = chem_base_breakthrough_preview value = chem_breakthrough_preview }
    set_temp_variable = { var = chem_base_defense_preview value = chem_defense_preview }
    set_temp_variable = { var = chem_base_org_damage_preview value = chem_org_damage_preview }
    set_temp_variable = { var = chem_base_str_damage_preview value = chem_str_damage_preview }
    set_temp_variable = { var = chem_base_war_support_preview value = chem_war_support_preview }
    chem_apply_wind_preview_modifiers = yes
    set_temp_variable = { var = chem_offense_wind_delta value = chem_base_offense_preview }
    multiply_temp_variable = { var = chem_offense_wind_delta value = -1 }
    add_to_temp_variable = { var = chem_offense_wind_delta value = chem_offense_preview }
    set_temp_variable = { var = chem_breakthrough_wind_delta value = chem_base_breakthrough_preview }
    multiply_temp_variable = { var = chem_breakthrough_wind_delta value = -1 }
    add_to_temp_variable = { var = chem_breakthrough_wind_delta value = chem_breakthrough_preview }
    set_temp_variable = { var = chem_defense_wind_delta value = chem_base_defense_preview }
    multiply_temp_variable = { var = chem_defense_wind_delta value = -1 }
    add_to_temp_variable = { var = chem_defense_wind_delta value = chem_defense_preview }
    set_temp_variable = { var = chem_org_damage_wind_delta value = chem_base_org_damage_preview }
    multiply_temp_variable = { var = chem_org_damage_wind_delta value = -1 }
    add_to_temp_variable = { var = chem_org_damage_wind_delta value = chem_org_damage_preview }
    set_temp_variable = { var = chem_str_damage_wind_delta value = chem_base_str_damage_preview }
    multiply_temp_variable = { var = chem_str_damage_wind_delta value = -1 }
    add_to_temp_variable = { var = chem_str_damage_wind_delta value = chem_str_damage_preview }
    set_temp_variable = { var = chem_war_support_wind_delta value = chem_base_war_support_preview }
    multiply_temp_variable = { var = chem_war_support_wind_delta value = -1 }
    add_to_temp_variable = { var = chem_war_support_wind_delta value = chem_war_support_preview }
    set_variable = { var = chem_offense_wind_mustard value = chem_offense_wind_delta }
    set_variable = { var = chem_breakthrough_wind_mustard value = chem_breakthrough_wind_delta }
    set_variable = { var = chem_defense_wind_mustard value = chem_defense_wind_delta }
    set_variable = { var = chem_org_damage_wind_mustard value = chem_org_damage_wind_delta }
    set_variable = { var = chem_str_damage_wind_mustard value = chem_str_damage_wind_delta }
    set_variable = { var = chem_war_support_wind_mustard value = chem_war_support_wind_delta }
    FROM = {
        set_variable = { var = chem_offense_wind_mustard value = chem_offense_wind_delta }
        set_variable = { var = chem_breakthrough_wind_mustard value = chem_breakthrough_wind_delta }
        set_variable = { var = chem_defense_wind_mustard value = chem_defense_wind_delta }
        set_variable = { var = chem_org_damage_wind_mustard value = chem_org_damage_wind_delta }
        set_variable = { var = chem_str_damage_wind_mustard value = chem_str_damage_wind_delta }
        set_variable = { var = chem_war_support_wind_mustard value = chem_war_support_wind_delta }
    }
    set_temp_variable = { var = chem_ratio value = chem_ratio_preview }
    chem_prepare_weather_terrain_penalties = yes
    chem_apply_weather_ability_modifiers = yes
    chem_apply_terrain_ability_modifiers = yes
    chem_apply_mask_preview_modifiers = yes
    set_temp_variable = { var = chem_mask_org_display value = chem_mask_org_preview }
    set_temp_variable = { var = chem_mask_str_display value = chem_mask_str_preview }
    set_variable = { var = chem_mask_org_mustard value = chem_mask_org_display }
    set_variable = { var = chem_mask_str_mustard value = chem_mask_str_display }
    FROM = {
        set_variable = { var = chem_mask_org_mustard value = chem_mask_org_display }
        set_variable = { var = chem_mask_str_mustard value = chem_mask_str_display }
    }
    set_temp_variable = { var = chem_offense_total value = chem_offense_preview }
    add_to_temp_variable = { var = chem_offense_total value = chem_combined_offense }
    set_temp_variable = { var = chem_breakthrough_total value = chem_breakthrough_preview }
    add_to_temp_variable = { var = chem_breakthrough_total value = chem_combined_breakthrough }
    set_temp_variable = { var = chem_defense_total value = chem_defense_preview }
    set_temp_variable = { var = chem_org_damage_total value = chem_org_damage_preview }
    add_to_temp_variable = { var = chem_org_damage_total value = chem_combined_org_damage }
    add_to_temp_variable = { var = chem_org_damage_total value = chem_mask_org_preview }
    set_temp_variable = { var = chem_str_damage_total value = chem_str_damage_preview }
    add_to_temp_variable = { var = chem_str_damage_total value = chem_combined_str_damage }
    add_to_temp_variable = { var = chem_str_damage_total value = chem_mask_str_preview }
    set_temp_variable = { var = chem_war_support_total value = chem_war_support_preview }
    set_variable = { var = chem_available_mustard value = chem_available }
    set_variable = { var = chem_combined_offense_mustard value = chem_combined_offense }
    set_variable = { var = chem_combined_breakthrough_mustard value = chem_combined_breakthrough }
    set_variable = { var = chem_combined_org_damage_mustard value = chem_combined_org_damage }
    set_variable = { var = chem_combined_str_damage_mustard value = chem_combined_str_damage }
    set_variable = { var = chem_offense_total_mustard value = chem_offense_total }
    set_variable = { var = chem_breakthrough_total_mustard value = chem_breakthrough_total }
    set_variable = { var = chem_defense_total_mustard value = chem_defense_total }
    set_variable = { var = chem_org_damage_total_mustard value = chem_org_damage_total }
    set_variable = { var = chem_str_damage_total_mustard value = chem_str_damage_total }
    set_variable = { var = chem_war_support_total_mustard value = chem_war_support_total }
    set_variable = { var = chem_unit_speed_mustard value = @CHEM_UNIT_SPEED_FACTOR }
    set_variable = { var = chem_urban_attack_mustard value = @CHEM_UNIT_URBAN_ATTACK }
    set_variable = { var = chem_unit_speed_total_mustard value = @CHEM_UNIT_SPEED_FACTOR }
    set_variable = { var = chem_urban_attack_total_mustard value = @CHEM_UNIT_URBAN_ATTACK }
    OWNER = {
        set_variable = { var = chem_required_mustard value = chem_required }
        set_variable = { var = chem_available_mustard value = chem_available }
        set_variable = { var = chem_ratio_loc_mustard value = chem_ratio }
        set_variable = { var = chem_combined_offense_mustard value = chem_combined_offense }
        set_variable = { var = chem_combined_breakthrough_mustard value = chem_combined_breakthrough }
        set_variable = { var = chem_combined_org_damage_mustard value = chem_combined_org_damage }
        set_variable = { var = chem_combined_str_damage_mustard value = chem_combined_str_damage }
        set_variable = { var = chem_offense_total_mustard value = chem_offense_total }
        set_variable = { var = chem_breakthrough_total_mustard value = chem_breakthrough_total }
        set_variable = { var = chem_defense_total_mustard value = chem_defense_total }
        set_variable = { var = chem_org_damage_total_mustard value = chem_org_damage_total }
        set_variable = { var = chem_str_damage_total_mustard value = chem_str_damage_total }
        set_variable = { var = chem_war_support_total_mustard value = chem_war_support_total }
        set_variable = { var = chem_unit_speed_mustard value = @CHEM_UNIT_SPEED_FACTOR }
        set_variable = { var = chem_urban_attack_mustard value = @CHEM_UNIT_URBAN_ATTACK }
        set_variable = { var = chem_unit_speed_total_mustard value = @CHEM_UNIT_SPEED_FACTOR }
        set_variable = { var = chem_urban_attack_total_mustard value = @CHEM_UNIT_URBAN_ATTACK }
    }
}

chem_update_lewisite_preview = {
    set_temp_variable = { var = chem_required value = num_battalions }
    set_temp_variable = { var = chem_available value = 0 }
    OWNER = {
        set_temp_variable = { var = chem_available value = num_equipment@chemical_lewisite_payload_cylinder_1 }
        add_to_temp_variable = { var = chem_available value = num_equipment@chemical_lewisite_payload_cylinder }
        set_variable = { var = chem_available_lewisite value = chem_available }
    }
    set_temp_variable = { var = chem_ratio value = 0 }
    set_temp_variable = { var = chem_ratio_preview value = 0 }
    if = {
        limit = { check_variable = { var = chem_required value = 0 compare = greater_than } }
        multiply_temp_variable = { var = chem_required value = @CHEM_PREVIEW_LEWISITE_CYLINDERS_PER_BATTALION }
        set_variable = { var = chem_required_lewisite value = chem_required }
        set_temp_variable = { var = chem_ratio value = chem_available }
        divide_temp_variable = { var = chem_ratio value = chem_required }
        clamp_temp_variable = { var = chem_ratio min = 0 max = 1 }
        set_variable = { var = chem_ratio_loc_lewisite value = chem_ratio }
        set_temp_variable = { var = chem_ratio_preview value = chem_ratio }
        clamp_temp_variable = { var = chem_ratio_preview min = @CHEM_PREVIEW_RATIO_MIN max = 1 }
        set_temp_variable = { var = chem_offense_preview value = @CHEM_PREVIEW_LEWISITE_OFFENSE }
        multiply_temp_variable = { var = chem_offense_preview value = chem_ratio_preview }
        set_temp_variable = { var = chem_breakthrough_preview value = @CHEM_PREVIEW_LEWISITE_BREAKTHROUGH }
        multiply_temp_variable = { var = chem_breakthrough_preview value = chem_ratio_preview }
        set_temp_variable = { var = chem_defense_preview value = @CHEM_PREVIEW_LEWISITE_DEFENSE }
        multiply_temp_variable = { var = chem_defense_preview value = chem_ratio_preview }
        set_temp_variable = { var = chem_org_damage_preview value = @CHEM_PREVIEW_LEWISITE_ORG_DAMAGE }
        multiply_temp_variable = { var = chem_org_damage_preview value = chem_ratio_preview }
        set_temp_variable = { var = chem_str_damage_preview value = @CHEM_PREVIEW_LEWISITE_STR_DAMAGE }
        multiply_temp_variable = { var = chem_str_damage_preview value = chem_ratio_preview }
        set_temp_variable = { var = chem_war_support_preview value = @CHEM_PREVIEW_LEWISITE_WAR_SUPPORT }
        multiply_temp_variable = { var = chem_war_support_preview value = chem_ratio_preview }
    }
    else = {
        set_variable = { var = chem_required_lewisite value = 0 }
        set_variable = { var = chem_ratio_loc_lewisite value = 0 }
        set_temp_variable = { var = chem_ratio_preview value = 0 }
        set_temp_variable = { var = chem_offense_preview value = 0 }
        set_temp_variable = { var = chem_breakthrough_preview value = 0 }
        set_temp_variable = { var = chem_defense_preview value = 0 }
        set_temp_variable = { var = chem_org_damage_preview value = 0 }
        set_temp_variable = { var = chem_str_damage_preview value = 0 }
        set_temp_variable = { var = chem_war_support_preview value = 0 }
    }
    set_variable = { var = chem_offense_lewisite value = chem_offense_preview }
    set_variable = { var = chem_breakthrough_lewisite value = chem_breakthrough_preview }
    set_variable = { var = chem_defense_lewisite value = chem_defense_preview }
    set_variable = { var = chem_org_damage_lewisite value = chem_org_damage_preview }
    set_variable = { var = chem_str_damage_lewisite value = chem_str_damage_preview }
    set_variable = { var = chem_war_support_lewisite value = chem_war_support_preview }
    FROM = {
        set_variable = { var = chem_offense_lewisite value = chem_offense_preview }
        set_variable = { var = chem_breakthrough_lewisite value = chem_breakthrough_preview }
        set_variable = { var = chem_defense_lewisite value = chem_defense_preview }
        set_variable = { var = chem_org_damage_lewisite value = chem_org_damage_preview }
        set_variable = { var = chem_str_damage_lewisite value = chem_str_damage_preview }
        set_variable = { var = chem_war_support_lewisite value = chem_war_support_preview }
    }
    set_temp_variable = { var = chem_base_offense_preview value = chem_offense_preview }
    set_temp_variable = { var = chem_base_breakthrough_preview value = chem_breakthrough_preview }
    set_temp_variable = { var = chem_base_defense_preview value = chem_defense_preview }
    set_temp_variable = { var = chem_base_org_damage_preview value = chem_org_damage_preview }
    set_temp_variable = { var = chem_base_str_damage_preview value = chem_str_damage_preview }
    set_temp_variable = { var = chem_base_war_support_preview value = chem_war_support_preview }
    chem_apply_wind_preview_modifiers = yes
    set_temp_variable = { var = chem_offense_wind_delta value = chem_base_offense_preview }
    multiply_temp_variable = { var = chem_offense_wind_delta value = -1 }
    add_to_temp_variable = { var = chem_offense_wind_delta value = chem_offense_preview }
    set_temp_variable = { var = chem_breakthrough_wind_delta value = chem_base_breakthrough_preview }
    multiply_temp_variable = { var = chem_breakthrough_wind_delta value = -1 }
    add_to_temp_variable = { var = chem_breakthrough_wind_delta value = chem_breakthrough_preview }
    set_temp_variable = { var = chem_defense_wind_delta value = chem_base_defense_preview }
    multiply_temp_variable = { var = chem_defense_wind_delta value = -1 }
    add_to_temp_variable = { var = chem_defense_wind_delta value = chem_defense_preview }
    set_temp_variable = { var = chem_org_damage_wind_delta value = chem_base_org_damage_preview }
    multiply_temp_variable = { var = chem_org_damage_wind_delta value = -1 }
    add_to_temp_variable = { var = chem_org_damage_wind_delta value = chem_org_damage_preview }
    set_temp_variable = { var = chem_str_damage_wind_delta value = chem_base_str_damage_preview }
    multiply_temp_variable = { var = chem_str_damage_wind_delta value = -1 }
    add_to_temp_variable = { var = chem_str_damage_wind_delta value = chem_str_damage_preview }
    set_temp_variable = { var = chem_war_support_wind_delta value = chem_base_war_support_preview }
    multiply_temp_variable = { var = chem_war_support_wind_delta value = -1 }
    add_to_temp_variable = { var = chem_war_support_wind_delta value = chem_war_support_preview }
    set_variable = { var = chem_offense_wind_lewisite value = chem_offense_wind_delta }
    set_variable = { var = chem_breakthrough_wind_lewisite value = chem_breakthrough_wind_delta }
    set_variable = { var = chem_defense_wind_lewisite value = chem_defense_wind_delta }
    set_variable = { var = chem_org_damage_wind_lewisite value = chem_org_damage_wind_delta }
    set_variable = { var = chem_str_damage_wind_lewisite value = chem_str_damage_wind_delta }
    set_variable = { var = chem_war_support_wind_lewisite value = chem_war_support_wind_delta }
    FROM = {
        set_variable = { var = chem_offense_wind_lewisite value = chem_offense_wind_delta }
        set_variable = { var = chem_breakthrough_wind_lewisite value = chem_breakthrough_wind_delta }
        set_variable = { var = chem_defense_wind_lewisite value = chem_defense_wind_delta }
        set_variable = { var = chem_org_damage_wind_lewisite value = chem_org_damage_wind_delta }
        set_variable = { var = chem_str_damage_wind_lewisite value = chem_str_damage_wind_delta }
        set_variable = { var = chem_war_support_wind_lewisite value = chem_war_support_wind_delta }
    }
    set_temp_variable = { var = chem_ratio value = chem_ratio_preview }
    chem_prepare_weather_terrain_penalties = yes
    chem_apply_weather_ability_modifiers = yes
    chem_apply_terrain_ability_modifiers = yes
    chem_apply_mask_preview_modifiers = yes
    set_temp_variable = { var = chem_mask_org_display value = chem_mask_org_preview }
    set_temp_variable = { var = chem_mask_str_display value = chem_mask_str_preview }
    set_variable = { var = chem_mask_org_lewisite value = chem_mask_org_display }
    set_variable = { var = chem_mask_str_lewisite value = chem_mask_str_display }
    FROM = {
        set_variable = { var = chem_mask_org_lewisite value = chem_mask_org_display }
        set_variable = { var = chem_mask_str_lewisite value = chem_mask_str_display }
    }
    set_temp_variable = { var = chem_offense_total value = chem_offense_preview }
    add_to_temp_variable = { var = chem_offense_total value = chem_combined_offense }
    set_temp_variable = { var = chem_breakthrough_total value = chem_breakthrough_preview }
    add_to_temp_variable = { var = chem_breakthrough_total value = chem_combined_breakthrough }
    set_temp_variable = { var = chem_defense_total value = chem_defense_preview }
    set_temp_variable = { var = chem_org_damage_total value = chem_org_damage_preview }
    add_to_temp_variable = { var = chem_org_damage_total value = chem_combined_org_damage }
    add_to_temp_variable = { var = chem_org_damage_total value = chem_mask_org_preview }
    set_temp_variable = { var = chem_str_damage_total value = chem_str_damage_preview }
    add_to_temp_variable = { var = chem_str_damage_total value = chem_combined_str_damage }
    add_to_temp_variable = { var = chem_str_damage_total value = chem_mask_str_preview }
    set_temp_variable = { var = chem_war_support_total value = chem_war_support_preview }
    set_variable = { var = chem_available_lewisite value = chem_available }
    set_variable = { var = chem_combined_offense_lewisite value = chem_combined_offense }
    set_variable = { var = chem_combined_breakthrough_lewisite value = chem_combined_breakthrough }
    set_variable = { var = chem_combined_org_damage_lewisite value = chem_combined_org_damage }
    set_variable = { var = chem_combined_str_damage_lewisite value = chem_combined_str_damage }
    set_variable = { var = chem_offense_total_lewisite value = chem_offense_total }
    set_variable = { var = chem_breakthrough_total_lewisite value = chem_breakthrough_total }
    set_variable = { var = chem_defense_total_lewisite value = chem_defense_total }
    set_variable = { var = chem_org_damage_total_lewisite value = chem_org_damage_total }
    set_variable = { var = chem_str_damage_total_lewisite value = chem_str_damage_total }
    set_variable = { var = chem_war_support_total_lewisite value = chem_war_support_total }
    set_variable = { var = chem_unit_speed_lewisite value = @CHEM_UNIT_SPEED_FACTOR }
    set_variable = { var = chem_urban_attack_lewisite value = @CHEM_UNIT_URBAN_ATTACK }
    set_variable = { var = chem_unit_speed_total_lewisite value = @CHEM_UNIT_SPEED_FACTOR }
    set_variable = { var = chem_urban_attack_total_lewisite value = @CHEM_UNIT_URBAN_ATTACK }
    OWNER = {
        set_variable = { var = chem_required_lewisite value = chem_required }
        set_variable = { var = chem_available_lewisite value = chem_available }
        set_variable = { var = chem_ratio_loc_lewisite value = chem_ratio }
        set_variable = { var = chem_combined_offense_lewisite value = chem_combined_offense }
        set_variable = { var = chem_combined_breakthrough_lewisite value = chem_combined_breakthrough }
        set_variable = { var = chem_combined_org_damage_lewisite value = chem_combined_org_damage }
        set_variable = { var = chem_combined_str_damage_lewisite value = chem_combined_str_damage }
        set_variable = { var = chem_offense_total_lewisite value = chem_offense_total }
        set_variable = { var = chem_breakthrough_total_lewisite value = chem_breakthrough_total }
        set_variable = { var = chem_defense_total_lewisite value = chem_defense_total }
        set_variable = { var = chem_org_damage_total_lewisite value = chem_org_damage_total }
        set_variable = { var = chem_str_damage_total_lewisite value = chem_str_damage_total }
        set_variable = { var = chem_war_support_total_lewisite value = chem_war_support_total }
        set_variable = { var = chem_unit_speed_lewisite value = @CHEM_UNIT_SPEED_FACTOR }
        set_variable = { var = chem_urban_attack_lewisite value = @CHEM_UNIT_URBAN_ATTACK }
        set_variable = { var = chem_unit_speed_total_lewisite value = @CHEM_UNIT_SPEED_FACTOR }
        set_variable = { var = chem_urban_attack_total_lewisite value = @CHEM_UNIT_URBAN_ATTACK }
    }
}
