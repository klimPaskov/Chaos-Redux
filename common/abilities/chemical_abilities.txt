# Chemical cylinder unit leader abilities.

@CHEM_ABILITY_COST_CHLORINE = 0.20
@CHEM_ABILITY_COST_PHOSGENE = 0.30
@CHEM_ABILITY_COST_MUSTARD = 0.35
@CHEM_ABILITY_COST_LEWISITE = 0.40

#
# Most tuning values are centralized in:
# `common/script_constants/chemical_warfare_constants.txt` (see `chem_ability_*` and `chem_unit_modifier`).
# NOTE: ability `cost` does not parse script constants in this context,
# so it is mirrored as a file-local `@` constant above.

ability = {
    chemical_chlorine_attack = {
        name = CHEM_ABILITY_CHLORINE_NAME
        desc = CHEM_ABILITY_CHLORINE_DESC
        icon = GFX_ability_chlorine_attack
        sound_effect = chem_attack_chlorine_sound
        type = army_leader

        allowed = {
            is_leading_army_group = no
            is_border_war = no
            custom_trigger_tooltip = {
                tooltip = CHEM_ABILITY_COMMANDER_TRAINING_TT
                has_trait = chemical_operations_commander
            }
            custom_trigger_tooltip = {
                tooltip = CHEM_ABILITY_CHLORINE_TECH_TT
                OWNER = { has_tech = chlorine_gas }
            }
            custom_trigger_tooltip = {
                tooltip = CHEM_ABILITY_ALREADY_ACTIVE_TT
                NOT = {
                    OR = {
                        has_trait = chemical_cylinder_active_chlorine
                        has_trait = chemical_cylinder_active_phosgene
                        has_trait = chemical_cylinder_active_mustard
                        has_trait = chemical_cylinder_active_lewisite
                    }
                }
            }
        }

        cost = @CHEM_ABILITY_COST_CHLORINE

        one_time_effect = {
            add_timed_unit_leader_trait = {
                trait = chemical_cylinder_active_chlorine
                days = constant:chem_ability_core.duration_days
            }
            set_unit_leader_flag = chem_ability_calculating
            set_variable = { var = chem_active_type value = constant:chem_type.chlorine }
            set_temp_variable = { var = chem_condemnation_base value = constant:chem_ability_condemnation_base.chlorine }
            set_temp_variable = { var = chem_condemnation_per_unit value = constant:chem_ability_condemnation_per_unit.chlorine }

            if = {
                limit = { NOT = { has_variable = chem_offense_total_chlorine } }
                chem_update_chlorine_preview = yes
            }
            set_temp_variable = { var = chem_wind_miscalc_happened value = 0 }
            hidden_effect = {
                chem_use_wind_forecast = yes
                chem_apply_wind_miscalculation = yes
            }
            chem_set_final_chlorine_effects = yes
            set_temp_variable = { var = chem_duration_days value = constant:chem_ability_core.duration_days }
            if = {
                limit = { has_unit_leader_flag = chem_ability_calculating }
                hidden_effect = {
                    meta_effect = {
                        text = {
                            add_temporary_buff_to_units = {
                                combat_offense = [CHEM_OFFENSE]
                                combat_breakthrough = [CHEM_BREAKTHROUGH]
                                combat_defense = [CHEM_DEFENSE]
                                org_damage_multiplier = [CHEM_ORG_DAMAGE]
                                str_damage_multiplier = [CHEM_STR_DAMAGE]
                                war_support_reduction_on_damage = [CHEM_WAR_SUPPORT]
                                days = [CHEM_DURATION_DAYS]
                            }
                        }
                        CHEM_OFFENSE = "[?chem_offense]"
                        CHEM_BREAKTHROUGH = "[?chem_breakthrough]"
                        CHEM_DEFENSE = "[?chem_defense]"
                        CHEM_ORG_DAMAGE = "[?chem_org_damage]"
                        CHEM_STR_DAMAGE = "[?chem_str_damage]"
                        CHEM_WAR_SUPPORT = "[?chem_war_support]"
                        CHEM_DURATION_DAYS = "[?chem_duration_days]"
                    }
                }
            }
            set_temp_variable = { var = chem_consumed_amount value = 0 }
            set_temp_variable = { var = chem_required_amount value = 0 }
            hidden_effect = { chem_consume_chlorine_cylinders = yes }
            set_temp_variable = { var = chem_ability_cp_cost value = constant:chem_ability_command_power_cost.chlorine }
            hidden_effect = { chem_refund_chemical_ability_command_power = yes }
            chem_warfare_register_attack_use = yes
            custom_effect_tooltip = CHEM_ABILITY_SECTION_DIVIDER
            custom_effect_tooltip = CHEM_ABILITY_CYLINDER_STOCKPILE_CHLORINE_VALUE
            custom_effect_tooltip = CHEM_ABILITY_CYLINDER_STATUS_CHLORINE
            custom_effect_tooltip = CHEM_ABILITY_CHLORINE_EFFECTS_TT
            custom_effect_tooltip = CHEM_ABILITY_SECTION_DIVIDER
            custom_effect_tooltip = CHEM_ABILITY_GAS_MASK_TT
            custom_effect_tooltip = CHEM_ABILITY_GAS_MASK_EFFECTS_CHLORINE_TT
            custom_effect_tooltip = CHEM_ABILITY_SECTION_DIVIDER
            custom_effect_tooltip = CHEM_ABILITY_WEATHER_TERRAIN_CHLORINE_TT
            custom_effect_tooltip = CHEM_ABILITY_SECTION_DIVIDER
            custom_effect_tooltip = CHEM_ABILITY_WIND_STATUS_TT
            custom_effect_tooltip = CHEM_ABILITY_WIND_TECH_TT
            custom_effect_tooltip = CHEM_ABILITY_CHLORINE_WIND_EFFECTS_TT
            custom_effect_tooltip = CHEM_ABILITY_SECTION_DIVIDER
            custom_effect_tooltip = CHEM_ABILITY_CHLORINE_COMBINED_EFFECTS_TT
            custom_effect_tooltip = CHEM_ABILITY_SECTION_DIVIDER
            custom_effect_tooltip = CHEM_ABILITY_CONDEMNATION_WARNING_TT
            custom_effect_tooltip = CHEM_ABILITY_FINAL_EFFECTS_NOTE_TT
            clr_unit_leader_flag = chem_ability_calculating
        }

        ai_will_do = {
            factor = 0
            modifier = {
                FROM = {
                    has_war = yes
                    command_power > constant:chem_ability_ai.min_command_power.chlorine
                    has_war_support > constant:chem_ability_ai.min_war_support.chlorine
                }
                check_variable = { num_units_offensive_combats > constant:chem_ability_ai.pressure.offensive_low }
                check_variable = { avg_offensive_combat_status > constant:chem_ability_ai.pressure.offensive_status_min }
                add = constant:chem_ability_ai.pressure_add.high
            }
            modifier = {
                check_variable = { num_units_offensive_combats > constant:chem_ability_ai.pressure.offensive_high }
                add = constant:chem_ability_ai.pressure_add.med
            }
            modifier = {
                check_variable = { num_units_defensive_combats > constant:chem_ability_ai.pressure.defensive_low }
                check_variable = { avg_defensive_combat_status < constant:chem_ability_ai.pressure.defensive_status_max }
                add = constant:chem_ability_ai.pressure_add.med
            }
            modifier = {
                OR = {
                    check_variable = { num_units_offensive_combats_against@urban > constant:chem_ability_ai.pressure.terrain_pressure }
                    check_variable = { num_units_offensive_combats_against@forest > constant:chem_ability_ai.pressure.terrain_pressure }
                    check_variable = { num_units_offensive_combats_against@jungle > constant:chem_ability_ai.pressure.terrain_pressure }
                }
                add = constant:chem_ability_ai.terrain_pressure_add.value
            }
            modifier = {
                check_variable = { num_units_on_climate@cold_climate > constant:chem_ability_ai.pressure.climate_pressure }
                add = constant:chem_ability_ai.climate_penalty_add.value
            }
            modifier = {
                check_variable = { num_units_on_climate@hot_climate > constant:chem_ability_ai.pressure.climate_pressure }
                add = constant:chem_ability_ai.climate_penalty_add.value
            }
            modifier = {
                FROM = { has_government = democratic }
                add = constant:chem_ability_ai.ideology_add.democratic
            }
            modifier = {
                FROM = { has_government = fascism }
                add = constant:chem_ability_ai.ideology_add.fascist
            }
            modifier = {
                FROM = { has_government = communism }
                add = constant:chem_ability_ai.ideology_add.communist
            }
            modifier = {
                FROM = { has_government = neutrality }
                add = constant:chem_ability_ai.ideology_add.neutral
            }
            modifier = {
                FROM = { tag = JAP }
                add = constant:chem_ability_ai.country_add.japan
            }
            modifier = {
                check_variable = { var = chem_wind_state value = constant:chem_wind_state.strong_favor compare = greater_than_or_equals }
                add = constant:chem_ability_ai.wind_add.strong_favor
            }
            modifier = {
                check_variable = { var = chem_wind_state value = constant:chem_wind_state.favor compare = greater_than_or_equals }
                NOT = { check_variable = { var = chem_wind_state value = constant:chem_wind_state.strong_favor compare = greater_than_or_equals } }
                add = constant:chem_ability_ai.wind_add.favor
            }
            modifier = {
                check_variable = { var = chem_wind_state value = constant:chem_wind_state.against compare = less_than_or_equals }
                add = constant:chem_ability_ai.wind_add.against
            }
            modifier = {
                FROM = { has_tech = advanced_gas_masks }
                add = constant:chem_ability_ai.gas_mask_add.advanced
            }
            modifier = {
                FROM = { has_tech = improved_gas_masks }
                add = constant:chem_ability_ai.gas_mask_add.improved
            }
            modifier = {
                FROM = { has_tech = basic_gas_masks }
                add = constant:chem_ability_ai.gas_mask_add.basic
            }
            modifier = {
                FROM = {
                    any_enemy_country = {
                        check_variable = { var = chem_warfare_condemnation value = constant:chem_ability_ai.retaliate_threshold.low compare = greater_than }
                    }
                }
                add = constant:chem_ability_ai.retaliate_add.low
            }
            modifier = {
                FROM = {
                    any_enemy_country = {
                        check_variable = { var = chem_warfare_condemnation value = constant:chem_ability_ai.retaliate_threshold.med compare = greater_than }
                    }
                }
                add = constant:chem_ability_ai.retaliate_add.med
            }
            modifier = {
                FROM = {
                    any_enemy_country = {
                        check_variable = { var = chem_warfare_condemnation value = constant:chem_ability_ai.retaliate_threshold.high compare = greater_than }
                    }
                }
                add = constant:chem_ability_ai.retaliate_add.high
            }
        }
    }

    chemical_phosgene_attack = {
        name = CHEM_ABILITY_PHOSGENE_NAME
        desc = CHEM_ABILITY_PHOSGENE_DESC
        icon = GFX_ability_phosgene_attack
        sound_effect = chem_attack_phosgene_sound
        type = army_leader

        allowed = {
            is_leading_army_group = no
            is_border_war = no
            custom_trigger_tooltip = {
                tooltip = CHEM_ABILITY_COMMANDER_TRAINING_TT
                has_trait = chemical_operations_commander
            }
            custom_trigger_tooltip = {
                tooltip = CHEM_ABILITY_PHOSGENE_TECH_TT
                OWNER = { has_tech = phosgene }
            }
            custom_trigger_tooltip = {
                tooltip = CHEM_ABILITY_ALREADY_ACTIVE_TT
                NOT = {
                    OR = {
                        has_trait = chemical_cylinder_active_chlorine
                        has_trait = chemical_cylinder_active_phosgene
                        has_trait = chemical_cylinder_active_mustard
                        has_trait = chemical_cylinder_active_lewisite
                    }
                }
            }
        }

        cost = @CHEM_ABILITY_COST_PHOSGENE

        one_time_effect = {
            add_timed_unit_leader_trait = {
                trait = chemical_cylinder_active_phosgene
                days = constant:chem_ability_core.duration_days
            }
            set_unit_leader_flag = chem_ability_calculating
            set_variable = { var = chem_active_type value = constant:chem_type.phosgene }
            set_temp_variable = { var = chem_condemnation_base value = constant:chem_ability_condemnation_base.phosgene }
            set_temp_variable = { var = chem_condemnation_per_unit value = constant:chem_ability_condemnation_per_unit.phosgene }

            if = {
                limit = { NOT = { has_variable = chem_offense_total_phosgene } }
                chem_update_phosgene_preview = yes
            }
            set_temp_variable = { var = chem_wind_miscalc_happened value = 0 }
            hidden_effect = {
                chem_use_wind_forecast = yes
                chem_apply_wind_miscalculation = yes
            }
            chem_set_final_phosgene_effects = yes
            set_temp_variable = { var = chem_duration_days value = constant:chem_ability_core.duration_days }
            if = {
                limit = { has_unit_leader_flag = chem_ability_calculating }
                hidden_effect = {
                    meta_effect = {
                        text = {
                            add_temporary_buff_to_units = {
                                combat_offense = [CHEM_OFFENSE]
                                combat_breakthrough = [CHEM_BREAKTHROUGH]
                                combat_defense = [CHEM_DEFENSE]
                                org_damage_multiplier = [CHEM_ORG_DAMAGE]
                                str_damage_multiplier = [CHEM_STR_DAMAGE]
                                war_support_reduction_on_damage = [CHEM_WAR_SUPPORT]
                                days = [CHEM_DURATION_DAYS]
                            }
                        }
                        CHEM_OFFENSE = "[?chem_offense]"
                        CHEM_BREAKTHROUGH = "[?chem_breakthrough]"
                        CHEM_DEFENSE = "[?chem_defense]"
                        CHEM_ORG_DAMAGE = "[?chem_org_damage]"
                        CHEM_STR_DAMAGE = "[?chem_str_damage]"
                        CHEM_WAR_SUPPORT = "[?chem_war_support]"
                        CHEM_DURATION_DAYS = "[?chem_duration_days]"
                    }
                }
            }
            set_temp_variable = { var = chem_consumed_amount value = 0 }
            set_temp_variable = { var = chem_required_amount value = 0 }
            hidden_effect = { chem_consume_phosgene_cylinders = yes }
            set_temp_variable = { var = chem_ability_cp_cost value = constant:chem_ability_command_power_cost.phosgene }
            hidden_effect = { chem_refund_chemical_ability_command_power = yes }
            chem_warfare_register_attack_use = yes
            custom_effect_tooltip = CHEM_ABILITY_SECTION_DIVIDER
            custom_effect_tooltip = CHEM_ABILITY_CYLINDER_STOCKPILE_PHOSGENE_VALUE
            custom_effect_tooltip = CHEM_ABILITY_CYLINDER_STATUS_PHOSGENE
            custom_effect_tooltip = CHEM_ABILITY_PHOSGENE_EFFECTS_TT
            custom_effect_tooltip = CHEM_ABILITY_SECTION_DIVIDER
            custom_effect_tooltip = CHEM_ABILITY_GAS_MASK_TT
            custom_effect_tooltip = CHEM_ABILITY_GAS_MASK_EFFECTS_PHOSGENE_TT
            custom_effect_tooltip = CHEM_ABILITY_SECTION_DIVIDER
            custom_effect_tooltip = CHEM_ABILITY_WEATHER_TERRAIN_PHOSGENE_TT
            custom_effect_tooltip = CHEM_ABILITY_SECTION_DIVIDER
            custom_effect_tooltip = CHEM_ABILITY_WIND_STATUS_TT
            custom_effect_tooltip = CHEM_ABILITY_WIND_TECH_TT
            custom_effect_tooltip = CHEM_ABILITY_PHOSGENE_WIND_EFFECTS_TT
            custom_effect_tooltip = CHEM_ABILITY_SECTION_DIVIDER
            custom_effect_tooltip = CHEM_ABILITY_PHOSGENE_COMBINED_EFFECTS_TT
            custom_effect_tooltip = CHEM_ABILITY_SECTION_DIVIDER
            custom_effect_tooltip = CHEM_ABILITY_CONDEMNATION_WARNING_TT
            custom_effect_tooltip = CHEM_ABILITY_FINAL_EFFECTS_NOTE_TT
            clr_unit_leader_flag = chem_ability_calculating
        }

        ai_will_do = {
            factor = 0
            modifier = {
                FROM = {
                    has_war = yes
                    command_power > constant:chem_ability_ai.min_command_power.phosgene
                    has_war_support > constant:chem_ability_ai.min_war_support.phosgene
                }
                check_variable = { num_units_offensive_combats > constant:chem_ability_ai.pressure.offensive_high }
                check_variable = { avg_offensive_combat_status > constant:chem_ability_ai.pressure.offensive_status_min }
                add = constant:chem_ability_ai.pressure_add.high
            }
            modifier = {
                check_variable = { num_units_defensive_combats > constant:chem_ability_ai.pressure.defensive_low }
                check_variable = { avg_defensive_combat_status < constant:chem_ability_ai.pressure.defensive_status_max }
                add = constant:chem_ability_ai.pressure_add.med
            }
            modifier = {
                OR = {
                    check_variable = { num_units_offensive_combats_against@urban > constant:chem_ability_ai.pressure.terrain_pressure }
                    check_variable = { num_units_offensive_combats_against@hills > constant:chem_ability_ai.pressure.terrain_pressure }
                    check_variable = { num_units_offensive_combats_against@mountain > constant:chem_ability_ai.pressure.terrain_pressure }
                }
                add = constant:chem_ability_ai.terrain_pressure_add.value
            }
            modifier = {
                check_variable = { num_units_on_climate@cold_climate > constant:chem_ability_ai.pressure.climate_pressure }
                add = constant:chem_ability_ai.climate_penalty_add.value
            }
            modifier = {
                check_variable = { num_units_on_climate@hot_climate > constant:chem_ability_ai.pressure.climate_pressure }
                add = constant:chem_ability_ai.climate_penalty_add.value
            }
            modifier = {
                FROM = { has_government = democratic }
                add = constant:chem_ability_ai.ideology_add.democratic
            }
            modifier = {
                FROM = { has_government = fascism }
                add = constant:chem_ability_ai.ideology_add.fascist
            }
            modifier = {
                FROM = { has_government = communism }
                add = constant:chem_ability_ai.ideology_add.communist
            }
            modifier = {
                FROM = { has_government = neutrality }
                add = constant:chem_ability_ai.ideology_add.neutral
            }
            modifier = {
                FROM = { tag = JAP }
                add = constant:chem_ability_ai.country_add.japan
            }
            modifier = {
                check_variable = { var = chem_wind_state value = constant:chem_wind_state.strong_favor compare = greater_than_or_equals }
                add = constant:chem_ability_ai.wind_add.strong_favor
            }
            modifier = {
                check_variable = { var = chem_wind_state value = constant:chem_wind_state.favor compare = greater_than_or_equals }
                NOT = { check_variable = { var = chem_wind_state value = constant:chem_wind_state.strong_favor compare = greater_than_or_equals } }
                add = constant:chem_ability_ai.wind_add.favor
            }
            modifier = {
                check_variable = { var = chem_wind_state value = constant:chem_wind_state.against compare = less_than_or_equals }
                add = constant:chem_ability_ai.wind_add.against
            }
            modifier = {
                FROM = { has_tech = advanced_gas_masks }
                add = constant:chem_ability_ai.gas_mask_add.advanced
            }
            modifier = {
                FROM = { has_tech = improved_gas_masks }
                add = constant:chem_ability_ai.gas_mask_add.improved
            }
            modifier = {
                FROM = { has_tech = basic_gas_masks }
                add = constant:chem_ability_ai.gas_mask_add.basic
            }
            modifier = {
                FROM = {
                    any_enemy_country = {
                        check_variable = { var = chem_warfare_condemnation value = constant:chem_ability_ai.retaliate_threshold.low compare = greater_than }
                    }
                }
                add = constant:chem_ability_ai.retaliate_add.low
            }
            modifier = {
                FROM = {
                    any_enemy_country = {
                        check_variable = { var = chem_warfare_condemnation value = constant:chem_ability_ai.retaliate_threshold.med compare = greater_than }
                    }
                }
                add = constant:chem_ability_ai.retaliate_add.med
            }
            modifier = {
                FROM = {
                    any_enemy_country = {
                        check_variable = { var = chem_warfare_condemnation value = constant:chem_ability_ai.retaliate_threshold.high compare = greater_than }
                    }
                }
                add = constant:chem_ability_ai.retaliate_add.high
            }
        }
    }

    chemical_mustard_attack = {
        name = CHEM_ABILITY_MUSTARD_NAME
        desc = CHEM_ABILITY_MUSTARD_DESC
        icon = GFX_ability_mustard_attack
        sound_effect = chem_attack_mustard_sound
        type = army_leader

        allowed = {
            is_leading_army_group = no
            is_border_war = no
            custom_trigger_tooltip = {
                tooltip = CHEM_ABILITY_COMMANDER_TRAINING_TT
                has_trait = chemical_operations_commander
            }
            custom_trigger_tooltip = {
                tooltip = CHEM_ABILITY_MUSTARD_TECH_TT
                OWNER = { has_tech = mustard_gas }
            }
            custom_trigger_tooltip = {
                tooltip = CHEM_ABILITY_ALREADY_ACTIVE_TT
                NOT = {
                    OR = {
                        has_trait = chemical_cylinder_active_chlorine
                        has_trait = chemical_cylinder_active_phosgene
                        has_trait = chemical_cylinder_active_mustard
                        has_trait = chemical_cylinder_active_lewisite
                    }
                }
            }
        }

        cost = @CHEM_ABILITY_COST_MUSTARD

        one_time_effect = {
            add_timed_unit_leader_trait = {
                trait = chemical_cylinder_active_mustard
                days = constant:chem_ability_core.duration_days
            }
            set_unit_leader_flag = chem_ability_calculating
            set_variable = { var = chem_active_type value = constant:chem_type.mustard }
            set_temp_variable = { var = chem_condemnation_base value = constant:chem_ability_condemnation_base.mustard }
            set_temp_variable = { var = chem_condemnation_per_unit value = constant:chem_ability_condemnation_per_unit.mustard }

            if = {
                limit = { NOT = { has_variable = chem_offense_total_mustard } }
                chem_update_mustard_preview = yes
            }
            set_temp_variable = { var = chem_wind_miscalc_happened value = 0 }
            hidden_effect = {
                chem_use_wind_forecast = yes
                chem_apply_wind_miscalculation = yes
            }
            chem_set_final_mustard_effects = yes
            set_temp_variable = { var = chem_duration_days value = constant:chem_ability_core.duration_days }
            if = {
                limit = { has_unit_leader_flag = chem_ability_calculating }
                hidden_effect = {
                    meta_effect = {
                        text = {
                            add_temporary_buff_to_units = {
                                combat_offense = [CHEM_OFFENSE]
                                combat_breakthrough = [CHEM_BREAKTHROUGH]
                                combat_defense = [CHEM_DEFENSE]
                                org_damage_multiplier = [CHEM_ORG_DAMAGE]
                                str_damage_multiplier = [CHEM_STR_DAMAGE]
                                war_support_reduction_on_damage = [CHEM_WAR_SUPPORT]
                                days = [CHEM_DURATION_DAYS]
                            }
                        }
                        CHEM_OFFENSE = "[?chem_offense]"
                        CHEM_BREAKTHROUGH = "[?chem_breakthrough]"
                        CHEM_DEFENSE = "[?chem_defense]"
                        CHEM_ORG_DAMAGE = "[?chem_org_damage]"
                        CHEM_STR_DAMAGE = "[?chem_str_damage]"
                        CHEM_WAR_SUPPORT = "[?chem_war_support]"
                        CHEM_DURATION_DAYS = "[?chem_duration_days]"
                    }
                }
            }
            set_temp_variable = { var = chem_consumed_amount value = 0 }
            set_temp_variable = { var = chem_required_amount value = 0 }
            hidden_effect = { chem_consume_mustard_cylinders = yes }
            set_temp_variable = { var = chem_ability_cp_cost value = constant:chem_ability_command_power_cost.mustard }
            hidden_effect = { chem_refund_chemical_ability_command_power = yes }
            chem_warfare_register_attack_use = yes
            custom_effect_tooltip = CHEM_ABILITY_SECTION_DIVIDER
            custom_effect_tooltip = CHEM_ABILITY_CYLINDER_STOCKPILE_MUSTARD_VALUE
            custom_effect_tooltip = CHEM_ABILITY_CYLINDER_STATUS_MUSTARD
            custom_effect_tooltip = CHEM_ABILITY_MUSTARD_EFFECTS_TT
            custom_effect_tooltip = CHEM_ABILITY_SECTION_DIVIDER
			custom_effect_tooltip = CHEM_ABILITY_GAS_MASK_TT
			custom_effect_tooltip = CHEM_ABILITY_GAS_MASK_EFFECTS_MUSTARD_TT
			if = {
				limit = {
					OWNER = { has_tech = dimercaprol }
				}
				custom_effect_tooltip = CHEM_ABILITY_DIMERCAPROL_BLISTER_TT
			}
			custom_effect_tooltip = CHEM_ABILITY_SECTION_DIVIDER
			custom_effect_tooltip = CHEM_ABILITY_WEATHER_TERRAIN_MUSTARD_TT
            custom_effect_tooltip = CHEM_ABILITY_SECTION_DIVIDER
            custom_effect_tooltip = CHEM_ABILITY_WIND_STATUS_TT
            custom_effect_tooltip = CHEM_ABILITY_WIND_TECH_TT
            custom_effect_tooltip = CHEM_ABILITY_MUSTARD_WIND_EFFECTS_TT
            custom_effect_tooltip = CHEM_ABILITY_SECTION_DIVIDER
            custom_effect_tooltip = CHEM_ABILITY_MUSTARD_COMBINED_EFFECTS_TT
            custom_effect_tooltip = CHEM_ABILITY_SECTION_DIVIDER
            custom_effect_tooltip = CHEM_ABILITY_CONDEMNATION_WARNING_TT
            custom_effect_tooltip = CHEM_ABILITY_FINAL_EFFECTS_NOTE_TT
            clr_unit_leader_flag = chem_ability_calculating
        }

        ai_will_do = {
            factor = 0
            modifier = {
                FROM = {
                    has_war = yes
                    command_power > constant:chem_ability_ai.min_command_power.mustard
                    has_war_support > constant:chem_ability_ai.min_war_support.mustard
                }
                check_variable = { num_units_defensive_combats > constant:chem_ability_ai.pressure.defensive_low }
                check_variable = { avg_defensive_combat_status < constant:chem_ability_ai.pressure.defensive_status_max }
                add = constant:chem_ability_ai.pressure_add.high
            }
            modifier = {
                check_variable = { num_units_offensive_combats > constant:chem_ability_ai.pressure.offensive_low }
                check_variable = { avg_offensive_combat_status > constant:chem_ability_ai.pressure.offensive_status_min }
                add = constant:chem_ability_ai.pressure_add.med
            }
            modifier = {
                OR = {
                    check_variable = { num_units_offensive_combats_against@forest > constant:chem_ability_ai.pressure.terrain_pressure }
                    check_variable = { num_units_offensive_combats_against@jungle > constant:chem_ability_ai.pressure.terrain_pressure }
                    check_variable = { num_units_offensive_combats_against@marsh > constant:chem_ability_ai.pressure.terrain_pressure }
                    check_variable = { num_units_offensive_combats_against@urban > constant:chem_ability_ai.pressure.terrain_pressure }
                }
                add = constant:chem_ability_ai.terrain_pressure_add.value
            }
            modifier = {
                check_variable = { num_units_on_climate@cold_climate > constant:chem_ability_ai.pressure.climate_pressure }
                add = constant:chem_ability_ai.climate_penalty_add.value
            }
            modifier = {
                check_variable = { num_units_on_climate@hot_climate > constant:chem_ability_ai.pressure.climate_pressure }
                add = constant:chem_ability_ai.climate_penalty_add.value
            }
            modifier = {
                FROM = { has_government = democratic }
                add = constant:chem_ability_ai.ideology_add.democratic
            }
            modifier = {
                FROM = { has_government = fascism }
                add = constant:chem_ability_ai.ideology_add.fascist
            }
            modifier = {
                FROM = { has_government = communism }
                add = constant:chem_ability_ai.ideology_add.communist
            }
            modifier = {
                FROM = { has_government = neutrality }
                add = constant:chem_ability_ai.ideology_add.neutral
            }
            modifier = {
                FROM = { tag = JAP }
                add = constant:chem_ability_ai.country_add.japan
            }
            modifier = {
                check_variable = { var = chem_wind_state value = constant:chem_wind_state.strong_favor compare = greater_than_or_equals }
                add = constant:chem_ability_ai.wind_add.strong_favor
            }
            modifier = {
                check_variable = { var = chem_wind_state value = constant:chem_wind_state.favor compare = greater_than_or_equals }
                NOT = { check_variable = { var = chem_wind_state value = constant:chem_wind_state.strong_favor compare = greater_than_or_equals } }
                add = constant:chem_ability_ai.wind_add.favor
            }
            modifier = {
                check_variable = { var = chem_wind_state value = constant:chem_wind_state.against compare = less_than_or_equals }
                add = constant:chem_ability_ai.wind_add.against
            }
            modifier = {
                FROM = { has_tech = advanced_gas_masks }
                add = constant:chem_ability_ai.gas_mask_add.advanced
            }
            modifier = {
                FROM = { has_tech = improved_gas_masks }
                add = constant:chem_ability_ai.gas_mask_add.improved
            }
            modifier = {
                FROM = { has_tech = basic_gas_masks }
                add = constant:chem_ability_ai.gas_mask_add.basic
            }
            modifier = {
                FROM = {
                    any_enemy_country = {
                        check_variable = { var = chem_warfare_condemnation value = constant:chem_ability_ai.retaliate_threshold.low compare = greater_than }
                    }
                }
                add = constant:chem_ability_ai.retaliate_add.low
            }
            modifier = {
                FROM = {
                    any_enemy_country = {
                        check_variable = { var = chem_warfare_condemnation value = constant:chem_ability_ai.retaliate_threshold.med compare = greater_than }
                    }
                }
                add = constant:chem_ability_ai.retaliate_add.med
            }
            modifier = {
                FROM = {
                    any_enemy_country = {
                        check_variable = { var = chem_warfare_condemnation value = constant:chem_ability_ai.retaliate_threshold.high compare = greater_than }
                    }
                }
                add = constant:chem_ability_ai.retaliate_add.high
            }
        }
    }

    chemical_lewisite_attack = {
        name = CHEM_ABILITY_LEWISITE_NAME
        desc = CHEM_ABILITY_LEWISITE_DESC
        icon = GFX_ability_lewisite_attack
        sound_effect = chem_attack_lewisite_sound
        type = army_leader

        allowed = {
            is_leading_army_group = no
            is_border_war = no
            custom_trigger_tooltip = {
                tooltip = CHEM_ABILITY_COMMANDER_TRAINING_TT
                has_trait = chemical_operations_commander
            }
            custom_trigger_tooltip = {
                tooltip = CHEM_ABILITY_LEWISITE_TECH_TT
                OWNER = { has_tech = lewisite }
            }
            custom_trigger_tooltip = {
                tooltip = CHEM_ABILITY_ALREADY_ACTIVE_TT
                NOT = {
                    OR = {
                        has_trait = chemical_cylinder_active_chlorine
                        has_trait = chemical_cylinder_active_phosgene
                        has_trait = chemical_cylinder_active_mustard
                        has_trait = chemical_cylinder_active_lewisite
                    }
                }
            }
        }

        cost = @CHEM_ABILITY_COST_LEWISITE

        one_time_effect = {
            add_timed_unit_leader_trait = {
                trait = chemical_cylinder_active_lewisite
                days = constant:chem_ability_core.duration_days
            }
            set_unit_leader_flag = chem_ability_calculating
            set_variable = { var = chem_active_type value = constant:chem_type.lewisite }
            set_temp_variable = { var = chem_condemnation_base value = constant:chem_ability_condemnation_base.lewisite }
            set_temp_variable = { var = chem_condemnation_per_unit value = constant:chem_ability_condemnation_per_unit.lewisite }

            if = {
                limit = { NOT = { has_variable = chem_offense_total_lewisite } }
                chem_update_lewisite_preview = yes
            }
            set_temp_variable = { var = chem_wind_miscalc_happened value = 0 }
            hidden_effect = {
                chem_use_wind_forecast = yes
                chem_apply_wind_miscalculation = yes
            }
            chem_set_final_lewisite_effects = yes
            set_temp_variable = { var = chem_duration_days value = constant:chem_ability_core.duration_days }
            if = {
                limit = { has_unit_leader_flag = chem_ability_calculating }
                hidden_effect = {
                    meta_effect = {
                        text = {
                            add_temporary_buff_to_units = {
                                combat_offense = [CHEM_OFFENSE]
                                combat_breakthrough = [CHEM_BREAKTHROUGH]
                                combat_defense = [CHEM_DEFENSE]
                                org_damage_multiplier = [CHEM_ORG_DAMAGE]
                                str_damage_multiplier = [CHEM_STR_DAMAGE]
                                war_support_reduction_on_damage = [CHEM_WAR_SUPPORT]
                                days = [CHEM_DURATION_DAYS]
                            }
                        }
                        CHEM_OFFENSE = "[?chem_offense]"
                        CHEM_BREAKTHROUGH = "[?chem_breakthrough]"
                        CHEM_DEFENSE = "[?chem_defense]"
                        CHEM_ORG_DAMAGE = "[?chem_org_damage]"
                        CHEM_STR_DAMAGE = "[?chem_str_damage]"
                        CHEM_WAR_SUPPORT = "[?chem_war_support]"
                        CHEM_DURATION_DAYS = "[?chem_duration_days]"
                    }
                }
            }
            set_temp_variable = { var = chem_consumed_amount value = 0 }
            set_temp_variable = { var = chem_required_amount value = 0 }
            hidden_effect = { chem_consume_lewisite_cylinders = yes }
            set_temp_variable = { var = chem_ability_cp_cost value = constant:chem_ability_command_power_cost.lewisite }
            hidden_effect = { chem_refund_chemical_ability_command_power = yes }
            chem_warfare_register_attack_use = yes
            custom_effect_tooltip = CHEM_ABILITY_SECTION_DIVIDER
            custom_effect_tooltip = CHEM_ABILITY_CYLINDER_STOCKPILE_LEWISITE_VALUE
            custom_effect_tooltip = CHEM_ABILITY_CYLINDER_STATUS_LEWISITE
            custom_effect_tooltip = CHEM_ABILITY_LEWISITE_EFFECTS_TT
            custom_effect_tooltip = CHEM_ABILITY_SECTION_DIVIDER
			custom_effect_tooltip = CHEM_ABILITY_GAS_MASK_TT
			custom_effect_tooltip = CHEM_ABILITY_GAS_MASK_EFFECTS_LEWISITE_TT
			if = {
				limit = {
					OWNER = { has_tech = dimercaprol }
				}
				custom_effect_tooltip = CHEM_ABILITY_DIMERCAPROL_BLISTER_TT
			}
			custom_effect_tooltip = CHEM_ABILITY_SECTION_DIVIDER
			custom_effect_tooltip = CHEM_ABILITY_WEATHER_TERRAIN_LEWISITE_TT
            custom_effect_tooltip = CHEM_ABILITY_SECTION_DIVIDER
            custom_effect_tooltip = CHEM_ABILITY_WIND_STATUS_TT
            custom_effect_tooltip = CHEM_ABILITY_WIND_TECH_TT
            custom_effect_tooltip = CHEM_ABILITY_LEWISITE_WIND_EFFECTS_TT
            custom_effect_tooltip = CHEM_ABILITY_SECTION_DIVIDER
            custom_effect_tooltip = CHEM_ABILITY_LEWISITE_COMBINED_EFFECTS_TT
            custom_effect_tooltip = CHEM_ABILITY_SECTION_DIVIDER
            custom_effect_tooltip = CHEM_ABILITY_CONDEMNATION_WARNING_TT
            custom_effect_tooltip = CHEM_ABILITY_FINAL_EFFECTS_NOTE_TT
            clr_unit_leader_flag = chem_ability_calculating
        }

        ai_will_do = {
            factor = 0
            modifier = {
                FROM = {
                    has_war = yes
                    command_power > constant:chem_ability_ai.min_command_power.lewisite
                    has_war_support > constant:chem_ability_ai.min_war_support.lewisite
                }
                check_variable = { num_units_offensive_combats > constant:chem_ability_ai.pressure.offensive_high }
                check_variable = { avg_offensive_combat_status > constant:chem_ability_ai.pressure.offensive_status_min }
                add = constant:chem_ability_ai.pressure_add.high
            }
            modifier = {
                check_variable = { num_units_defensive_combats > constant:chem_ability_ai.pressure.defensive_low }
                check_variable = { avg_defensive_combat_status < constant:chem_ability_ai.pressure.defensive_status_max }
                add = constant:chem_ability_ai.pressure_add.med
            }
            modifier = {
                OR = {
                    check_variable = { num_units_offensive_combats_against@urban > constant:chem_ability_ai.pressure.terrain_pressure }
                    check_variable = { num_units_offensive_combats_against@hills > constant:chem_ability_ai.pressure.terrain_pressure }
                    check_variable = { num_units_offensive_combats_against@mountain > constant:chem_ability_ai.pressure.terrain_pressure }
                }
                add = constant:chem_ability_ai.terrain_pressure_add.value
            }
            modifier = {
                check_variable = { num_units_on_climate@cold_climate > constant:chem_ability_ai.pressure.climate_pressure }
                add = constant:chem_ability_ai.climate_penalty_add.value
            }
            modifier = {
                check_variable = { num_units_on_climate@hot_climate > constant:chem_ability_ai.pressure.climate_pressure }
                add = constant:chem_ability_ai.climate_penalty_add.value
            }
            modifier = {
                FROM = { has_government = democratic }
                add = constant:chem_ability_ai.ideology_add.democratic
            }
            modifier = {
                FROM = { has_government = fascism }
                add = constant:chem_ability_ai.ideology_add.fascist
            }
            modifier = {
                FROM = { has_government = communism }
                add = constant:chem_ability_ai.ideology_add.communist
            }
            modifier = {
                FROM = { has_government = neutrality }
                add = constant:chem_ability_ai.ideology_add.neutral
            }
            modifier = {
                FROM = { tag = JAP }
                add = constant:chem_ability_ai.country_add.japan
            }
            modifier = {
                check_variable = { var = chem_wind_state value = constant:chem_wind_state.strong_favor compare = greater_than_or_equals }
                add = constant:chem_ability_ai.wind_add.strong_favor
            }
            modifier = {
                check_variable = { var = chem_wind_state value = constant:chem_wind_state.favor compare = greater_than_or_equals }
                NOT = { check_variable = { var = chem_wind_state value = constant:chem_wind_state.strong_favor compare = greater_than_or_equals } }
                add = constant:chem_ability_ai.wind_add.favor
            }
            modifier = {
                check_variable = { var = chem_wind_state value = constant:chem_wind_state.against compare = less_than_or_equals }
                add = constant:chem_ability_ai.wind_add.against
            }
            modifier = {
                FROM = { has_tech = advanced_gas_masks }
                add = constant:chem_ability_ai.gas_mask_add.advanced
            }
            modifier = {
                FROM = { has_tech = improved_gas_masks }
                add = constant:chem_ability_ai.gas_mask_add.improved
            }
            modifier = {
                FROM = { has_tech = basic_gas_masks }
                add = constant:chem_ability_ai.gas_mask_add.basic
            }
            modifier = {
                FROM = {
                    any_enemy_country = {
                        check_variable = { var = chem_warfare_condemnation value = constant:chem_ability_ai.retaliate_threshold.low compare = greater_than }
                    }
                }
                add = constant:chem_ability_ai.retaliate_add.low
            }
            modifier = {
                FROM = {
                    any_enemy_country = {
                        check_variable = { var = chem_warfare_condemnation value = constant:chem_ability_ai.retaliate_threshold.med compare = greater_than }
                    }
                }
                add = constant:chem_ability_ai.retaliate_add.med
            }
            modifier = {
                FROM = {
                    any_enemy_country = {
                        check_variable = { var = chem_warfare_condemnation value = constant:chem_ability_ai.retaliate_threshold.high compare = greater_than }
                    }
                }
                add = constant:chem_ability_ai.retaliate_add.high
            }
        }
    }
}
